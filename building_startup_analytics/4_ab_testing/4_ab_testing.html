
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>4. A/B Testing &#8212; 🧩 Building Startup Analytics</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=aa5847ba" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/custom.js?v=f9582d1e"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'building_startup_analytics/4_ab_testing/4_ab_testing';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="5. Metric Forecasting" href="../5_metric_forecasting/5_metric_forecasting.html" />
    <link rel="prev" title="3. Product Metric Deep Dive" href="../3_metric_deep_dive/3_metric_deep_dive.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo-light.jpg" class="logo__image only-light" alt="🧩 Building Startup Analytics - Home"/>
    <script>document.write(`<img src="../../_static/logo-dark.jpg" class="logo__image only-dark" alt="🧩 Building Startup Analytics - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    🧩 Building Startup Analytics
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../1_data_infrastructure/1_analytical_database.html">1. Building Analytical Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_product_dashboard/2_product_dashboard.html">2. Product Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_metric_deep_dive/3_metric_deep_dive.html">3. Product Metric Deep Dive</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">4. A/B Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5_metric_forecasting/5_metric_forecasting.html">5. Metric Forecasting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6_automated_reporting/6_automated_reporting.html">6. Automated Daily Reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../7_anomaly_detection/7_alert_system.html">7. Alert System</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/PavelGrigoryevDS/building-startup-analytics" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/building_startup_analytics/4_ab_testing/4_ab_testing.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>4. A/B Testing</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> On this page </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-libraries">4.1 Loading Libraries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#experimental-design">4.2 Experimental Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-description">4.3 Data Description</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions">4.4 Helper Functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sample-size-determination">4.5 Sample Size Determination</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#group-size-for-hypothesis-1">4.5.1 Group Size for Hypothesis 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#group-size-for-hypothesis-2">4.5.2 Group Size for Hypothesis 2</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-of-a-a-test-results">4.6 Analysis of A/A Test Results</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hypothesis-1">4.6.1 Hypothesis 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hypothesis-2">4.6.2 Hypothesis 2</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-of-a-b-test-results-for-hypothesis-1">4.7 Analysis of A/B Test Results for Hypothesis 1</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-loading">4.7.1 Data Loading</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-exploration">4.7.2 Data Exploration</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-the-correctness-of-the-splitting">4.7.2.1 Checking the Correctness of the Splitting</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#user-distribution">4.7.2.2 User Distribution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#distribution-of-post-count">4.7.2.3 Distribution of Post Count</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#distribution-of-likes-count">4.7.2.4 Distribution of Likes Count</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#distribution-of-views">4.7.2.5 Distribution of Views</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#distribution-of-ctr">4.7.2.6 Distribution of CTR</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#daily-dynamics">4.7.2.7 Daily Dynamics</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ctr-distribution-by-day">4.7.2.8 CTR Distribution by Day</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#likes-and-views-segmentation">4.7.2.9 Likes and Views Segmentation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#metric-interactions">4.7.2.10 Metric Interactions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#statistical-analysis">4.7.3 Statistical Analysis</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-of-a-b-test-results-for-hypothesis-2">4.8 Analysis of A/B Test Results for Hypothesis 2</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">4.8.1 Data Loading</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">4.8.2 Data Exploration</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">4.8.2.1 Checking the Correctness of the Splitting</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">4.8.2.2 User Distribution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">4.8.2.3 Distribution of Post Count</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">4.8.2.4 Distribution of Likes Count</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">4.8.2.5 Distribution of Views</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">4.8.2.6 Distribution of CTR</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">4.8.2.7 CTR Distribution by Day</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">4.8.2.8 Metric Interactions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">4.8.3 Statistical Analysis</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">4.9 Conclusion</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decision-on-rolling-out-the-new-algorithm-to-all-users">4.9.1 Decision on Rolling Out the New Algorithm to All Users</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hypothesis-1-similar-to-liked-posts-algorithm">Hypothesis 1: “Similar to Liked Posts” Algorithm</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hypothesis-2-posts-liked-by-similar-users-algorithm">Hypothesis 2: “Posts Liked by Similar Users” Algorithm</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#detailed-a-b-test-results">4.9.2 Detailed A/B Test Results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#technical-issues-in-hypothesis-1">Technical Issues in Hypothesis 1</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#valid-results-in-hypothesis-2">Valid Results in Hypothesis 2</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recommendations">4.10 Recommendations</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#for-hypothesis-1">For Hypothesis 1:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#for-hypothesis-2">For Hypothesis 2:</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#supplement-1-additional-tests">4.11 Supplement 1. Additional Tests</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#variance-equality-test">Variance Equality Test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#t-test">T-test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#t-test-on-smoothed-ctr">T-test on Smoothed CTR</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mann-whitney-test">Mann-Whitney Test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrap-on-user-level-ctr">Bootstrap on User-Level CTR</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrap-of-global-ctr">Bootstrap of Global CTR</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#poisson-bootstrap">Poisson Bootstrap</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#delta-method">Delta Method</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#t-test-on-bucket-transformed-data">T-test on Bucket-Transformed Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mann-whitney-on-bucket-transformed-data">Mann-Whitney on Bucket-Transformed Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#t-test-on-linearized-metric">T-test on Linearized Metric</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#permutation-test">Permutation Test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#post-stratification">Post-stratification</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#t-test-with-cuped-transformed-metric">T-test with CUPED Transformed Metric</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="a-b-testing">
<h1>4. A/B Testing<a class="headerlink" href="#a-b-testing" title="Link to this heading">#</a></h1>
<p><strong>Context:</strong></p>
<ul class="simple">
<li><p>The ML team has developed new algorithms for news feed recommendations.</p></li>
<li><p>It is expected that these new algorithms will make users happier and the product more convenient/pleasant to use.</p></li>
<li><p>This needs to be verified.</p></li>
<li><p>The ML team told us: “The recommendations make posts more interesting.”</p></li>
</ul>
<p><strong>Algorithms Under Test:</strong></p>
<ol class="arabic simple">
<li><p><strong>Similar to Liked Posts</strong>: Shows users posts most similar to those they’ve liked</p></li>
<li><p><strong>Similar User Preferences</strong>: Shows users posts that similar users have liked</p></li>
</ol>
<p><strong>Objectives:</strong></p>
<ul class="simple">
<li><p>To design and execute a complete A/B testing pipeline that validates whether the new recommendation algorithms increase user engagement.</p></li>
<li><p>To provide data-driven recommendations on rolling out the algorithms to all users.</p></li>
</ul>
<p><strong>Data Sources:</strong></p>
<p>The data is located in the ClickHouse table <code class="docutils literal notranslate"><span class="pre">feed_actions</span></code>.</p>
<p><strong>Key Findings:</strong></p>
<p>Hypothesis 1 (“Similar to Liked Posts”):</p>
<ul class="simple">
<li><p><strong>The new algorithm should not be rolled out to all users.</strong></p></li>
<li><p>The analysis revealed anomalies (bimodality) in the test group, indicating a high probability of technical problems during the experiment.</p></li>
<li><p>The main argument is that bimodality was present for the first 6 days but disappeared on the last day.</p></li>
<li><p>If the impact on the test group was consistent for all 7 days, this could not have happened. This is a clear signal of technical issues.</p></li>
</ul>
<p>Hypothesis 2 (“Posts Liked by Similar Users”):</p>
<ul class="simple">
<li><p><strong>Limited rollout recommended</strong></p></li>
<li><p>Statistically significant CTR improvement observed (+0.0164)</p></li>
<li><p>No distribution anomalies detected - results are reliable</p></li>
<li><p>Clean data quality with consistent patterns across all test days</p></li>
</ul>
<p><strong>Key Recommendations:</strong></p>
<p>For Hypothesis 1:</p>
<ul class="simple">
<li><p>Investigate the causes of bimodality in the test group.</p>
<ul>
<li><p>It strongly resembles technical problems, given the presence of two modes around 10% and 30%.</p></li>
<li><p>Meanwhile, the historical CTR is around 20%.</p></li>
<li><p>This is a large deviation that is unlikely to occur under normal conditions.</p></li>
</ul>
</li>
<li><p>Take into account that bimodality was absent on the last test day. This might help in identifying the problem.</p></li>
</ul>
<p>For Hypothesis 2:</p>
<ul class="simple">
<li><p>Gradually roll out the “Posts Liked by Similar Users” algorithm to increasingly larger audience segments</p></li>
<li><p>Maintain close monitoring of key metrics and user behavior throughout the rollout process</p></li>
</ul>
<p><strong>Business Impact:</strong></p>
<ul class="simple">
<li><p>Enabled data-driven feature rollout decisions, preventing potential negative user experience and identifying opportunities for engagement improvement.</p></li>
</ul>
<section id="loading-libraries">
<h2>4.1 Loading Libraries<a class="headerlink" href="#loading-libraries" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.stats.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">stm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pingouin</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pg</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.subplots</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">textwrap</span><span class="w"> </span><span class="kn">import</span> <span class="n">dedent</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../assets&#39;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly_config</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">sql_config</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="o">%</span><span class="k">load_ext</span> sql
<span class="o">%</span><span class="k">sql</span> $sql_config.connection_string
<span class="o">%</span><span class="k">config</span> SqlMagic.displaycon = False
<span class="o">%</span><span class="k">config</span> SqlMagic.feedback = False
<span class="o">%</span><span class="k">config</span> SqlMagic.autopandas = True
</pre></div>
</div>
</div>
</div>
</section>
<section id="experimental-design">
<h2>4.2 Experimental Design<a class="headerlink" href="#experimental-design" title="Link to this heading">#</a></h2>
<p>Two new recommendation algorithms were developed:</p>
<ol class="arabic simple">
<li><p>Show the user posts that are most similar to those they liked.</p></li>
<li><p>Show the user posts that were liked by users similar to them.</p></li>
</ol>
<p>Let’s formulate the hypotheses.</p>
<p>A well-formulated hypothesis should answer three questions:</p>
<ul class="simple">
<li><p>What are we changing?</p></li>
<li><p>What will it affect?</p></li>
<li><p>How do we measure it?</p></li>
</ul>
<p>We need to determine how we will measure the effect.</p>
<p>We need to come up with a metric whose increase would indicate that the posts have truly become more interesting. What could this be (options):</p>
<ul class="simple">
<li><p>Time spent in the feed</p></li>
<li><p>Number of posts viewed per unit of time</p></li>
<li><p>Number of likes</p></li>
<li><p>CTR from views to likes</p></li>
</ul>
<p>We choose CTR because:</p>
<ul class="simple">
<li><p>There is a clear action that shows interest – the like</p></li>
<li><p>It’s a fairly standard metric (everyone does it and we’re following suit)</p></li>
</ul>
<p>Okay, we’ve fixed the metric.</p>
<p><strong>Now let’s formulate the hypotheses:</strong></p>
<ol class="arabic simple">
<li><p>If we implement the “posts similar to liked” recommendation algorithm, then user engagement will increase, resulting in higher CTR.</p></li>
<li><p>If we implement the “posts liked by similar users” recommendation algorithm, then user engagement will increase, resulting in higher CTR.</p></li>
</ol>
<p>For the experiment results to be as accurate as possible, it’s desirable to choose the statistical test before calculating group sizes.</p>
<p>Since we will use the Monte Carlo method, we need to use the same test that we will use for the final testing.</p>
<p>Let’s look at the historical distribution of CTR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> df &lt;&lt;
SELECT 
    user_id
    , countIf(action = &#39;like&#39;) as likes
    , countIf(action = &#39;view&#39;) as views
    , ifNull(likes / nullIf(views, 0), 0) as ctr
FROM
    feed_actions
WHERE 
    toDate(time) &lt; &#39;2025-07-26&#39;
GROUP BY
    user_id
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Returning data to local variable df
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ctr&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CTR Distribution&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2a966a7225c555b40f4b34c605c58fb09c4be75c21d31dcd98028da29642adac.png" src="../../_images/2a966a7225c555b40f4b34c605c58fb09c4be75c21d31dcd98028da29642adac.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>The distribution shows no obvious anomalies. There is slight asymmetry, but nothing critical for T-test is observed.</p></li>
</ul>
<p><strong>Which statistical test do we choose for hypothesis testing?</strong></p>
<ul class="simple">
<li><p>Since the CTR distribution shows no strong asymmetry and is unimodal, T-test would be an appropriate choice.</p></li>
<li><p>Since we want to compare groups, it’s better not to use user-level CTR, but global CTR.</p></li>
<li><p>To account for global CTR, we will use a linearized metric for group comparison.</p></li>
<li><p>Therefore, we choose T-test on the linearized metric.</p></li>
</ul>
<p><strong>What significance level do we choose?</strong></p>
<ul class="simple">
<li><p>We choose a significance level of 0.05</p></li>
</ul>
<p><strong>What minimum effect do we want to detect?</strong></p>
<ul class="simple">
<li><p>We define MDE as a 0.01 percentage point change in CTR.</p></li>
</ul>
<p><strong>What power do we want to have?</strong></p>
<ul class="simple">
<li><p>We need power above 0.8</p></li>
<li><p>Ideally more than 0.9, if the number of users is sufficient for such power.</p></li>
</ul>
<p>Now we need to split users into groups.
What we expect from group splitting:</p>
<p>We want:</p>
<ul class="simple">
<li><p>splitting to be random</p></li>
<li><p>each user’s group not to change during the experiment</p></li>
<li><p>the splitting method to be deterministic (so that if needed, the splitting can be exactly reproduced)</p></li>
</ul>
<p><strong>How will we divide users into groups?</strong></p>
<ul class="simple">
<li><p>Users in the table already have a group label.</p></li>
<li><p>Users were divided into groups using hashing with salt</p></li>
<li><p>The first hypothesis has groups:</p>
<ul>
<li><p>exp_group = 1 - Everything as before</p></li>
<li><p>exp_group = 2 - “Similar to liked posts” recommendations</p></li>
</ul>
</li>
<li><p>The second hypothesis has groups:</p>
<ul>
<li><p>exp_group = 0 - Everything as before</p></li>
<li><p>exp_group = 3 - “Posts liked by similar users” recommendations</p></li>
</ul>
</li>
</ul>
<p>Example of hashing with salt.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">ab_split</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="s1">&#39;exp_mess_1&#39;</span><span class="p">,</span> <span class="n">n_groups</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">test_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">salt</span><span class="p">)</span>
    <span class="n">test_id_digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">test_id</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="n">test_id_final_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">test_id_digest</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">test_id_final_int</span> <span class="o">%</span> <span class="n">n_groups</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ab_split</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>likes</th>
      <th>views</th>
      <th>ctr</th>
      <th>group</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>13289</td>
      <td>17</td>
      <td>105</td>
      <td>0.16</td>
      <td>3</td>
    </tr>
    <tr>
      <th>1</th>
      <td>121096</td>
      <td>10</td>
      <td>63</td>
      <td>0.16</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5090</td>
      <td>15</td>
      <td>93</td>
      <td>0.16</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4394</td>
      <td>105</td>
      <td>270</td>
      <td>0.39</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>12577</td>
      <td>23</td>
      <td>84</td>
      <td>0.27</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>group
1    9284
2    9123
0    9022
3    8947
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-description">
<h2>4.3 Data Description<a class="headerlink" href="#data-description" title="Link to this heading">#</a></h2>
<p>The data is located in the ClickHouse table <code class="docutils literal notranslate"><span class="pre">feed_actions</span></code>.</p>
<p>Table feed_actions</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Field</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>user_id</p></td>
<td><p>User ID</p></td>
</tr>
<tr class="row-odd"><td><p>post_id</p></td>
<td><p>Post ID</p></td>
</tr>
<tr class="row-even"><td><p>action</p></td>
<td><p>Action: view or like</p></td>
</tr>
<tr class="row-odd"><td><p>time</p></td>
<td><p>Timestamp</p></td>
</tr>
<tr class="row-even"><td><p>gender</p></td>
<td><p>User’s gender</p></td>
</tr>
<tr class="row-odd"><td><p>age</p></td>
<td><p>User’s age (1 = Female)</p></td>
</tr>
<tr class="row-even"><td><p>country</p></td>
<td><p>User’s country</p></td>
</tr>
<tr class="row-odd"><td><p>city</p></td>
<td><p>User’s city</p></td>
</tr>
<tr class="row-even"><td><p>os</p></td>
<td><p>User’s OS</p></td>
</tr>
<tr class="row-odd"><td><p>source</p></td>
<td><p>Traffic source</p></td>
</tr>
<tr class="row-even"><td><p>exp_group</p></td>
<td><p>A/B test group</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="helper-functions">
<h2>4.4 Helper Functions<a class="headerlink" href="#helper-functions" title="Link to this heading">#</a></h2>
<p>We will create a function that outputs the necessary information about the DataFrame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">info</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Full duplicates: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;Dupl&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;Miss&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">display</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;Zeros&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">display</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;Negs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Create a function for smoothing CTR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">apply_smoothed_ctr</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">global_ctr</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">global_ctr</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Create a function that will:</p>
<ul class="simple">
<li><p>display distributions in groups</p></li>
<li><p>check the correctness of splitting</p></li>
<li><p>use the chi-square test to check group equality by number of users</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">check_split_correctness</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check the correctness of user splitting into test and control groups.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame with columns &#39;user_id&#39; and &#39;group&#39;</span>
<span class="sd">    alpha : float, default=0.05</span>
<span class="sd">        Significance level for statistical tests</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== SPLITTING CORRECTNESS CHECK ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check 1: User uniqueness</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1. USER UNIQUENESS CHECK:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking that there are no users present in both groups simultaneously.&quot;</span><span class="p">)</span>
    
    <span class="n">users_in_both_groups</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">users_in_both_groups</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ SUCCESS: No users found in both groups simultaneously.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Number of users in both groups: </span><span class="si">{</span><span class="n">users_in_both_groups</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ ERROR: Users found in both groups!&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Number of such users: </span><span class="si">{</span><span class="n">users_in_both_groups</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   This indicates a problem in the splitting system.&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check 2: Group balance</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2. GROUP SIZE BALANCE CHECK:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    - H0: The number of users in test and control groups is equal</span>
<span class="s2">    - H1: The number of users in test and control groups is not equal</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We choose a significance level of </span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;We use the chi-square goodness-of-fit test.&#39;</span><span class="p">)</span>
    
    <span class="n">users_by_group</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">total_users</span> <span class="o">=</span> <span class="n">users_by_group</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">expected_counts</span> <span class="o">=</span> <span class="p">[</span><span class="n">total_users</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">total_users</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Expected equal distribution</span>
    
    <span class="c1"># Perform chi-square test</span>
    <span class="n">chi2_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chisquare</span><span class="p">(</span><span class="n">users_by_group</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">f_exp</span><span class="o">=</span><span class="n">expected_counts</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Observed counts: </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="n">users_by_group</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected counts (equal distribution): </span><span class="si">{</span><span class="n">expected_counts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chi-square statistic: </span><span class="si">{</span><span class="n">chi2_stat</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;P-value: </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Calculate percentage difference</span>
    <span class="n">group_names</span> <span class="o">=</span> <span class="n">users_by_group</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">count_a</span><span class="p">,</span> <span class="n">count_b</span> <span class="o">=</span> <span class="n">users_by_group</span><span class="o">.</span><span class="n">values</span>
    <span class="n">percent_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">count_a</span> <span class="o">-</span> <span class="n">count_b</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_users</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Percentage difference: </span><span class="si">{</span><span class="n">percent_diff</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;❌ REJECT H0: The number of users in test and control groups is NOT equal.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   This may indicate splitting system issues.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;✅ FAIL TO REJECT H0: The number of users in test and control groups is equal.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   Group sizes are balanced statistically.&#39;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SUMMARY:&quot;</span><span class="p">)</span>
    
    <span class="c1"># Overall assessment</span>
    <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">users_in_both_groups</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">users_in_both_groups</span><span class="si">}</span><span class="s2"> users in both groups&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">:</span>
        <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Significant group size imbalance (p=</span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">percent_diff</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># More than 5% difference</span>
        <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Large percentage difference: </span><span class="si">{</span><span class="n">percent_diff</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">issues</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ ALL CHECKS PASSED: Splitting system appears to be working correctly.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ ISSUES FOUND:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">issues</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">issue</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recommendation: Investigate the splitting mechanism.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Create a function for calculating power using the Monte Carlo method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">monte_carlo_power</span><span class="p">(</span><span class="n">data_a</span><span class="p">,</span> <span class="n">data_b</span><span class="p">,</span> <span class="n">test_func</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">n_sim</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span> 
                     <span class="n">effect_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Universal power estimation using Monte Carlo method</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    data_a : array-like</span>
<span class="sd">        Data for group A (baseline)</span>
<span class="sd">    data_b : array-like</span>
<span class="sd">        Data for group B (with or without effect)</span>
<span class="sd">    test_func : function</span>
<span class="sd">        Statistical test function (should return p-value)</span>
<span class="sd">    alpha : float</span>
<span class="sd">        Significance level</span>
<span class="sd">    n_sim : int</span>
<span class="sd">        Number of simulations</span>
<span class="sd">    effect_size : float or None</span>
<span class="sd">        Effect size to add (if None, observed effect is used)</span>
<span class="sd">    random_seed : int</span>
<span class="sd">        Seed for reproducibility</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    power : float</span>
<span class="sd">        Power estimate</span>
<span class="sd">    results : dict</span>
<span class="sd">        Detailed results dictionary</span>
<span class="sd">    effect_sizes : array</span>
<span class="sd">        Distribution of effect sizes</span>
<span class="sd">    p_values : array</span>
<span class="sd">        Distribution of p-values     </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">random_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
    
    <span class="n">n_a</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_a</span><span class="p">)</span>
    <span class="n">n_b</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_b</span><span class="p">)</span>
    
    <span class="c1"># Observed effect (if not explicitly specified)</span>
    <span class="k">if</span> <span class="n">effect_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">effect_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_b</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_a</span><span class="p">)</span>
    
    <span class="n">rejects</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">effect_sizes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">p_values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_sim</span><span class="p">)):</span>
        <span class="c1"># Bootstrap original data</span>
        <span class="n">boot_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">data_a</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_a</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">boot_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">data_b</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_b</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Add effect to group B (in linearized units)</span>
        <span class="k">if</span> <span class="n">effect_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">boot_b</span> <span class="o">=</span> <span class="n">boot_b</span> <span class="o">+</span> <span class="n">effect_size</span>
        
        <span class="c1"># Apply the same test used for decision making</span>
        <span class="n">pval</span> <span class="o">=</span> <span class="n">test_func</span><span class="p">(</span><span class="n">boot_a</span><span class="p">,</span> <span class="n">boot_b</span><span class="p">)</span>
        
        <span class="c1"># Collect statistics</span>
        <span class="n">current_effect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">boot_b</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">boot_a</span><span class="p">)</span>
        <span class="n">effect_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_effect</span><span class="p">)</span>
        <span class="n">p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pval</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">pval</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">:</span>
            <span class="n">rejects</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="n">power</span> <span class="o">=</span> <span class="n">rejects</span> <span class="o">/</span> <span class="n">n_sim</span>
    
    <span class="c1"># Additional information</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="n">power</span><span class="p">,</span>
        <span class="s1">&#39;effect_size&#39;</span><span class="p">:</span> <span class="n">effect_size</span><span class="p">,</span>
        <span class="s1">&#39;mean_effect&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">),</span>
        <span class="s1">&#39;effect_std&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">effect_sizes</span><span class="p">),</span>
        <span class="s1">&#39;mean_pvalue&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p_values</span><span class="p">),</span>
        <span class="s1">&#39;n_sim&#39;</span><span class="p">:</span> <span class="n">n_sim</span><span class="p">,</span>
        <span class="s1">&#39;sample_size_a&#39;</span><span class="p">:</span> <span class="n">n_a</span><span class="p">,</span>
        <span class="s1">&#39;sample_size_b&#39;</span><span class="p">:</span> <span class="n">n_b</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">power</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">p_values</span>
</pre></div>
</div>
</div>
</div>
<p>Create a function for T-test to pass to the power calculation function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">pg_ttest</span><span class="p">(</span>
    <span class="n">data_a</span>
    <span class="p">,</span> <span class="n">data_b</span>
    <span class="p">):</span>
    <span class="k">return</span> <span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span><span class="n">data_a</span><span class="p">,</span> <span class="n">data_b</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;p-val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s create a function that displays the ECDF of the p-values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_pvalue_ecdf</span><span class="p">(</span><span class="n">pvalues</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;P-value Distribution and ECDF&#39;</span><span class="p">,</span> <span class="n">subplot_titles</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot ECDF and histogram of p-values for uniformity assessment.</span>
<span class="sd">    </span>
<span class="sd">    This function creates a two-panel plot showing:</span>
<span class="sd">    - Left: Histogram of p-values (should be uniform under null hypothesis)</span>
<span class="sd">    - Right: Empirical CDF of p-values (should follow diagonal line under null)</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    pvalues : array-like</span>
<span class="sd">        Array of p-values from statistical tests</span>
<span class="sd">    title : str, optional</span>
<span class="sd">        Main title for the entire plot</span>
<span class="sd">    subplot_titles : list, optional</span>
<span class="sd">        Titles for individual subplots [left_title, right_title]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create subplots with 1 row and 2 columns</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">subplot_titles</span><span class="o">=</span><span class="n">subplot_titles</span><span class="p">)</span>
    
    <span class="c1"># Left panel: Histogram of p-values</span>
    <span class="c1"># Under null hypothesis, p-values should be uniformly distributed</span>
    <span class="n">hist</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">pvalues</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability density&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_traces</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Right panel: Empirical CDF of p-values  </span>
    <span class="c1"># Under null hypothesis, ECDF should follow the diagonal line</span>
    <span class="n">ecdf</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">ecdf</span><span class="p">(</span><span class="n">pvalues</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_traces</span><span class="p">(</span><span class="n">ecdf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># Add reference lines for visual comparison</span>
    
    <span class="c1"># Left panel: Horizontal line at y=1 (expected uniform density)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_shape</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;line&quot;</span><span class="p">,</span>
        <span class="n">x0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">x1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">dash</span><span class="o">=</span><span class="s2">&quot;dash&quot;</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>    
    
    <span class="c1"># Right panel: Diagonal line from (0,0) to (1,1) (expected ECDF under null)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_shape</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;line&quot;</span><span class="p">,</span>
        <span class="n">x0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">x1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">dash</span><span class="o">=</span><span class="s2">&quot;dash&quot;</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    
    <span class="c1"># Configure axes labels</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s1">&#39;p-value&#39;</span><span class="p">,</span> <span class="n">title_standoff</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s1">&#39;Density&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s1">&#39;Probability&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">title_standoff</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>    
    
    <span class="c1"># Final layout adjustments</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span>
</pre></div>
</div>
</div>
</div>
<p>Create a function for t-test on the linearized metric.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">ttest_linearized</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform t-test on linearized metric with automatic variance check and correction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Use global CTR from the control group as reference</span>
    <span class="n">global_ctr</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="c1"># For each user, create a linearized metric by subtracting expected from actual</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;linearized_likes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">global_ctr</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Linearized metric created using global CTR from control group&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Global CTR: </span><span class="si">{</span><span class="n">global_ctr</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df_control</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">]</span>
    <span class="n">df_test</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span>
    <span class="n">observed_diff</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">df_control</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">df_control</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Difference in Global CTR (test - control): </span><span class="si">{</span><span class="n">observed_diff</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Examine the distribution</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="s1">&#39;linearized_likes&#39;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span>
        <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Linearized Likes Distribution by Group&#39;</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># Formulate hypotheses</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Formulate hypotheses:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- H0: Mean value of the linearized metric in control and test groups are equal&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- H1: Mean value of the linearized metric in control and test groups are not equal&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    
    <span class="c1"># Set significance level</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significance level: </span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    
    <span class="c1"># Check variance homogeneity</span>
    <span class="n">homoscedasticity_test</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">homoscedasticity</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dv</span><span class="o">=</span><span class="s1">&#39;linearized_likes&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Variance homogeneity test (Levene&#39;s test):&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">homoscedasticity_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    
    <span class="n">equal_var</span> <span class="o">=</span> <span class="n">homoscedasticity_test</span><span class="p">[</span><span class="s1">&#39;pval&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">alpha</span>
    
    <span class="k">if</span> <span class="n">equal_var</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Variances are equal (p-value ≥ 0.05) - using standard t-test without correction&quot;</span><span class="p">)</span>
        <span class="n">correction</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Variances are not equal (p-value &lt; 0.05) - using Welch&#39;s t-test with correction&quot;</span><span class="p">)</span>
        <span class="n">correction</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="nb">print</span><span class="p">()</span>
    
    <span class="c1"># Extract data for groups</span>
    <span class="n">linearized_likes_control</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">linearized_likes</span>
    <span class="n">linearized_likes_test</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">linearized_likes</span>
    
    <span class="c1"># Examine the difference in mean values</span>
    <span class="n">mean_diff</span> <span class="o">=</span> <span class="n">linearized_likes_test</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">linearized_likes_control</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Difference in means (test - control): </span><span class="si">{</span><span class="n">mean_diff</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    
    <span class="c1"># Perform t-test</span>
    <span class="n">ttest_result</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span><span class="n">linearized_likes_test</span><span class="p">,</span> <span class="n">linearized_likes_control</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="n">correction</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T-test results:&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">ttest_result</span><span class="p">)</span>
    
    <span class="n">p_value</span> <span class="o">=</span> <span class="n">ttest_result</span><span class="p">[</span><span class="s1">&#39;p-val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Conclusion:&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;REJECT H0: p-value (</span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2"> - Significant difference detected&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FAIL TO REJECT H0: p-value (</span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">) ≥ </span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2"> - No significant difference&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="sample-size-determination">
<h2>4.5 Sample Size Determination<a class="headerlink" href="#sample-size-determination" title="Link to this heading">#</a></h2>
<p>Now we need to conduct an A/A test.</p>
<p>We need to determine the sample size for the A/A test.</p>
<p>We will determine the sample size using the Monte Carlo method based on historical data.</p>
<section id="group-size-for-hypothesis-1">
<h3>4.5.1 Group Size for Hypothesis 1<a class="headerlink" href="#group-size-for-hypothesis-1" title="Link to this heading">#</a></h3>
<p>We plan to run the experiment for 1 week, so we’ll take:</p>
<p>It’s important not only to determine the sample size in advance, but also preferable that the test period be fixed and the same for both the A/A test and the A/B test.</p>
<p>Therefore, we’ll take historical data from the week before the start of the A/A test.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> df &lt;&lt;
SELECT 
    multiIf(
        exp_group = 1, &#39;control&#39;
        , exp_group = 2, &#39;test&#39;
        , &#39;unknown&#39;
    ) as group
    , user_id
    , countIf(action = &#39;like&#39;) as likes
    , countIf(action = &#39;view&#39;) as views
    , ifNull(likes / nullIf(views, 0), 0) as ctr
FROM
    feed_actions
WHERE 
    toDate(time) BETWEEN &#39;2025-07-19&#39; and &#39;2025-07-25&#39;
    and exp_group in (1, 2)
GROUP BY
    group
    , user_id
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Returning data to local variable df
</pre></div>
</div>
</div>
</div>
<p>Check the correctness of splitting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">check_split_correctness</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== SPLITTING CORRECTNESS CHECK ===

1. USER UNIQUENESS CHECK:
Checking that there are no users present in both groups simultaneously.
✅ SUCCESS: No users found in both groups simultaneously.
   Number of users in both groups: 0

==================================================

2. GROUP SIZE BALANCE CHECK:

- H0: The number of users in test and control groups is equal
- H1: The number of users in test and control groups is not equal

We choose a significance level of 0.05.
We use the chi-square goodness-of-fit test.
Observed counts: {&#39;control&#39;: np.int64(6548), &#39;test&#39;: np.int64(6545)}
Expected counts (equal distribution): [np.float64(6546.5), np.float64(6546.5)]
Chi-square statistic: 0.0007
P-value: 0.9791
Percentage difference: 0.02%
✅ FAIL TO REJECT H0: The number of users in test and control groups is equal.
   Group sizes are balanced statistically.

==================================================
SUMMARY:
✅ ALL CHECKS PASSED: Splitting system appears to be working correctly.
</pre></div>
</div>
</div>
</div>
<p>Check if the number of users who came during the week before the A/A test is sufficient for us.</p>
<p>Calculate linearized metrics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_linearized</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="s1">&#39;likes&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">global_ctr</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
    <span class="o">/</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;linearized_likes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">global_ctr</span>
<span class="n">linearized_likes_control</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">linearized_likes</span>
<span class="n">linearized_likes_test</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">linearized_likes</span>
</pre></div>
</div>
</div>
</div>
<p>Calculate MDE for the linearized metric.</p>
<p>The MDE of the linearized metric scales by the mean value of the denominator relative to the MDE of the original ratio metric.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mde</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">mean_views</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  
<span class="n">mde_linearized</span> <span class="o">=</span> <span class="n">mean_views</span> <span class="o">*</span> <span class="n">mde</span>  
<span class="n">mde_linearized</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(0.6881078191814295)
</pre></div>
</div>
</div>
</div>
<p>Calculate the power of T-test on the linearized metric.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">power</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">p_values</span> <span class="o">=</span> <span class="n">monte_carlo_power</span><span class="p">(</span>
    <span class="n">data_a</span><span class="o">=</span><span class="n">linearized_likes_control</span>
    <span class="p">,</span> <span class="n">data_b</span><span class="o">=</span><span class="n">linearized_likes_test</span>
    <span class="p">,</span> <span class="n">test_func</span><span class="o">=</span><span class="n">pg_ttest</span>
    <span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span>
    <span class="p">,</span> <span class="n">n_sim</span><span class="o">=</span><span class="mi">10_000</span>
    <span class="p">,</span> <span class="n">effect_size</span><span class="o">=</span><span class="n">mde_linearized</span>
<span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10000/10000 [01:18&lt;00:00, 128.12it/s]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;power&#39;: 1.0,
 &#39;effect_size&#39;: np.float64(0.6881078191814295),
 &#39;mean_effect&#39;: np.float64(0.6745717491698086),
 &#39;effect_std&#39;: np.float64(0.08720452271781552),
 &#39;mean_pvalue&#39;: np.float64(6.680173140404055e-08),
 &#39;n_sim&#39;: 10000,
 &#39;sample_size_a&#39;: 6548,
 &#39;sample_size_b&#39;: 6545}
</pre></div>
</div>
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>The resulting power is greater than 0.9</p></li>
<li><p>Therefore, 6500 users in each group is sufficient for us.</p></li>
<li><p>Therefore, we will conduct the A/A test for hypothesis 1 for at least one week and ensure at least 6500 users are collected.</p></li>
</ul>
</section>
<section id="group-size-for-hypothesis-2">
<h3>4.5.2 Group Size for Hypothesis 2<a class="headerlink" href="#group-size-for-hypothesis-2" title="Link to this heading">#</a></h3>
<p>We’ll proceed similarly to hypothesis 1 for hypothesis 2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> df &lt;&lt;
SELECT 
    multiIf(
        exp_group = 0, &#39;control&#39;
        , exp_group = 3, &#39;test&#39;
        , &#39;unknown&#39;
    ) as group
    , user_id
    , countIf(action = &#39;like&#39;) as likes
    , countIf(action = &#39;view&#39;) as views
    , ifNull(likes / nullIf(views, 0), 0) as ctr
FROM
    feed_actions
WHERE 
    toDate(time) BETWEEN &#39;2025-07-19&#39; and &#39;2025-07-25&#39;
    and exp_group in (0, 3)
GROUP BY
    group
    , user_id
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Returning data to local variable df
</pre></div>
</div>
</div>
</div>
<p>Check the correctness of splitting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">check_split_correctness</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== SPLITTING CORRECTNESS CHECK ===

1. USER UNIQUENESS CHECK:
Checking that there are no users present in both groups simultaneously.
✅ SUCCESS: No users found in both groups simultaneously.
   Number of users in both groups: 0

==================================================

2. GROUP SIZE BALANCE CHECK:

- H0: The number of users in test and control groups is equal
- H1: The number of users in test and control groups is not equal

We choose a significance level of 0.05.
We use the chi-square goodness-of-fit test.
Observed counts: {&#39;test&#39;: np.int64(6647), &#39;control&#39;: np.int64(6521)}
Expected counts (equal distribution): [np.float64(6584.0), np.float64(6584.0)]
Chi-square statistic: 1.2057
P-value: 0.2722
Percentage difference: 0.96%
✅ FAIL TO REJECT H0: The number of users in test and control groups is equal.
   Group sizes are balanced statistically.

==================================================
SUMMARY:
✅ ALL CHECKS PASSED: Splitting system appears to be working correctly.
</pre></div>
</div>
</div>
</div>
<p>Check if the number of users who came during the week before the A/A test is sufficient for us.</p>
<p>Calculate linearized metrics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_linearized</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="s1">&#39;likes&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">global_ctr</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
    <span class="o">/</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;linearized_likes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">global_ctr</span>
<span class="n">linearized_likes_control</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">linearized_likes</span>
<span class="n">linearized_likes_test</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">linearized_likes</span>
</pre></div>
</div>
</div>
</div>
<p>Calculate MDE for the linearized metric.</p>
<p>The MDE of the linearized metric scales by the mean value of the denominator relative to the MDE of the original ratio metric.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mde</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">mean_views</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  
<span class="n">mde_linearized</span> <span class="o">=</span> <span class="n">mean_views</span> <span class="o">*</span> <span class="n">mde</span>  
<span class="n">mde_linearized</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(0.6842094770740684)
</pre></div>
</div>
</div>
</div>
<p>Calculate the power of T-test on the linearized metric.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">power</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">p_values</span> <span class="o">=</span> <span class="n">monte_carlo_power</span><span class="p">(</span>
    <span class="n">data_a</span><span class="o">=</span><span class="n">linearized_likes_control</span>
    <span class="p">,</span> <span class="n">data_b</span><span class="o">=</span><span class="n">linearized_likes_test</span>
    <span class="p">,</span> <span class="n">test_func</span><span class="o">=</span><span class="n">pg_ttest</span>
    <span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span>
    <span class="p">,</span> <span class="n">n_sim</span><span class="o">=</span><span class="mi">10_000</span>
    <span class="p">,</span> <span class="n">effect_size</span><span class="o">=</span><span class="n">mde_linearized</span>
<span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10000/10000 [01:18&lt;00:00, 127.66it/s]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;power&#39;: 0.9999,
 &#39;effect_size&#39;: np.float64(0.6842094770740684),
 &#39;mean_effect&#39;: np.float64(0.5084212002342425),
 &#39;effect_std&#39;: np.float64(0.08676260020186066),
 &#39;mean_pvalue&#39;: np.float64(5.0276496102241296e-05),
 &#39;n_sim&#39;: 10000,
 &#39;sample_size_a&#39;: 6521,
 &#39;sample_size_b&#39;: 6647}
</pre></div>
</div>
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>The resulting power is greater than 0.9</p></li>
<li><p>Therefore, the number of users in each group who came during the week before the A/A test is sufficient for us.</p></li>
<li><p>Therefore, we will conduct the A/A test for hypothesis 2 for at least one week and ensure at least 6500 users are collected.</p></li>
</ul>
</section>
</section>
<section id="analysis-of-a-a-test-results">
<h2>4.6 Analysis of A/A Test Results<a class="headerlink" href="#analysis-of-a-a-test-results" title="Link to this heading">#</a></h2>
<p>A/A test ran from <code class="docutils literal notranslate"><span class="pre">2025-07-26</span></code> to <code class="docutils literal notranslate"><span class="pre">2025-08-01</span></code></p>
<section id="hypothesis-1">
<h3>4.6.1 Hypothesis 1<a class="headerlink" href="#hypothesis-1" title="Link to this heading">#</a></h3>
<p>Get the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> df &lt;&lt;
SELECT 
    multiIf(
        exp_group = 1, &#39;control&#39;
        , exp_group = 2, &#39;test&#39;
        , &#39;unknown&#39;
    ) as group
    , user_id
    , countIf(action = &#39;like&#39;) as likes
    , countIf(action = &#39;view&#39;) as views
    , ifNull(likes / nullIf(views, 0), 0) as ctr
FROM
    feed_actions
WHERE 
    toDate(time) BETWEEN &#39;2025-07-26&#39; and &#39;2025-08-01&#39;
    and exp_group in (1, 2)
GROUP BY
    group
    , user_id
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Returning data to local variable df
</pre></div>
</div>
</div>
</div>
<p>Check the correctness of splitting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">check_split_correctness</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== SPLITTING CORRECTNESS CHECK ===

1. USER UNIQUENESS CHECK:
Checking that there are no users present in both groups simultaneously.
✅ SUCCESS: No users found in both groups simultaneously.
   Number of users in both groups: 0

==================================================

2. GROUP SIZE BALANCE CHECK:

- H0: The number of users in test and control groups is equal
- H1: The number of users in test and control groups is not equal

We choose a significance level of 0.05.
We use the chi-square goodness-of-fit test.
Observed counts: {&#39;control&#39;: np.int64(8491), &#39;test&#39;: np.int64(8362)}
Expected counts (equal distribution): [np.float64(8426.5), np.float64(8426.5)]
Chi-square statistic: 0.9874
P-value: 0.3204
Percentage difference: 0.77%
✅ FAIL TO REJECT H0: The number of users in test and control groups is equal.
   Group sizes are balanced statistically.

==================================================
SUMMARY:
✅ ALL CHECKS PASSED: Splitting system appears to be working correctly.
</pre></div>
</div>
</div>
</div>
<p>Conduct the test.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ttest_linearized</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Linearized metric created using global CTR from control group
Global CTR: 0.2108
Difference in Global CTR (test - control): 0.0010
</pre></div>
</div>
<img alt="../../_images/892c46d89b90e05ee898d5624252dccf3485beacf9018b944ec16f222047200c.png" src="../../_images/892c46d89b90e05ee898d5624252dccf3485beacf9018b944ec16f222047200c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Formulate hypotheses:
- H0: Mean value of the linearized metric in control and test groups are equal
- H1: Mean value of the linearized metric in control and test groups are not equal

Significance level: 0.05

Variance homogeneity test (Levene&#39;s test):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>W</th>
      <th>pval</th>
      <th>equal_var</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>levene</th>
      <td>0.02</td>
      <td>0.88</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Variances are equal (p-value ≥ 0.05) - using standard t-test without correction

Difference in means (test - control): 0.0680

T-test results:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>T</th>
      <th>dof</th>
      <th>alternative</th>
      <th>p-val</th>
      <th>CI95%</th>
      <th>cohen-d</th>
      <th>BF10</th>
      <th>power</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>T-test</th>
      <td>0.86</td>
      <td>16851</td>
      <td>two-sided</td>
      <td>0.39</td>
      <td>[-0.09, 0.22]</td>
      <td>0.01</td>
      <td>0.025</td>
      <td>0.14</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Conclusion:
FAIL TO REJECT H0: p-value (0.3878) ≥ 0.05 - No significant difference
</pre></div>
</div>
</div>
</div>
<p>A/A test for hypothesis 1 completed successfully, no statistically significant differences between groups were found.</p>
<p>Check if the group sizes during the A/A test week are sufficient for the A/B test.</p>
<p>Calculate linearized metrics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_linearized</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="s1">&#39;likes&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">global_ctr</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
    <span class="o">/</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;linearized_likes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">global_ctr</span>
<span class="n">linearized_likes_control</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">linearized_likes</span>
<span class="n">linearized_likes_test</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">linearized_likes</span>
</pre></div>
</div>
</div>
</div>
<p>Calculate MDE for the linearized metric.</p>
<p>The MDE of the linearized metric scales by the mean value of the denominator relative to the MDE of the original ratio metric.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mde</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">mean_views</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  
<span class="n">mde_linearized</span> <span class="o">=</span> <span class="n">mean_views</span> <span class="o">*</span> <span class="n">mde</span>  
<span class="n">mde_linearized</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(0.7047144034860441)
</pre></div>
</div>
</div>
</div>
<p>Calculate the power of T-test on the linearized metric.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">power</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">p_values</span> <span class="o">=</span> <span class="n">monte_carlo_power</span><span class="p">(</span>
    <span class="n">data_a</span><span class="o">=</span><span class="n">linearized_likes_control</span>
    <span class="p">,</span> <span class="n">data_b</span><span class="o">=</span><span class="n">linearized_likes_test</span>
    <span class="p">,</span> <span class="n">test_func</span><span class="o">=</span><span class="n">pg_ttest</span>
    <span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span>
    <span class="p">,</span> <span class="n">n_sim</span><span class="o">=</span><span class="mi">10_000</span>
    <span class="p">,</span> <span class="n">effect_size</span><span class="o">=</span><span class="n">mde_linearized</span>
<span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10000/10000 [01:22&lt;00:00, 121.62it/s]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;power&#39;: 1.0,
 &#39;effect_size&#39;: np.float64(0.7047144034860441),
 &#39;mean_effect&#39;: np.float64(0.7739889597895855),
 &#39;effect_std&#39;: np.float64(0.07862503800587009),
 &#39;mean_pvalue&#39;: np.float64(9.033169205926269e-13),
 &#39;n_sim&#39;: 10000,
 &#39;sample_size_a&#39;: 8491,
 &#39;sample_size_b&#39;: 8362}
</pre></div>
</div>
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>The resulting power is greater than 0.9</p></li>
<li><p>Therefore, approximately 8500 users in each group who came during the A/A test week is sufficient for us.</p></li>
<li><p>Therefore, we will conduct the A/B test for hypothesis 1 for at least one week and ensure at least 8500 users are collected.</p></li>
</ul>
</section>
<section id="hypothesis-2">
<h3>4.6.2 Hypothesis 2<a class="headerlink" href="#hypothesis-2" title="Link to this heading">#</a></h3>
<p>Get the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> df &lt;&lt;
SELECT 
    multiIf(
        exp_group = 0, &#39;control&#39;
        , exp_group = 3, &#39;test&#39;
        , &#39;unknown&#39;
    ) as group
    , user_id
    , countIf(action = &#39;like&#39;) as likes
    , countIf(action = &#39;view&#39;) as views
    , ifNull(likes / nullIf(views, 0), 0) as ctr
FROM
    feed_actions
WHERE 
    toDate(time) BETWEEN &#39;2025-07-26&#39; and &#39;2025-08-01&#39;
    and exp_group in (0, 3)
GROUP BY
    group
    , user_id
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Returning data to local variable df
</pre></div>
</div>
</div>
</div>
<p>Check the correctness of splitting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">check_split_correctness</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== SPLITTING CORRECTNESS CHECK ===

1. USER UNIQUENESS CHECK:
Checking that there are no users present in both groups simultaneously.
✅ SUCCESS: No users found in both groups simultaneously.
   Number of users in both groups: 0

==================================================

2. GROUP SIZE BALANCE CHECK:

- H0: The number of users in test and control groups is equal
- H1: The number of users in test and control groups is not equal

We choose a significance level of 0.05.
We use the chi-square goodness-of-fit test.
Observed counts: {&#39;test&#39;: np.int64(8425), &#39;control&#39;: np.int64(8328)}
Expected counts (equal distribution): [np.float64(8376.5), np.float64(8376.5)]
Chi-square statistic: 0.5616
P-value: 0.4536
Percentage difference: 0.58%
✅ FAIL TO REJECT H0: The number of users in test and control groups is equal.
   Group sizes are balanced statistically.

==================================================
SUMMARY:
✅ ALL CHECKS PASSED: Splitting system appears to be working correctly.
</pre></div>
</div>
</div>
</div>
<p>Conduct the test.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ttest_linearized</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Linearized metric created using global CTR from control group
Global CTR: 0.2119
Difference in Global CTR (test - control): -0.0005
</pre></div>
</div>
<img alt="../../_images/108dd5f3f51bd3c38b8199d949941ef58f5cb38f6dc588c379f9af8036cb82f3.png" src="../../_images/108dd5f3f51bd3c38b8199d949941ef58f5cb38f6dc588c379f9af8036cb82f3.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Formulate hypotheses:
- H0: Mean value of the linearized metric in control and test groups are equal
- H1: Mean value of the linearized metric in control and test groups are not equal

Significance level: 0.05

Variance homogeneity test (Levene&#39;s test):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>W</th>
      <th>pval</th>
      <th>equal_var</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>levene</th>
      <td>0.26</td>
      <td>0.61</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Variances are equal (p-value ≥ 0.05) - using standard t-test without correction

Difference in means (test - control): -0.0337

T-test results:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>T</th>
      <th>dof</th>
      <th>alternative</th>
      <th>p-val</th>
      <th>CI95%</th>
      <th>cohen-d</th>
      <th>BF10</th>
      <th>power</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>T-test</th>
      <td>-0.42</td>
      <td>16751</td>
      <td>two-sided</td>
      <td>0.67</td>
      <td>[-0.19, 0.12]</td>
      <td>0.01</td>
      <td>0.019</td>
      <td>0.07</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Conclusion:
FAIL TO REJECT H0: p-value (0.6736) ≥ 0.05 - No significant difference
</pre></div>
</div>
</div>
</div>
<p>A/A test for hypothesis 2 completed successfully, no statistically significant differences between groups were found.</p>
<p>Check if the group sizes during the A/A test week are sufficient for the A/B test.</p>
<p>Calculate linearized metrics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_linearized</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="s1">&#39;likes&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">global_ctr</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
    <span class="o">/</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;linearized_likes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">global_ctr</span>
<span class="n">linearized_likes_control</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">linearized_likes</span>
<span class="n">linearized_likes_test</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">linearized_likes</span>
</pre></div>
</div>
</div>
</div>
<p>Calculate MDE for the linearized metric.</p>
<p>The MDE of the linearized metric scales by the mean value of the denominator relative to the MDE of the original ratio metric.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mde</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">mean_views</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  
<span class="n">mde_linearized</span> <span class="o">=</span> <span class="n">mean_views</span> <span class="o">*</span> <span class="n">mde</span>  
<span class="n">mde_linearized</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(0.7036443323727185)
</pre></div>
</div>
</div>
</div>
<p>Calculate the power of T-test on the linearized metric.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">power</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">p_values</span> <span class="o">=</span> <span class="n">monte_carlo_power</span><span class="p">(</span>
    <span class="n">data_a</span><span class="o">=</span><span class="n">linearized_likes_control</span>
    <span class="p">,</span> <span class="n">data_b</span><span class="o">=</span><span class="n">linearized_likes_test</span>
    <span class="p">,</span> <span class="n">test_func</span><span class="o">=</span><span class="n">pg_ttest</span>
    <span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span>
    <span class="p">,</span> <span class="n">n_sim</span><span class="o">=</span><span class="mi">10_000</span>
    <span class="p">,</span> <span class="n">effect_size</span><span class="o">=</span><span class="n">mde_linearized</span>
<span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10000/10000 [01:21&lt;00:00, 122.12it/s]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;power&#39;: 1.0,
 &#39;effect_size&#39;: np.float64(0.7036443323727185),
 &#39;mean_effect&#39;: np.float64(0.6701341105424857),
 &#39;effect_std&#39;: np.float64(0.08047631368856027),
 &#39;mean_pvalue&#39;: np.float64(7.217972572258684e-10),
 &#39;n_sim&#39;: 10000,
 &#39;sample_size_a&#39;: 8328,
 &#39;sample_size_b&#39;: 8425}
</pre></div>
</div>
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>The resulting power is greater than 0.9</p></li>
<li><p>Therefore, approximately 8500 users in each group who came during the A/A test week is sufficient for us.</p></li>
<li><p>Therefore, we will conduct the A/B test for hypothesis 2 for at least one week and ensure at least 8500 users are collected.</p></li>
</ul>
</section>
</section>
<section id="analysis-of-a-b-test-results-for-hypothesis-1">
<h2>4.7 Analysis of A/B Test Results for Hypothesis 1<a class="headerlink" href="#analysis-of-a-b-test-results-for-hypothesis-1" title="Link to this heading">#</a></h2>
<p>A/B test ran from <code class="docutils literal notranslate"><span class="pre">2025-08-02</span></code> to <code class="docutils literal notranslate"><span class="pre">2025-08-08</span></code></p>
<section id="data-loading">
<h3>4.7.1 Data Loading<a class="headerlink" href="#data-loading" title="Link to this heading">#</a></h3>
<p>Get the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> df &lt;&lt;
WITH user_first_visit AS (
    SELECT 
        user_id
        , min(toDate(time)) as first_date
    FROM 
        feed_actions
    GROUP BY 
        user_id
)
, exp_data as (
    SELECT 
        multiIf(
            exp_group = 1, &#39;control&#39;
            , exp_group = 2, &#39;test&#39;
            , &#39;unknown&#39;
        ) as group
        , argMax(multiIf(
            gender = 1, &#39;female&#39;
            , gender = 0, &#39;male&#39;
            , &#39;unknown&#39;
        ), time) as gender
        , argMax(multiIf(
            age &lt; 25, &#39;&lt;25&#39;
            , age between 25 and 40, &#39;25-40&#39;
            , age between 41 and 55, &#39;41-55&#39; 
            , age &gt;= 56, &#39;56+&#39;
            , &#39;unknown&#39;
        ), time) as age_group      
        , argMax(source, time) as source
        , argMax(os, time) as os
        , argMax(country, time) as country
        , argMax(city, time) as city
        , user_id
        , uniq(post_id) as posts
        , countIf(action = &#39;like&#39;) as likes
        , countIf(action = &#39;view&#39;) as views
        , ifNull(likes / nullIf(views, 0), 0) as ctr
        , uniq(toDate(time)) as days
    FROM
        feed_actions
    WHERE 
        toDate(time) BETWEEN &#39;2025-08-02&#39; and &#39;2025-08-08&#39;
        and exp_group in (1, 2)
    GROUP BY
        group
        , user_id
)
SELECT
        ed.*
        , if(ufv.first_date &gt;= &#39;2025-08-02&#39;, &#39;new&#39;, &#39;existing&#39;) as user_status
FROM
    exp_data ed
    LEFT JOIN user_first_visit ufv ON ed.user_id = ufv.user_id
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Returning data to local variable df
</pre></div>
</div>
</div>
</div>
<p>Let’s save the dataframe for use in the supplement.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_for_supplement</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> df_daily &lt;&lt;
SELECT 
    toDate(time) as date
    , user_id
    , uniq(post_id) as posts
    , countIf(action = &#39;like&#39;) as likes
    , countIf(action = &#39;view&#39;) as views
    , ifNull(likes / nullIf(views, 0), 0) as ctr    
    , multiIf(
        exp_group = 1, &#39;control&#39;
        , exp_group = 2, &#39;test&#39;
        , &#39;unknown&#39;
    ) as group
    , argMax(multiIf(
        gender = 1, &#39;female&#39;
        , gender = 0, &#39;male&#39;
        , &#39;unknown&#39;
    ), time) as gender
    , argMax(multiIf(
        age &lt; 25, &#39;&lt;25&#39;
        , age between 25 and 40, &#39;25-40&#39;
        , age between 41 and 55, &#39;41-55&#39; 
        , age &gt;= 56, &#39;56+&#39;
        , &#39;unknown&#39;
    ), time) as age_group    
    , argMax(source, time) as source
    , argMax(os, time) as os
    , argMax(country, time) as country
    , argMax(city, time) as city
FROM
    feed_actions
WHERE 
    toDate(time) BETWEEN &#39;2025-08-02&#39; and &#39;2025-08-08&#39;
    and exp_group in (1, 2)
GROUP BY
    date
    , user_id
    , group
ORDER BY
    date    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Returning data to local variable df_daily
</pre></div>
</div>
</div>
</div>
<p>Convert the date to datetime.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>group</th>
      <th>gender</th>
      <th>age_group</th>
      <th>source</th>
      <th>os</th>
      <th>country</th>
      <th>city</th>
      <th>user_id</th>
      <th>posts</th>
      <th>likes</th>
      <th>views</th>
      <th>ctr</th>
      <th>days</th>
      <th>user_status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>test</td>
      <td>female</td>
      <td>25-40</td>
      <td>organic</td>
      <td>Android</td>
      <td>Russia</td>
      <td>Berezniki</td>
      <td>127977</td>
      <td>101</td>
      <td>12</td>
      <td>129</td>
      <td>0.09</td>
      <td>3</td>
      <td>existing</td>
    </tr>
    <tr>
      <th>1</th>
      <td>control</td>
      <td>female</td>
      <td>&lt;25</td>
      <td>ads</td>
      <td>Android</td>
      <td>Russia</td>
      <td>Noginsk</td>
      <td>31954</td>
      <td>37</td>
      <td>8</td>
      <td>50</td>
      <td>0.16</td>
      <td>1</td>
      <td>new</td>
    </tr>
    <tr>
      <th>2</th>
      <td>control</td>
      <td>male</td>
      <td>&lt;25</td>
      <td>ads</td>
      <td>Android</td>
      <td>Russia</td>
      <td>Tomsk</td>
      <td>33061</td>
      <td>81</td>
      <td>16</td>
      <td>102</td>
      <td>0.16</td>
      <td>2</td>
      <td>new</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_daily</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>user_id</th>
      <th>posts</th>
      <th>likes</th>
      <th>views</th>
      <th>ctr</th>
      <th>group</th>
      <th>gender</th>
      <th>age_group</th>
      <th>source</th>
      <th>os</th>
      <th>country</th>
      <th>city</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2025-08-02</td>
      <td>110599</td>
      <td>18</td>
      <td>6</td>
      <td>18</td>
      <td>0.33</td>
      <td>test</td>
      <td>female</td>
      <td>41-55</td>
      <td>organic</td>
      <td>iOS</td>
      <td>Russia</td>
      <td>Borisoglebsk</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2025-08-02</td>
      <td>132529</td>
      <td>17</td>
      <td>3</td>
      <td>17</td>
      <td>0.18</td>
      <td>control</td>
      <td>female</td>
      <td>41-55</td>
      <td>organic</td>
      <td>Android</td>
      <td>Russia</td>
      <td>Vologda</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2025-08-02</td>
      <td>4612</td>
      <td>39</td>
      <td>8</td>
      <td>47</td>
      <td>0.17</td>
      <td>control</td>
      <td>male</td>
      <td>&lt;25</td>
      <td>ads</td>
      <td>iOS</td>
      <td>Russia</td>
      <td>Moscow</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>group           object
gender          object
age_group       object
source          object
os              object
country         object
city            object
user_id          int64
posts            int64
likes            int64
views            int64
ctr            float64
days             int64
user_status     object
dtype: object
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_daily</span><span class="o">.</span><span class="n">dtypes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>date         datetime64[ns]
user_id               int64
posts                 int64
likes                 int64
views                 int64
ctr                 float64
group                object
gender               object
age_group            object
source               object
os                   object
country              object
city                 object
dtype: object
</pre></div>
</div>
</div>
</div>
<p>Replace the data type for dimensions with categorical.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;os&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;os&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;user_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;user_status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;os&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;os&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-exploration">
<h3>4.7.2 Data Exploration<a class="headerlink" href="#data-exploration" title="Link to this heading">#</a></h3>
<p>Explore DataFrame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">info</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Full duplicates: 0
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>unique</th>
      <th>top</th>
      <th>freq</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>group</th>
      <td>19897</td>
      <td>2</td>
      <td>control</td>
      <td>10020</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>gender</th>
      <td>19897</td>
      <td>2</td>
      <td>female</td>
      <td>11007</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>age_group</th>
      <td>19897</td>
      <td>4</td>
      <td>&lt;25</td>
      <td>10379</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>source</th>
      <td>19897</td>
      <td>2</td>
      <td>organic</td>
      <td>10579</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>os</th>
      <td>19897</td>
      <td>2</td>
      <td>Android</td>
      <td>12859</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>country</th>
      <td>19897</td>
      <td>11</td>
      <td>Russia</td>
      <td>17455</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>city</th>
      <td>19897</td>
      <td>2117</td>
      <td>Moscow</td>
      <td>2701</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>user_id</th>
      <td>19,897.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>75,513.14</td>
      <td>53,254.93</td>
      <td>206.00</td>
      <td>21,945.00</td>
      <td>109,319.00</td>
      <td>126,146.00</td>
      <td>140,740.00</td>
    </tr>
    <tr>
      <th>posts</th>
      <td>19,897.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>52.03</td>
      <td>29.99</td>
      <td>1.00</td>
      <td>29.00</td>
      <td>46.00</td>
      <td>70.00</td>
      <td>202.00</td>
    </tr>
    <tr>
      <th>likes</th>
      <td>19,897.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>13.69</td>
      <td>10.88</td>
      <td>0.00</td>
      <td>6.00</td>
      <td>11.00</td>
      <td>19.00</td>
      <td>93.00</td>
    </tr>
    <tr>
      <th>views</th>
      <td>19,897.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>66.79</td>
      <td>45.36</td>
      <td>1.00</td>
      <td>32.00</td>
      <td>57.00</td>
      <td>91.00</td>
      <td>341.00</td>
    </tr>
    <tr>
      <th>ctr</th>
      <td>19,897.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.22</td>
      <td>0.12</td>
      <td>0.00</td>
      <td>0.12</td>
      <td>0.20</td>
      <td>0.29</td>
      <td>0.90</td>
    </tr>
    <tr>
      <th>days</th>
      <td>19,897.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.93</td>
      <td>1.04</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>2.00</td>
      <td>3.00</td>
      <td>7.00</td>
    </tr>
    <tr>
      <th>user_status</th>
      <td>19897</td>
      <td>2</td>
      <td>existing</td>
      <td>14155</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>group</th>
      <th>gender</th>
      <th>age_group</th>
      <th>source</th>
      <th>os</th>
      <th>country</th>
      <th>city</th>
      <th>user_id</th>
      <th>posts</th>
      <th>likes</th>
      <th>views</th>
      <th>ctr</th>
      <th>days</th>
      <th>user_status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Dupl</th>
      <td>19895</td>
      <td>19895</td>
      <td>19893</td>
      <td>19895</td>
      <td>19895</td>
      <td>19886</td>
      <td>17780</td>
      <td>0</td>
      <td>19714</td>
      <td>19815</td>
      <td>19616</td>
      <td>17105</td>
      <td>19890</td>
      <td>19895</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>group</th>
      <th>gender</th>
      <th>age_group</th>
      <th>source</th>
      <th>os</th>
      <th>country</th>
      <th>city</th>
      <th>user_id</th>
      <th>posts</th>
      <th>likes</th>
      <th>views</th>
      <th>ctr</th>
      <th>days</th>
      <th>user_status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Miss</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>posts</th>
      <th>likes</th>
      <th>views</th>
      <th>ctr</th>
      <th>days</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Zeros</th>
      <td>0</td>
      <td>0</td>
      <td>121</td>
      <td>0</td>
      <td>121</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>posts</th>
      <th>likes</th>
      <th>views</th>
      <th>ctr</th>
      <th>days</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Negs</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Everything is fine.</p></li>
<li><p>Null values are present where they are acceptable.</p></li>
<li><p>There are no duplicates in user_id.</p></li>
<li><p>2 groups.</p></li>
<li><p>The minimum value in views is not 0.</p></li>
<li><p>There are no negative values.</p></li>
</ul>
<section id="checking-the-correctness-of-the-splitting">
<h4>4.7.2.1 Checking the Correctness of the Splitting<a class="headerlink" href="#checking-the-correctness-of-the-splitting" title="Link to this heading">#</a></h4>
<p>Check the correctness of splitting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">check_split_correctness</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== SPLITTING CORRECTNESS CHECK ===

1. USER UNIQUENESS CHECK:
Checking that there are no users present in both groups simultaneously.
✅ SUCCESS: No users found in both groups simultaneously.
   Number of users in both groups: 0

==================================================

2. GROUP SIZE BALANCE CHECK:

- H0: The number of users in test and control groups is equal
- H1: The number of users in test and control groups is not equal

We choose a significance level of 0.05.
We use the chi-square goodness-of-fit test.
Observed counts: {&#39;control&#39;: np.int64(10020), &#39;test&#39;: np.int64(9877)}
Expected counts (equal distribution): [np.float64(9948.5), np.float64(9948.5)]
Chi-square statistic: 1.0277
P-value: 0.3107
Percentage difference: 0.72%
✅ FAIL TO REJECT H0: The number of users in test and control groups is equal.
   Group sizes are balanced statistically.

==================================================
SUMMARY:
✅ ALL CHECKS PASSED: Splitting system appears to be working correctly.
</pre></div>
</div>
</div>
</div>
</section>
<section id="user-distribution">
<h4>4.7.2.2 User Distribution<a class="headerlink" href="#user-distribution" title="Link to this heading">#</a></h4>
<p>Let’s examine how users are distributed across dimensions.</p>
<p><strong>By Test Group</strong></p>
<p>Let’s check how users are distributed across groups.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.1%&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users Distribution by Group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/40a673e9b36fc8b935a8e96d151977ce054f5d99cbb3b94c450c9a3f7a9883a6.png" src="../../_images/40a673e9b36fc8b935a8e96d151977ce054f5d99cbb3b94c450c9a3f7a9883a6.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Approximately equal distribution across groups.</p></li>
</ul>
<p><strong>By User Status (New or Not)</strong></p>
<p>Let’s check how users are distributed by new user status.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;user_status&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.1%&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users Distribution by Group and Status&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/36cd714f71eafa8aae4d12600c4d383114eb9588556ff510c5cd4c4e04d76db2.png" src="../../_images/36cd714f71eafa8aae4d12600c4d383114eb9588556ff510c5cd4c4e04d76db2.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Both groups have about 29% new users (first appeared during the test).</p></li>
<li><p>The ratio between groups is approximately the same.</p></li>
</ul>
<p><strong>By Gender</strong></p>
<p>Let’s check how users are distributed by gender.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;gender&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.1%&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users Distribution by Group and Gender&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/410f47f513b6c1c23c9df8c17d089d285ece2e00b7e099c449e9eeaab85887ea.png" src="../../_images/410f47f513b6c1c23c9df8c17d089d285ece2e00b7e099c449e9eeaab85887ea.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>There are more women in both groups.</p></li>
<li><p>The ratio between groups is approximately the same.</p></li>
</ul>
<p><strong>By Age Group</strong></p>
<p>Let’s check how users are distributed across age groups.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;age_group&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.1%&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users Distribution by Group and Age Group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b30a8b1ca4abea2144e219a8df07ee327715d9bb0c12c5cc69abd7171430478e.png" src="../../_images/b30a8b1ca4abea2144e219a8df07ee327715d9bb0c12c5cc69abd7171430478e.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Users under 25 are the largest group in both groups.</p></li>
<li><p>25-40 years old is the second largest.</p></li>
<li><p>The ratio in each age category is approximately the same between groups.</p></li>
</ul>
<p><strong>By OS</strong></p>
<p>Let’s check how users are distributed by OS.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;os&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.1%&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users Distribution by Group and OS&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/fb37ed94a80f2ae05b3df59b4e217eef2afa3431e080b14e8fc326b2fdc94fcc.png" src="../../_images/fb37ed94a80f2ae05b3df59b4e217eef2afa3431e080b14e8fc326b2fdc94fcc.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>There are more Android users in both groups.</p></li>
<li><p>The distribution between groups is approximately the same.</p></li>
</ul>
<p><strong>By Source</strong></p>
<p>Let’s check how users are distributed by traffic source.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;source&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.1%&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users Distribution by Group and Source&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/c2103348a14313d83feccde49e8b7dd3f43b12092464d327e70eee8b3151ee69.png" src="../../_images/c2103348a14313d83feccde49e8b7dd3f43b12092464d327e70eee8b3151ee69.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Organic traffic is slightly higher than paid traffic.</p></li>
<li><p>The distribution between groups is approximately the same.</p></li>
</ul>
<p><strong>By Country</strong></p>
<p>Let’s check how users are distributed by country.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;country&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.1%&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users Distribution by Group and Country&#39;</span>
    <span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">700</span>
<span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">legend_y</span><span class="o">=</span><span class="mf">1.06</span>
    <span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;categoryorder&#39;</span><span class="p">:</span> <span class="s1">&#39;total ascending&#39;</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/212b647c863fa53f2bf1da265fdaa4d439aab8b866cee93d7113640e9cacfe0f.png" src="../../_images/212b647c863fa53f2bf1da265fdaa4d439aab8b866cee93d7113640e9cacfe0f.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Most users are from Russia.</p></li>
<li><p>The distribution between groups is approximately the same.</p></li>
</ul>
<p><strong>By Top Cities</strong></p>
<p>Let’s check how users are distributed across top cities.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">top_cities</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top_cities</span><span class="p">)]</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;city&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.1%&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users Distribution by Group and Top Cities&#39;</span>
    <span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">700</span>
<span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">legend_y</span><span class="o">=</span><span class="mf">1.06</span>
    <span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;categoryorder&#39;</span><span class="p">:</span> <span class="s1">&#39;total ascending&#39;</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/05b902a7d43735f38036812fd13a254ae9c0c3825e3263fa82c804bf96dc841b.png" src="../../_images/05b902a7d43735f38036812fd13a254ae9c0c3825e3263fa82c804bf96dc841b.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Most users are from Moscow and St. Petersburg.</p></li>
<li><p>The distribution between groups is similar.</p></li>
</ul>
</section>
<section id="distribution-of-post-count">
<h4>4.7.2.3 Distribution of Post Count<a class="headerlink" href="#distribution-of-post-count" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;posts&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posts Distribution by Group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f18fce24d2205d23027e5ac296dc3237af02857172e6cc686b3e0411c6c6db99.png" src="../../_images/f18fce24d2205d23027e5ac296dc3237af02857172e6cc686b3e0411c6c6db99.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Nothing unusual.</p></li>
</ul>
</section>
<section id="distribution-of-likes-count">
<h4>4.7.2.4 Distribution of Likes Count<a class="headerlink" href="#distribution-of-likes-count" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;likes&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Likes Distribution by Group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/4da029b5432dc2008f349c5d8b5b089510e06ddd3060d8cee90b696ee5703657.png" src="../../_images/4da029b5432dc2008f349c5d8b5b089510e06ddd3060d8cee90b696ee5703657.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>The distribution of likes in the control group is slightly shifted to the right compared to the test group.</p></li>
</ul>
</section>
<section id="distribution-of-views">
<h4>4.7.2.5 Distribution of Views<a class="headerlink" href="#distribution-of-views" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;views&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Views Distribution by Group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/4313d4a1a262fdfc4088bf2a87d8650d3f96545dee12dd63b8bbc8e099b784be.png" src="../../_images/4313d4a1a262fdfc4088bf2a87d8650d3f96545dee12dd63b8bbc8e099b784be.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Nothing unusual.</p></li>
</ul>
</section>
<section id="distribution-of-ctr">
<h4>4.7.2.6 Distribution of CTR<a class="headerlink" href="#distribution-of-ctr" title="Link to this heading">#</a></h4>
<p>Let’s examine how CTR is distributed across groups.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ctr&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CTR Distribution by Group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/37e0af8a99275e8aefa08eb9343deb6de80c5108202d223b0db8b2e97befef69.png" src="../../_images/37e0af8a99275e8aefa08eb9343deb6de80c5108202d223b0db8b2e97befef69.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>In the control group, the distribution resembles normal.</p></li>
<li><p>In the test group, there is a bimodal distribution. This is clearly strange.</p></li>
<li><p>Bimodal distribution often indicates the presence of two different populations.</p></li>
</ul>
<p>Let’s examine across different dimensions. Need to determine if bimodality appears in all dimensions or not.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ctr&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">facet_col</span><span class="o">=</span><span class="s1">&#39;user_status&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CTR Distribution by Group and Status&#39;</span>
<span class="p">)</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ca84eec954236eaac9c47060d1fcb23c5b7fea32f8230744466c734d221ef222.png" src="../../_images/ca84eec954236eaac9c47060d1fcb23c5b7fea32f8230744466c734d221ef222.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ctr&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">facet_col</span><span class="o">=</span><span class="s1">&#39;gender&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CTR Distribution by Group and Gender&#39;</span>
<span class="p">)</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/5c3143f7f0c7a10f5e98bd9977a4dad19bddb37bfb1e41e634c0f259d035d8b4.png" src="../../_images/5c3143f7f0c7a10f5e98bd9977a4dad19bddb37bfb1e41e634c0f259d035d8b4.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ctr&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">facet_col</span><span class="o">=</span><span class="s1">&#39;age_group&#39;</span>
    <span class="p">,</span> <span class="n">facet_col_wrap</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CTR Distribution by Group and Age Group&#39;</span>
<span class="p">)</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/cf7932e1ab2f274ca83e2cac032360d734df75fe3b0dc82892127d723cd5a031.png" src="../../_images/cf7932e1ab2f274ca83e2cac032360d734df75fe3b0dc82892127d723cd5a031.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ctr&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">facet_col</span><span class="o">=</span><span class="s1">&#39;os&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CTR Distribution by Group and OS&#39;</span>
<span class="p">)</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f9ad0a7860ec271fa31b8a6b78abccac7b384d47f3a848fecf3dadf58a165791.png" src="../../_images/f9ad0a7860ec271fa31b8a6b78abccac7b384d47f3a848fecf3dadf58a165791.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ctr&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">facet_col</span><span class="o">=</span><span class="s1">&#39;source&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CTR Distribution by Group and Source&#39;</span>
<span class="p">)</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/7adb51428b4ee7cab6da71ede3e849069e7210c3a28e99640ee40b38157aa60a.png" src="../../_images/7adb51428b4ee7cab6da71ede3e849069e7210c3a28e99640ee40b38157aa60a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ctr&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">facet_col</span><span class="o">=</span><span class="s1">&#39;country&#39;</span>
    <span class="p">,</span> <span class="n">facet_col_wrap</span><span class="o">=</span><span class="mi">3</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1200</span>
    <span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">1200</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CTR Distribution by Group and Country&#39;</span>
<span class="p">)</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">legend_y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/1f3c8f2cc7f6b3084116d9162a954c2fbc4ead4fa5f0c7c7ac0b68c0dc7c28ea.png" src="../../_images/1f3c8f2cc7f6b3084116d9162a954c2fbc4ead4fa5f0c7c7ac0b68c0dc7c28ea.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top_cities</span><span class="p">)]</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ctr&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">facet_col</span><span class="o">=</span><span class="s1">&#39;city&#39;</span>
    <span class="p">,</span> <span class="n">facet_col_wrap</span><span class="o">=</span><span class="mi">3</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1200</span>
    <span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">1200</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CTR Distribution by Group and Top Cities&#39;</span>
<span class="p">)</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">legend_y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/71be79b759354448b8f03bcd6adb3a4585be598e7deaa9c87884abba3356b5ae.png" src="../../_images/71be79b759354448b8f03bcd6adb3a4585be598e7deaa9c87884abba3356b5ae.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Bimodality appears in all dimensions.</p></li>
</ul>
</section>
<section id="daily-dynamics">
<h4>4.7.2.7 Daily Dynamics<a class="headerlink" href="#daily-dynamics" title="Link to this heading">#</a></h4>
<p>Let’s try to find the cause of the bimodality.</p>
<p>Let’s examine how metrics changed by day.</p>
<p>Aggregate data by day.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_for_fig</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_daily</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">],</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">users</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;nunique&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">views</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">likes</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;likes&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">df_for_fig</span><span class="p">[</span><span class="s1">&#39;ctr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_for_fig</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df_for_fig</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span>
<span class="n">df_for_fig</span><span class="p">[</span><span class="s1">&#39;views_per_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_for_fig</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df_for_fig</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
<span class="n">df_for_fig</span><span class="p">[</span><span class="s1">&#39;likes_per_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_for_fig</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df_for_fig</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Build charts.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="s1">&#39;likes&#39;</span><span class="p">,</span> <span class="s1">&#39;ctr&#39;</span><span class="p">,</span> <span class="s1">&#39;views_per_user&#39;</span><span class="p">,</span> <span class="s1">&#39;likes_per_user&#39;</span><span class="p">]:</span>
    <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
        <span class="n">df_for_fig</span>
        <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;date&#39;</span>
        <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">metric</span>
        <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
        <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span>
        <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2"> by Day&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f9f3027db35d136b4598533c1f25401b8edd7748b996adb9f7a8e5b032c7f9a2.png" src="../../_images/f9f3027db35d136b4598533c1f25401b8edd7748b996adb9f7a8e5b032c7f9a2.png" />
<img alt="../../_images/feaefa49361a2e2f07c3da584c82c723b7ed929160345f73ec853292704926cd.png" src="../../_images/feaefa49361a2e2f07c3da584c82c723b7ed929160345f73ec853292704926cd.png" />
<img alt="../../_images/e96aad6d92881749ce400a2af7da314a6b78377bc7ad1648a614c399b048e6b0.png" src="../../_images/e96aad6d92881749ce400a2af7da314a6b78377bc7ad1648a614c399b048e6b0.png" />
<img alt="../../_images/df4cd291f8ef505a75776bf74ec1f3fff290af766de0275efd1fcb8ef3230c8c.png" src="../../_images/df4cd291f8ef505a75776bf74ec1f3fff290af766de0275efd1fcb8ef3230c8c.png" />
<img alt="../../_images/f7c64c717d7c7a2f91cd5ca87b8ec2ffab8a647df571d66c53b3d04276338310.png" src="../../_images/f7c64c717d7c7a2f91cd5ca87b8ec2ffab8a647df571d66c53b3d04276338310.png" />
<img alt="../../_images/3ecf689b0050fa8dbc73ee2742cd39e8809a0c9e9724b162f8f6acfb4f3a549c.png" src="../../_images/3ecf689b0050fa8dbc73ee2742cd39e8809a0c9e9724b162f8f6acfb4f3a549c.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>The number of users grew daily, except for the last day.</p></li>
<li><p>CTR changed slightly.</p></li>
<li><p>Other metrics decreased until August 4, then increased.</p></li>
<li><p>The control group had slightly more users per day.</p></li>
<li><p>The number of views per day was similar between groups.</p></li>
<li><p>The number of likes in the test group was lower every day.</p></li>
<li><p>CTR was also lower every day, except the last day.</p></li>
</ul>
</section>
<section id="ctr-distribution-by-day">
<h4>4.7.2.8 CTR Distribution by Day<a class="headerlink" href="#ctr-distribution-by-day" title="Link to this heading">#</a></h4>
<p>Let’s examine how CTR was distributed each day.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df_daily</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ctr&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">facet_col</span><span class="o">=</span><span class="s1">&#39;date&#39;</span>
    <span class="p">,</span> <span class="n">facet_col_wrap</span><span class="o">=</span><span class="mi">3</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CTR by Group&#39;</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/8de83d9d771043e3266bcabeccfa272fbc312dbd8abd1963c40e52df14135666.png" src="../../_images/8de83d9d771043e3266bcabeccfa272fbc312dbd8abd1963c40e52df14135666.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Bimodality appears every day except the last day.</p></li>
</ul>
</section>
<section id="likes-and-views-segmentation">
<h4>4.7.2.9 Likes and Views Segmentation<a class="headerlink" href="#likes-and-views-segmentation" title="Link to this heading">#</a></h4>
<p>Let’s categorize likes and views and examine the distribution between segments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;views_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">]))</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;likes_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">]))</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;views_likes_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;views_segment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;likes_segment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s look at segment combinations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;views_likes_segment&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">700</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users by Group and Views-Likes Segment&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ac8c43b07c3c024f7c9cd92d5185fd40b78af079ef0e49a9f7777bbc42d4221c.png" src="../../_images/ac8c43b07c3c024f7c9cd92d5185fd40b78af079ef0e49a9f7777bbc42d4221c.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>In the control group:</p>
<ul>
<li><p>The most common are identical combinations. That is, those who viewed a lot and liked a lot, viewed moderately and liked moderately, viewed little and liked little.</p></li>
<li><p>This appears to be logical behavior. The number of likes and views is logically connected.</p></li>
<li><p>At the same time, segments where users viewed little but liked a lot, or viewed a lot but liked little, are small. This is also logical.</p></li>
</ul>
</li>
<li><p>In the test group:</p>
<ul>
<li><p>The distribution differs from the control group.</p></li>
<li><p>Segments containing “medium” are clearly more represented than in the control group.</p></li>
<li><p>Specifically, the high-medium, medium-high, low-medium, and medium-low segments.</p></li>
<li><p>The medium-medium segment decreased the most.</p></li>
</ul>
</li>
</ul>
<p>Let’s look at the segments separately.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;views_segment&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;likes_segment&#39;</span>
    <span class="p">,</span> <span class="n">facet_col</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users by Group, Views and Likes Segment&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/dfa82081fd74045afb4433e4fd4c24e6cb895e6f6a3af9bb8495ebaf2c5b5667.png" src="../../_images/dfa82081fd74045afb4433e4fd4c24e6cb895e6f6a3af9bb8495ebaf2c5b5667.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>In the control group, each segment dominates its own category. This appears to be logical behavior.</p></li>
<li><p>In the test group, the medium segment is also more represented than in the control group.</p></li>
</ul>
<p>Let’s examine CTR across segment combinations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ctr&#39;</span>
    <span class="p">,</span> <span class="n">facet_col</span><span class="o">=</span><span class="s1">&#39;views_likes_segment&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">facet_col_wrap</span><span class="o">=</span><span class="mi">3</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CTR by Views-Likes Segment&#39;</span>
<span class="p">)</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/c2335b8557e12ad21b5ba29178b844b5ff7cbe9de5443fe7027a5837f5d6c71b.png" src="../../_images/c2335b8557e12ad21b5ba29178b844b5ff7cbe9de5443fe7027a5837f5d6c71b.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>In the test group, signs of bimodality appear in the low-low and high-high segments. Also, in these segments, there is clearly less CTR around 20%, unlike the control group.</p></li>
<li><p>4 segments in the test group (high-medium, medium-high, low-medium, medium-low) are shifted relative to the control group:</p>
<ul>
<li><p>“Viewed a lot and liked moderately” and “Viewed moderately and liked little” form the left mode with CTR ~10%.</p></li>
<li><p>“Viewed moderately and liked a lot” and “Viewed little and liked moderately” form the right mode with CTR ~30%.</p></li>
</ul>
</li>
<li><p>As a result, polarization is clearly noticeable.</p></li>
</ul>
</section>
<section id="metric-interactions">
<h4>4.7.2.10 Metric Interactions<a class="headerlink" href="#metric-interactions" title="Link to this heading">#</a></h4>
<p><strong>At the User Level</strong></p>
<p>Let’s examine how metrics interact at the level of individual users.</p>
<p>Let’s look at likes and views.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span> <span class="o">=</span><span class="s1">&#39;views&#39;</span>
    <span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;likes&#39;</span>
    <span class="p">,</span> <span class="n">facet_col</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Likes vs Views by Group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0ec9f065acbc154b11b22b4c378661aab9bd0fc30cc4e14d08a2b247439020b3.png" src="../../_images/0ec9f065acbc154b11b22b4c378661aab9bd0fc30cc4e14d08a2b247439020b3.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>In the control group, the distribution is more clustered.</p></li>
<li><p>In the test group, a splitting is noticeable. This is also a sign of polarization.</p></li>
</ul>
</section>
</section>
<section id="statistical-analysis">
<h3>4.7.3 Statistical Analysis<a class="headerlink" href="#statistical-analysis" title="Link to this heading">#</a></h3>
<p>Testing hypothesis 1 is not meaningful because:</p>
<ul class="simple">
<li><p>The analysis revealed anomalies (bimodality) in the test group, indicating a high probability of technical problems during the experiment.</p></li>
<li><p>The main argument is that bimodality was present for the first 6 days but disappeared on the last day.</p></li>
<li><p>If the impact on the test group was consistent for all 7 days, this could not have happened. This is a clear signal of technical issues.</p></li>
</ul>
</section>
</section>
<section id="analysis-of-a-b-test-results-for-hypothesis-2">
<h2>4.8 Analysis of A/B Test Results for Hypothesis 2<a class="headerlink" href="#analysis-of-a-b-test-results-for-hypothesis-2" title="Link to this heading">#</a></h2>
<p>A/B test ran from <code class="docutils literal notranslate"><span class="pre">2025-08-02</span></code> to <code class="docutils literal notranslate"><span class="pre">2025-08-08</span></code></p>
<section id="id1">
<h3>4.8.1 Data Loading<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>Get the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> df &lt;&lt;
WITH user_first_visit AS (
    SELECT 
        user_id
        , min(toDate(time)) as first_date
    FROM 
        feed_actions
    GROUP BY 
        user_id
)
, exp_data as (
    SELECT 
        multiIf(
            exp_group = 0, &#39;control&#39;
            , exp_group = 3, &#39;test&#39;
            , &#39;unknown&#39;
        ) as group
        , argMax(multiIf(
            gender = 1, &#39;female&#39;
            , gender = 0, &#39;male&#39;
            , &#39;unknown&#39;
        ), time) as gender
        , argMax(multiIf(
            age &lt; 25, &#39;&lt;25&#39;
            , age between 25 and 40, &#39;25-40&#39;
            , age between 41 and 55, &#39;41-55&#39; 
            , age &gt;= 56, &#39;56+&#39;
            , &#39;unknown&#39;
        ), time) as age_group      
        , argMax(source, time) as source
        , argMax(os, time) as os
        , argMax(country, time) as country
        , argMax(city, time) as city
        , user_id
        , uniq(post_id) as posts
        , countIf(action = &#39;like&#39;) as likes
        , countIf(action = &#39;view&#39;) as views
        , ifNull(likes / nullIf(views, 0), 0) as ctr
        , uniq(toDate(time)) as days
    FROM
        feed_actions
    WHERE 
        toDate(time) BETWEEN &#39;2025-08-02&#39; and &#39;2025-08-08&#39;
        and exp_group in (0, 3)
    GROUP BY
        group
        , user_id
)
SELECT
        ed.*
        , if(ufv.first_date &gt;= &#39;2025-08-02&#39;, &#39;new&#39;, &#39;existing&#39;) as user_status
FROM
    exp_data ed
    LEFT JOIN user_first_visit ufv ON ed.user_id = ufv.user_id
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Returning data to local variable df
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> df_daily &lt;&lt;
SELECT 
    toDate(time) as date
    , user_id
    , uniq(post_id) as posts
    , countIf(action = &#39;like&#39;) as likes
    , countIf(action = &#39;view&#39;) as views
    , ifNull(likes / nullIf(views, 0), 0) as ctr    
    , multiIf(
        exp_group = 0, &#39;control&#39;
        , exp_group = 3, &#39;test&#39;
        , &#39;unknown&#39;
    ) as group
    , argMax(multiIf(
        gender = 1, &#39;female&#39;
        , gender = 0, &#39;male&#39;
        , &#39;unknown&#39;
    ), time) as gender
    , argMax(multiIf(
        age &lt; 25, &#39;&lt;25&#39;
        , age between 25 and 40, &#39;25-40&#39;
        , age between 41 and 55, &#39;41-55&#39; 
        , age &gt;= 56, &#39;56+&#39;
        , &#39;unknown&#39;
    ), time) as age_group    
    , argMax(source, time) as source
    , argMax(os, time) as os
    , argMax(country, time) as country
    , argMax(city, time) as city
FROM
    feed_actions
WHERE 
    toDate(time) BETWEEN &#39;2025-08-02&#39; and &#39;2025-08-08&#39;
    and exp_group in (0, 3)
GROUP BY
    date
    , user_id
    , group
ORDER BY
    date    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Returning data to local variable df_daily
</pre></div>
</div>
</div>
</div>
<p>Convert the date to datetime.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>group</th>
      <th>gender</th>
      <th>age_group</th>
      <th>source</th>
      <th>os</th>
      <th>country</th>
      <th>city</th>
      <th>user_id</th>
      <th>posts</th>
      <th>likes</th>
      <th>views</th>
      <th>ctr</th>
      <th>days</th>
      <th>user_status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>control</td>
      <td>male</td>
      <td>&lt;25</td>
      <td>ads</td>
      <td>iOS</td>
      <td>Russia</td>
      <td>Belgorod</td>
      <td>23121</td>
      <td>165</td>
      <td>38</td>
      <td>229</td>
      <td>0.17</td>
      <td>4</td>
      <td>existing</td>
    </tr>
    <tr>
      <th>1</th>
      <td>control</td>
      <td>female</td>
      <td>25-40</td>
      <td>ads</td>
      <td>iOS</td>
      <td>Russia</td>
      <td>Desnogorsk</td>
      <td>12756</td>
      <td>17</td>
      <td>1</td>
      <td>17</td>
      <td>0.06</td>
      <td>1</td>
      <td>existing</td>
    </tr>
    <tr>
      <th>2</th>
      <td>test</td>
      <td>male</td>
      <td>25-40</td>
      <td>organic</td>
      <td>iOS</td>
      <td>Russia</td>
      <td>Kushva</td>
      <td>133117</td>
      <td>36</td>
      <td>9</td>
      <td>43</td>
      <td>0.21</td>
      <td>1</td>
      <td>new</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_daily</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>user_id</th>
      <th>posts</th>
      <th>likes</th>
      <th>views</th>
      <th>ctr</th>
      <th>group</th>
      <th>gender</th>
      <th>age_group</th>
      <th>source</th>
      <th>os</th>
      <th>country</th>
      <th>city</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2025-08-02</td>
      <td>28055</td>
      <td>29</td>
      <td>9</td>
      <td>34</td>
      <td>0.26</td>
      <td>control</td>
      <td>male</td>
      <td>&lt;25</td>
      <td>ads</td>
      <td>Android</td>
      <td>Russia</td>
      <td>Kolpino</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2025-08-02</td>
      <td>121661</td>
      <td>29</td>
      <td>10</td>
      <td>29</td>
      <td>0.34</td>
      <td>control</td>
      <td>female</td>
      <td>25-40</td>
      <td>organic</td>
      <td>iOS</td>
      <td>Russia</td>
      <td>Novosibirsk</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2025-08-02</td>
      <td>317</td>
      <td>19</td>
      <td>5</td>
      <td>19</td>
      <td>0.26</td>
      <td>control</td>
      <td>male</td>
      <td>&lt;25</td>
      <td>ads</td>
      <td>Android</td>
      <td>Russia</td>
      <td>Novosibirsk</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>group           object
gender          object
age_group       object
source          object
os              object
country         object
city            object
user_id          int64
posts            int64
likes            int64
views            int64
ctr            float64
days             int64
user_status     object
dtype: object
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_daily</span><span class="o">.</span><span class="n">dtypes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>date         datetime64[ns]
user_id               int64
posts                 int64
likes                 int64
views                 int64
ctr                 float64
group                object
gender               object
age_group            object
source               object
os                   object
country              object
city                 object
dtype: object
</pre></div>
</div>
</div>
</div>
<p>Replace the data type for dimensions with categorical.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;os&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;os&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;user_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;user_status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;os&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;os&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_daily</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h3>4.8.2 Data Exploration<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<p>Explore DataFrame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">info</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Full duplicates: 0
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>unique</th>
      <th>top</th>
      <th>freq</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>group</th>
      <td>19922</td>
      <td>2</td>
      <td>test</td>
      <td>10002</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>gender</th>
      <td>19922</td>
      <td>2</td>
      <td>female</td>
      <td>11039</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>age_group</th>
      <td>19922</td>
      <td>4</td>
      <td>&lt;25</td>
      <td>10506</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>source</th>
      <td>19922</td>
      <td>2</td>
      <td>organic</td>
      <td>10702</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>os</th>
      <td>19922</td>
      <td>2</td>
      <td>Android</td>
      <td>12924</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>country</th>
      <td>19922</td>
      <td>11</td>
      <td>Russia</td>
      <td>17479</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>city</th>
      <td>19922</td>
      <td>2125</td>
      <td>Moscow</td>
      <td>2652</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>user_id</th>
      <td>19,922.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>76,111.20</td>
      <td>53,180.56</td>
      <td>200.00</td>
      <td>22,215.50</td>
      <td>109,629.00</td>
      <td>126,483.50</td>
      <td>140,806.00</td>
    </tr>
    <tr>
      <th>posts</th>
      <td>19,922.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>52.33</td>
      <td>30.11</td>
      <td>1.00</td>
      <td>29.00</td>
      <td>47.00</td>
      <td>71.00</td>
      <td>198.00</td>
    </tr>
    <tr>
      <th>likes</th>
      <td>19,922.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>14.66</td>
      <td>10.35</td>
      <td>0.00</td>
      <td>7.00</td>
      <td>12.00</td>
      <td>20.00</td>
      <td>89.00</td>
    </tr>
    <tr>
      <th>views</th>
      <td>19,922.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>67.24</td>
      <td>45.56</td>
      <td>1.00</td>
      <td>32.00</td>
      <td>57.00</td>
      <td>92.00</td>
      <td>359.00</td>
    </tr>
    <tr>
      <th>ctr</th>
      <td>19,922.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.23</td>
      <td>0.08</td>
      <td>0.00</td>
      <td>0.17</td>
      <td>0.21</td>
      <td>0.27</td>
      <td>0.80</td>
    </tr>
    <tr>
      <th>days</th>
      <td>19,922.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.94</td>
      <td>1.03</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>2.00</td>
      <td>3.00</td>
      <td>7.00</td>
    </tr>
    <tr>
      <th>user_status</th>
      <td>19922</td>
      <td>2</td>
      <td>existing</td>
      <td>14056</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>group</th>
      <th>gender</th>
      <th>age_group</th>
      <th>source</th>
      <th>os</th>
      <th>country</th>
      <th>city</th>
      <th>user_id</th>
      <th>posts</th>
      <th>likes</th>
      <th>views</th>
      <th>ctr</th>
      <th>days</th>
      <th>user_status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Dupl</th>
      <td>19920</td>
      <td>19920</td>
      <td>19918</td>
      <td>19920</td>
      <td>19920</td>
      <td>19911</td>
      <td>17797</td>
      <td>0</td>
      <td>19739</td>
      <td>19843</td>
      <td>19638</td>
      <td>17661</td>
      <td>19915</td>
      <td>19920</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>group</th>
      <th>gender</th>
      <th>age_group</th>
      <th>source</th>
      <th>os</th>
      <th>country</th>
      <th>city</th>
      <th>user_id</th>
      <th>posts</th>
      <th>likes</th>
      <th>views</th>
      <th>ctr</th>
      <th>days</th>
      <th>user_status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Miss</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>posts</th>
      <th>likes</th>
      <th>views</th>
      <th>ctr</th>
      <th>days</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Zeros</th>
      <td>0</td>
      <td>0</td>
      <td>101</td>
      <td>0</td>
      <td>101</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>posts</th>
      <th>likes</th>
      <th>views</th>
      <th>ctr</th>
      <th>days</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Negs</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Everything is fine.</p></li>
<li><p>Null values are present where they are acceptable.</p></li>
<li><p>There are no duplicates in user_id.</p></li>
<li><p>2 groups.</p></li>
<li><p>The minimum value in views is not 0.</p></li>
<li><p>There are no negative values.</p></li>
</ul>
<section id="id3">
<h4>4.8.2.1 Checking the Correctness of the Splitting<a class="headerlink" href="#id3" title="Link to this heading">#</a></h4>
<p>Check the correctness of splitting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">check_split_correctness</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== SPLITTING CORRECTNESS CHECK ===

1. USER UNIQUENESS CHECK:
Checking that there are no users present in both groups simultaneously.
✅ SUCCESS: No users found in both groups simultaneously.
   Number of users in both groups: 0

==================================================

2. GROUP SIZE BALANCE CHECK:

- H0: The number of users in test and control groups is equal
- H1: The number of users in test and control groups is not equal

We choose a significance level of 0.05.
We use the chi-square goodness-of-fit test.
Observed counts: {&#39;test&#39;: np.int64(10002), &#39;control&#39;: np.int64(9920)}
Expected counts (equal distribution): [np.float64(9961.0), np.float64(9961.0)]
Chi-square statistic: 0.3375
P-value: 0.5613
Percentage difference: 0.41%
✅ FAIL TO REJECT H0: The number of users in test and control groups is equal.
   Group sizes are balanced statistically.

==================================================
SUMMARY:
✅ ALL CHECKS PASSED: Splitting system appears to be working correctly.
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h4>4.8.2.2 User Distribution<a class="headerlink" href="#id4" title="Link to this heading">#</a></h4>
<p>Let’s examine how users are distributed across dimensions.</p>
<p><strong>By Test Group</strong></p>
<p>Let’s check how users are distributed across groups.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.1%&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users Distribution by Group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b8978e994cb6a267392e5e40907353065aff83816b7a2dc586c941e7d0e76275.png" src="../../_images/b8978e994cb6a267392e5e40907353065aff83816b7a2dc586c941e7d0e76275.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Approximately equal distribution across groups.</p></li>
</ul>
<p><strong>By User Status (New or Not)</strong></p>
<p>Let’s check how users are distributed by new user status.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;user_status&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.1%&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users Distribution by Group and Status&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/303388f2adbcabfab5bdfd30b1d5d1e8bdbe7a23619a114ab12ed61e2aa65be7.png" src="../../_images/303388f2adbcabfab5bdfd30b1d5d1e8bdbe7a23619a114ab12ed61e2aa65be7.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Both groups have about 29% new users (first appeared during the test).</p></li>
<li><p>The ratio between groups is approximately the same.</p></li>
</ul>
<p><strong>By Gender</strong></p>
<p>Let’s check how users are distributed by gender.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;gender&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.1%&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users Distribution by Group and Gender&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/14b9b686be3304d8c79418f57c5511882a0e3f2f3bbc36c3f7f9914d84d8d545.png" src="../../_images/14b9b686be3304d8c79418f57c5511882a0e3f2f3bbc36c3f7f9914d84d8d545.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>There are more women in both groups.</p></li>
<li><p>The ratio between groups is approximately the same.</p></li>
</ul>
<p><strong>By Age Group</strong></p>
<p>Let’s check how users are distributed across age groups.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;age_group&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.1%&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users Distribution by Group and Age Group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/4f6fa08029ea71f5cdff5192a3ff656ea746212eb2daff0f8cda555f89619127.png" src="../../_images/4f6fa08029ea71f5cdff5192a3ff656ea746212eb2daff0f8cda555f89619127.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Users under 25 are the largest group in both groups.</p></li>
<li><p>25-40 years old is the second largest.</p></li>
<li><p>The ratio in each age category is approximately the same between groups.</p></li>
</ul>
<p><strong>By OS</strong></p>
<p>Let’s check how users are distributed by OS.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;os&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.1%&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users Distribution by Group and OS&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/44ef886f08617552ca3e6f04c962999dd3d39f2ebb294ff04a7a64b0af9d9621.png" src="../../_images/44ef886f08617552ca3e6f04c962999dd3d39f2ebb294ff04a7a64b0af9d9621.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>There are more Android users in both groups.</p></li>
<li><p>The distribution between groups is approximately the same.</p></li>
</ul>
<p><strong>By Source</strong></p>
<p>Let’s check how users are distributed by traffic source.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;source&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.1%&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users Distribution by Group and Source&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/9b0ab1a1160ca3b76ca46ecb8f041d95f4934b5a8590114ab8a534fbe254d698.png" src="../../_images/9b0ab1a1160ca3b76ca46ecb8f041d95f4934b5a8590114ab8a534fbe254d698.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Organic traffic is slightly higher than paid traffic.</p></li>
<li><p>The distribution between groups is approximately the same.</p></li>
</ul>
<p><strong>By Country</strong></p>
<p>Let’s check how users are distributed by country.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;country&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.1%&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users Distribution by Group and Country&#39;</span>
    <span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">700</span>
<span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">legend_y</span><span class="o">=</span><span class="mf">1.06</span>
    <span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;categoryorder&#39;</span><span class="p">:</span> <span class="s1">&#39;total ascending&#39;</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/1b92fdf3fbd6b4434f901985971716a7e38973d1559582183c1b59819ef0b443.png" src="../../_images/1b92fdf3fbd6b4434f901985971716a7e38973d1559582183c1b59819ef0b443.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Most users are from Russia.</p></li>
<li><p>The distribution between groups is approximately the same.</p></li>
</ul>
<p><strong>By Top Cities</strong></p>
<p>Let’s check how users are distributed across top cities.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">top_cities</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top_cities</span><span class="p">)]</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;city&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">histnorm</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.1%&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Users Distribution by Group and Top Cities&#39;</span>
    <span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">700</span>
<span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">legend_y</span><span class="o">=</span><span class="mf">1.06</span>
    <span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;categoryorder&#39;</span><span class="p">:</span> <span class="s1">&#39;total ascending&#39;</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/a96147cc5f0111a5d68916d999695f5e2477bda3712d1f1b86779163fa0bb564.png" src="../../_images/a96147cc5f0111a5d68916d999695f5e2477bda3712d1f1b86779163fa0bb564.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Most users are from Moscow and St. Petersburg.</p></li>
<li><p>The distribution between groups is similar.</p></li>
</ul>
</section>
<section id="id5">
<h4>4.8.2.3 Distribution of Post Count<a class="headerlink" href="#id5" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;posts&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posts Distribution by Group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/14fd67990f025d817c75a9783f1d0f8f48c29aef3bb96d4416f862037a04b212.png" src="../../_images/14fd67990f025d817c75a9783f1d0f8f48c29aef3bb96d4416f862037a04b212.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Nothing unusual.</p></li>
</ul>
</section>
<section id="id6">
<h4>4.8.2.4 Distribution of Likes Count<a class="headerlink" href="#id6" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;likes&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Likes Distribution by Group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/8a56cbf397031a0146a58a13795577adbad08245a928bf8e3c0e873adf395c74.png" src="../../_images/8a56cbf397031a0146a58a13795577adbad08245a928bf8e3c0e873adf395c74.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Nothing unusual.</p></li>
</ul>
</section>
<section id="id7">
<h4>4.8.2.5 Distribution of Views<a class="headerlink" href="#id7" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;views&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Views Distribution by Group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/270ac41ec6d10e8bc99e7fc688cdb49bfaa69a2a74834f532da37e66d3888871.png" src="../../_images/270ac41ec6d10e8bc99e7fc688cdb49bfaa69a2a74834f532da37e66d3888871.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Nothing unusual.</p></li>
</ul>
</section>
<section id="id8">
<h4>4.8.2.6 Distribution of CTR<a class="headerlink" href="#id8" title="Link to this heading">#</a></h4>
<p>Let’s examine how CTR is distributed across groups.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ctr&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CTR Distribution by Group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/56110393d7d8d35f55bdb19b7755a57790d70e2f5dc3a3d717340755d3debb23.png" src="../../_images/56110393d7d8d35f55bdb19b7755a57790d70e2f5dc3a3d717340755d3debb23.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Distributions resemble normal.</p></li>
<li><p>The distribution in the test group is slightly shifted to the right.</p></li>
<li><p>No bimodality is observed.</p></li>
</ul>
</section>
<section id="id9">
<h4>4.8.2.7 CTR Distribution by Day<a class="headerlink" href="#id9" title="Link to this heading">#</a></h4>
<p>Let’s examine how CTR was distributed each day.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df_daily</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ctr&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">facet_col</span><span class="o">=</span><span class="s1">&#39;date&#39;</span>
    <span class="p">,</span> <span class="n">facet_col_wrap</span><span class="o">=</span><span class="mi">3</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CTR by Group&#39;</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/734d75d086917032c26977366abec9eae63dd168a2a95f634d43957a52cfedcc.png" src="../../_images/734d75d086917032c26977366abec9eae63dd168a2a95f634d43957a52cfedcc.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>No bimodality is observed on any day.</p></li>
</ul>
</section>
<section id="id10">
<h4>4.8.2.8 Metric Interactions<a class="headerlink" href="#id10" title="Link to this heading">#</a></h4>
<p><strong>At the User Level</strong></p>
<p>Let’s examine how metrics interact at the level of individual users.</p>
<p>Let’s look at likes and views.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span> <span class="o">=</span><span class="s1">&#39;views&#39;</span>
    <span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;likes&#39;</span>
    <span class="p">,</span> <span class="n">facet_col</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Likes vs Views by Group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/655883575a5fff5d5a2a80c47fb1d4fcfb4191334d7a477e9a9c38abe9581ff3.png" src="../../_images/655883575a5fff5d5a2a80c47fb1d4fcfb4191334d7a477e9a9c38abe9581ff3.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>No signs of bimodality are observed.</p></li>
</ul>
<p>Since no bimodality is detected, repeating a more detailed segment analysis is unnecessary.</p>
</section>
</section>
<section id="id11">
<h3>4.8.3 Statistical Analysis<a class="headerlink" href="#id11" title="Link to this heading">#</a></h3>
<p>To ensure our test controls the Type I error, let’s run an A/A test simulation. For this:</p>
<ul class="simple">
<li><p>Shuffle the groups and randomly split them into 2 groups.</p></li>
<li><p>Apply the delta method and save the p-value and the indicator of whether we reject the null hypothesis.</p></li>
<li><p>Set alpha to 0.05.</p></li>
<li><p>Repeat 10,000 times.</p></li>
<li><p>Calculate the percentage of cases where we rejected the null hypothesis. This will be our Type I error rate.</p></li>
<li><p>Also, plot the p-values.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">n_sim</span> <span class="o">=</span> <span class="mi">10_000</span>
<span class="n">indexes</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
<span class="n">control_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">])</span>
<span class="n">pvals</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_sim</span><span class="p">)):</span>    
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span>
    <span class="n">simulated_control_idx</span> <span class="o">=</span> <span class="n">indexes</span><span class="p">[:</span><span class="n">control_len</span><span class="p">]</span>
    <span class="n">simulated_test_idx</span> <span class="o">=</span> <span class="n">indexes</span><span class="p">[</span><span class="n">control_len</span><span class="p">:]</span>
    <span class="c1"># Create a temporary DataFrame with new groups</span>
    <span class="n">temp_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;simulated_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;control&#39;</span>
    <span class="n">temp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">simulated_test_idx</span><span class="p">,</span> <span class="s1">&#39;simulated_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span>    
    <span class="c1"># We recalculate the linearization based on the new “control”</span>
    <span class="n">simulated_global_ctr</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">temp_df</span><span class="p">[</span><span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;simulated_group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
        <span class="o">/</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;simulated_group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;simulated_linearized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">simulated_global_ctr</span>
    <span class="p">)</span>    
    <span class="c1"># T-test on the recalculated linearized metric</span>
    <span class="n">control_linearized</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;simulated_group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;simulated_linearized&#39;</span><span class="p">]</span>
    <span class="n">test_linearized</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;simulated_group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">][</span><span class="s1">&#39;simulated_linearized&#39;</span><span class="p">]</span>
    
    <span class="n">pval</span> <span class="o">=</span> <span class="n">pg_ttest</span><span class="p">(</span><span class="n">control_linearized</span><span class="p">,</span> <span class="n">test_linearized</span><span class="p">)</span>
    <span class="n">pvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pval</span><span class="p">)</span>    

<span class="n">false_positive_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10000/10000 [04:39&lt;00:00, 35.74it/s]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;False positive rate = </span><span class="si">{</span><span class="n">false_positive_rate</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plot_pvalue_ecdf</span><span class="p">(</span><span class="n">pvals</span><span class="p">,</span> <span class="s1">&#39;P-value Distribution and ECDF(AA-test)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False positive rate = 3.5%
</pre></div>
</div>
<img alt="../../_images/53f4793fd3d90aca85b92008892e4b9875192da7be63010787eea6e2fe6f0392.png" src="../../_images/53f4793fd3d90aca85b92008892e4b9875192da7be63010787eea6e2fe6f0392.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>FPR is close to 5%. As it should be.</p></li>
<li><p>The p-value distribution is close to uniform.</p></li>
<li><p>The ECDF slightly deviates from the 45-degree line.</p></li>
<li><p>The A/A test simulation showed that we control the Type I error rate on our data when using the delta method.</p></li>
</ul>
<p>Conduct the test.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ttest_linearized</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Linearized metric created using global CTR from control group
Global CTR: 0.2098
Difference in Global CTR (test - control): 0.0164
</pre></div>
</div>
<img alt="../../_images/7681a6e8543a2173fda0b28b8a4c55446f4a3af183c2934420a90b87d2f065c9.png" src="../../_images/7681a6e8543a2173fda0b28b8a4c55446f4a3af183c2934420a90b87d2f065c9.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Formulate hypotheses:
- H0: Mean value of the linearized metric in control and test groups are equal
- H1: Mean value of the linearized metric in control and test groups are not equal

Significance level: 0.05

Variance homogeneity test (Levene&#39;s test):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>W</th>
      <th>pval</th>
      <th>equal_var</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>levene</th>
      <td>0.14</td>
      <td>0.71</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Variances are equal (p-value ≥ 0.05) - using standard t-test without correction

Difference in means (test - control): 1.0948

T-test results:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>T</th>
      <th>dof</th>
      <th>alternative</th>
      <th>p-val</th>
      <th>CI95%</th>
      <th>cohen-d</th>
      <th>BF10</th>
      <th>power</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>T-test</th>
      <td>16.19</td>
      <td>19920</td>
      <td>two-sided</td>
      <td>0.00</td>
      <td>[0.96, 1.23]</td>
      <td>0.23</td>
      <td>4.882e+54</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Conclusion:
REJECT H0: p-value (0.0000) &lt; 0.05 - Significant difference detected
</pre></div>
</div>
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>p-value is below the significance level, therefore we reject the null hypothesis.</p></li>
<li><p>According to the t-test on linearized metric, there is a statistically significant difference in CTR between the groups.</p></li>
<li><p>In the test group, CTR is above than in the control group by 0.0164.</p></li>
</ul>
<p>Let’s calculate the power of our test assuming the difference truly exists, using the Monte Carlo method.</p>
<p>Calculate linearized metrics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_linearized</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="s1">&#39;likes&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">global_ctr</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
    <span class="o">/</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;linearized_likes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">global_ctr</span>
<span class="n">linearized_likes_control</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">linearized_likes</span>
<span class="n">linearized_likes_test</span> <span class="o">=</span> <span class="n">df_linearized</span><span class="p">[</span><span class="n">df_linearized</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">linearized_likes</span>
</pre></div>
</div>
</div>
</div>
<p>Calculate the power of T-test on the linearized metric.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">power</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">effect_sizes</span><span class="p">,</span> <span class="n">p_values</span> <span class="o">=</span> <span class="n">monte_carlo_power</span><span class="p">(</span>
    <span class="n">data_a</span><span class="o">=</span><span class="n">linearized_likes_control</span>
    <span class="p">,</span> <span class="n">data_b</span><span class="o">=</span><span class="n">linearized_likes_test</span>
    <span class="p">,</span> <span class="n">test_func</span><span class="o">=</span><span class="n">pg_ttest</span>
    <span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span>
    <span class="p">,</span> <span class="n">n_sim</span><span class="o">=</span><span class="mi">10_000</span>
    <span class="p">,</span> <span class="n">effect_size</span><span class="o">=</span><span class="n">mde_linearized</span>
<span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10000/10000 [01:18&lt;00:00, 127.25it/s]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;power&#39;: 1.0,
 &#39;effect_size&#39;: np.float64(0.7036443323727185),
 &#39;mean_effect&#39;: np.float64(1.7985948489653911),
 &#39;effect_std&#39;: np.float64(0.06710130747402315),
 &#39;mean_pvalue&#39;: np.float64(3.833305092065971e-114),
 &#39;n_sim&#39;: 10000,
 &#39;sample_size_a&#39;: 9920,
 &#39;sample_size_b&#39;: 10002}
</pre></div>
</div>
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>The power calculated by the Monte Carlo method is almost 100%.</p></li>
</ul>
<p>For interest, let’s also see how the p-value changed over days.
To do this, we will calculate cumulative likes and views for each user.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">daily_pvalue</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pvalue&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">df_daily</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="c1"># Get cumulative data up to current date</span>
    <span class="n">control</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_daily</span><span class="p">[(</span><span class="n">df_daily</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_daily</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">date</span><span class="p">)]</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)[[</span><span class="s1">&#39;likes&#39;</span><span class="p">,</span> <span class="s1">&#39;views&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">test</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_daily</span><span class="p">[(</span><span class="n">df_daily</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_daily</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">date</span><span class="p">)]</span>    
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)[[</span><span class="s1">&#39;likes&#39;</span><span class="p">,</span> <span class="s1">&#39;views&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="p">)</span>
    
    <span class="c1"># Skip if not enough data</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">daily_pvalue</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">,</span> <span class="s1">&#39;pvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">continue</span>
    
    <span class="c1"># Calculate linearized metric for current cumulative data</span>
    <span class="n">global_ctr</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">control</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="n">control_linearized</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">control</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">global_ctr</span>
    <span class="n">test_linearized</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">global_ctr</span>
    
    <span class="c1"># Perform t-test on linearized metric</span>
    <span class="n">pvalue</span> <span class="o">=</span> <span class="n">pg_ttest</span><span class="p">(</span><span class="n">test_linearized</span><span class="p">,</span> <span class="n">control_linearized</span><span class="p">)</span>
    
    <span class="n">daily_pvalue</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">,</span> <span class="s1">&#39;pvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s plot the graph.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
    <span class="n">daily_pvalue</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;date&#39;</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;pvalue&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;P-value by Day&#39;</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/faac95f0fd0c887b9b182f814557811ffca17296934d5cb000d0afabc13adf01.png" src="../../_images/faac95f0fd0c887b9b182f814557811ffca17296934d5cb000d0afabc13adf01.png" />
</div>
</div>
</section>
</section>
<section id="conclusion">
<h2>4.9 Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h2>
<section id="decision-on-rolling-out-the-new-algorithm-to-all-users">
<h3>4.9.1 Decision on Rolling Out the New Algorithm to All Users<a class="headerlink" href="#decision-on-rolling-out-the-new-algorithm-to-all-users" title="Link to this heading">#</a></h3>
<section id="hypothesis-1-similar-to-liked-posts-algorithm">
<h4>Hypothesis 1: “Similar to Liked Posts” Algorithm<a class="headerlink" href="#hypothesis-1-similar-to-liked-posts-algorithm" title="Link to this heading">#</a></h4>
<p><strong>Decision:</strong> Do not roll out this algorithm</p>
<ul class="simple">
<li><p>The analysis revealed anomalies (bimodality) in the test group, indicating a high probability of technical problems during the experiment</p></li>
<li><p>Bimodality was present for the first 6 days but disappeared on the last day, suggesting inconsistent treatment application</p></li>
<li><p>The presence of two distinct modes (10% and 30% CTR) vs historical 20% indicates potential system malfunctions</p></li>
</ul>
</section>
<section id="hypothesis-2-posts-liked-by-similar-users-algorithm">
<h4>Hypothesis 2: “Posts Liked by Similar Users” Algorithm<a class="headerlink" href="#hypothesis-2-posts-liked-by-similar-users-algorithm" title="Link to this heading">#</a></h4>
<p><strong>Decision:</strong> Recommend limited rollout</p>
<ul class="simple">
<li><p>No bimodality or technical anomalies observed in the test group</p></li>
<li><p>T-test on linearized metric shows statistically significant difference (p &lt; 0.05)</p></li>
<li><p>CTR in test group is 0.0164 percentage points higher than control group</p></li>
<li><p>Distribution patterns appear normal across all days and dimensions</p></li>
</ul>
</section>
</section>
<section id="detailed-a-b-test-results">
<h3>4.9.2 Detailed A/B Test Results<a class="headerlink" href="#detailed-a-b-test-results" title="Link to this heading">#</a></h3>
<section id="technical-issues-in-hypothesis-1">
<h4>Technical Issues in Hypothesis 1<a class="headerlink" href="#technical-issues-in-hypothesis-1" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>After examining the data, it was discovered that the test group has a bimodal distribution.</p></li>
<li><p>This indicates the possible presence of two different populations or technical problems.</p></li>
<li><p>The control group has a unimodal distribution.</p></li>
<li><p>The mean values differ only slightly.</p></li>
<li><p>The trough of the test group is located at the level of the control group’s mode.</p></li>
<li><p>Considering all this, performing hypothesis testing on the mean CTRs is considered incorrect. Comparing measures of central tendency would be generally invalid.</p></li>
<li><p>We would essentially be comparing the “average hospital temperature” in the test group with the mean in the control group.</p></li>
<li><p>It is necessary to identify the causes of the bimodality, eliminate them, and conduct a new experiment.</p></li>
<li><p>Furthermore, the modes of the test group (10% and 30%) indicate that:</p>
<ul>
<li><p>A significant portion of the audience is very dissatisfied with the new news recommendation mechanism (CTR 10% vs. historical 20%).</p></li>
<li><p>A significant portion of the audience is very satisfied with the new news recommendation mechanism (CTR 30% vs. historical 20%).</p></li>
</ul>
</li>
<li><p>The suspiciously strong deviations in CTR (two modes in the test group) from historical levels may indicate that:</p>
<ul>
<li><p>Either something broke in the test group during the experiment,</p></li>
<li><p>Or some users really liked it while others really disliked it, which is less likely.</p></li>
</ul>
</li>
<li><p>One could accept that users started liking posts less if they were shown irrelevant posts.</p></li>
<li><p>But for CTR to increase from 20% to 30% is highly unlikely. It looks more like a bug.</p></li>
<li><p>The hypothesis of technical problems is also supported by the last day, when the bimodality disappeared.</p>
<ul>
<li><p>If our new recommendation system factor was applied consistently to the test group for all 7 days, this should not have happened.</p></li>
</ul>
</li>
</ul>
<p>After categorizing likes and views and combining segments into combinations, it was discovered:</p>
<ul class="simple">
<li><p>The distribution across segments in the test group differs from the control group.</p></li>
<li><p>Segments containing “medium” are clearly more represented than in the control group (high-medium, medium-high, low-medium, and medium-low segments).</p></li>
<li><p>The medium-medium segment decreased the most.</p></li>
<li><p>Signs of bimodality appear in the low-low and high-high segments. Also, in these segments, CTR around 20% is clearly less frequent compared to the control group.</p></li>
<li><p>As a result, 4 segments (high-medium, medium-high, low-medium, medium-low) strongly influence the bimodality.</p>
<ul>
<li><p>“Viewed a lot and liked moderately” and “Viewed moderately and liked little” form the left mode with CTR ~10%.</p></li>
<li><p>“Viewed moderately and liked a lot” and “Viewed little and liked moderately” form the right mode with CTR ~30%.</p></li>
</ul>
</li>
<li><p>And the medium-medium segment became smaller.</p></li>
<li><p>Clear signs of polarization are present.</p></li>
</ul>
</section>
<section id="valid-results-in-hypothesis-2">
<h4>Valid Results in Hypothesis 2<a class="headerlink" href="#valid-results-in-hypothesis-2" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Control and test groups show comparable user distribution across all dimensions</p></li>
<li><p>Unimodal CTR distributions in both groups indicate consistent treatment application</p></li>
<li><p>Statistical testing is valid and reliable for this hypothesis</p></li>
<li><p>The observed CTR improvement of 0.0164 represents a meaningful engagement increase</p></li>
</ul>
</section>
</section>
</section>
<section id="recommendations">
<h2>4.10 Recommendations<a class="headerlink" href="#recommendations" title="Link to this heading">#</a></h2>
<section id="for-hypothesis-1">
<h3>For Hypothesis 1:<a class="headerlink" href="#for-hypothesis-1" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Investigate the causes of bimodality in the test group.</p>
<ul>
<li><p>It strongly resembles technical problems, given the presence of two modes around 10% and 30%.</p></li>
<li><p>Meanwhile, the historical CTR is around 20%.</p></li>
<li><p>This is a large deviation that is unlikely to occur under normal conditions.</p></li>
</ul>
</li>
<li><p>Take into account that bimodality was absent on the last test day. This might help in identifying the problem.</p></li>
</ul>
</section>
<section id="for-hypothesis-2">
<h3>For Hypothesis 2:<a class="headerlink" href="#for-hypothesis-2" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Gradually roll out the “Posts Liked by Similar Users” algorithm to increasingly larger audience segments</p></li>
<li><p>Maintain close monitoring of key metrics and user behavior throughout the rollout process</p></li>
</ul>
</section>
</section>
<section id="supplement-1-additional-tests">
<h2>4.11 Supplement 1. Additional Tests<a class="headerlink" href="#supplement-1-additional-tests" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Let’s compare different statistical tests on our data for practice purposes.</p></li>
<li><p>We will conduct tests for Hypothesis 1 to study how bimodality affects different statistical methods.</p></li>
<li><p>Note that testing one hypothesis with multiple tests increases the Type I error rate.</p></li>
<li><p>However, since we won’t make decisions based on these tests, multiple testing correction is not required.</p></li>
<li><p>This analysis is for research and educational purposes only.</p></li>
</ul>
<p>Let’s create auxiliary variables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_for_supplement</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;smoothed_ctr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">apply_smoothed_ctr</span><span class="p">,</span> <span class="n">include_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">df_control</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">]</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span>
<span class="n">ctr_control</span> <span class="o">=</span> <span class="n">df_control</span><span class="o">.</span><span class="n">ctr</span>
<span class="n">ctr_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">ctr</span>
<span class="n">smoothed_ctr_control</span> <span class="o">=</span> <span class="n">df_control</span><span class="p">[</span><span class="s1">&#39;smoothed_ctr&#39;</span><span class="p">]</span>
<span class="n">smoothed_ctr_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;smoothed_ctr&#39;</span><span class="p">]</span>
<span class="n">observed_diff</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">df_control</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">df_control</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="variance-equality-test">
<h3>Variance Equality Test<a class="headerlink" href="#variance-equality-test" title="Link to this heading">#</a></h3>
<p>Let’s test variance equality for regular and smoothed CTR.</p>
<p><strong>Regular CTR</strong></p>
<p>Test variance equality using Levene’s test.</p>
<ul class="simple">
<li><p>H0: Variances in control and test groups are equal</p></li>
<li><p>H1: Variances in control and test groups are not equal</p></li>
</ul>
<p>Set significance level to 0.05.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pg</span><span class="o">.</span><span class="n">homoscedasticity</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dv</span><span class="o">=</span><span class="s1">&#39;ctr&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>W</th>
      <th>pval</th>
      <th>equal_var</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>levene</th>
      <td>2,757.79</td>
      <td>0.00</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Result:</strong></p>
<ul class="simple">
<li><p>At significance level 0.05, we reject the null hypothesis of equal variances since p-value is less than the significance level.</p></li>
</ul>
<p><strong>Smoothed CTR</strong></p>
<p>Test variance equality using Levene’s test.</p>
<ul class="simple">
<li><p>H0: Variances in control and test groups are equal</p></li>
<li><p>H1: Variances in control and test groups are not equal</p></li>
</ul>
<p>Set significance level to 0.05.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pg</span><span class="o">.</span><span class="n">homoscedasticity</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dv</span><span class="o">=</span><span class="s1">&#39;smoothed_ctr&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>W</th>
      <th>pval</th>
      <th>equal_var</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>levene</th>
      <td>3,120.78</td>
      <td>0.00</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Result:</strong></p>
<ul class="simple">
<li><p>At significance level 0.05, we reject the null hypothesis of equal variances since p-value is less than the significance level.</p></li>
</ul>
</section>
<section id="t-test">
<h3>T-test<a class="headerlink" href="#t-test" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Although the t-test is quite robust, and we don’t have strong asymmetry or outliers, the bimodality ruins everything.</p></li>
<li><p>The t-test cannot be applied with obvious bimodality since we essentially don’t have one measure of central tendency.</p></li>
<li><p>Bimodality indicates the presence of not one, but two underlying populations.</p></li>
<li><p>As a result, the t-test compares the “average hospital temperature”</p></li>
<li><p>Moreover, we would be comparing user-level CTR, not global CTR</p></li>
</ul>
<p>Formulate null and alternative hypotheses.</p>
<ul class="simple">
<li><p>H0: Mean user-level CTR in control and test groups are equal</p></li>
<li><p>H1: Mean user-level CTR in control and test groups are not equal</p></li>
</ul>
<p>Since variances are not equal, we will use Welch’s test.</p>
<p>Let’s examine the difference in mean CTR values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ctr_test</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctr_control</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(-0.0006723047962903239)
</pre></div>
</div>
</div>
</div>
<p>Set significance level to 0.05.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span><span class="n">ctr_test</span><span class="p">,</span> <span class="n">ctr_control</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>T</th>
      <th>dof</th>
      <th>alternative</th>
      <th>p-val</th>
      <th>CI95%</th>
      <th>cohen-d</th>
      <th>BF10</th>
      <th>power</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>T-test</th>
      <td>-0.41</td>
      <td>15,811.23</td>
      <td>two-sided</td>
      <td>0.69</td>
      <td>[-0.0, 0.0]</td>
      <td>0.01</td>
      <td>0.017</td>
      <td>0.07</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>p-value is higher than the significance level, therefore there are no grounds to reject the null hypothesis.</p></li>
<li><p>According to Welch’s test, there are no statistically significant differences in CTR between groups.</p></li>
<li><p>Note that pingouin shows very low power.</p></li>
</ul>
</section>
<section id="t-test-on-smoothed-ctr">
<h3>T-test on Smoothed CTR<a class="headerlink" href="#t-test-on-smoothed-ctr" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Smoothing doesn’t solve the problems of the regular t-test.</p></li>
<li><p>In this case, it’s better not to perform a t-test on smoothed CTR.</p></li>
</ul>
<p>Let’s examine the distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;smoothed_ctr&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Smoothed CTR Distribution by Group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2870063b52e15eb53c858e9b75fa9c1940fcaa648be5df7733ba803ebdd4086d.png" src="../../_images/2870063b52e15eb53c858e9b75fa9c1940fcaa648be5df7733ba803ebdd4086d.png" />
</div>
</div>
<p>Formulate null and alternative hypotheses.</p>
<ul class="simple">
<li><p>H0: Mean smoothed user-level CTR in control and test groups are equal</p></li>
<li><p>H1: Mean smoothed user-level CTR in control and test groups are not equal</p></li>
</ul>
<p>Since variances are not equal, we will use Welch’s test.</p>
<p>Let’s examine the difference in mean smoothed CTR values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smoothed_ctr_test</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">smoothed_ctr_control</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(-0.002771774229591073)
</pre></div>
</div>
</div>
</div>
<p>Set significance level to 0.05.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span><span class="n">smoothed_ctr_test</span><span class="p">,</span> <span class="n">smoothed_ctr_control</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>T</th>
      <th>dof</th>
      <th>alternative</th>
      <th>p-val</th>
      <th>CI95%</th>
      <th>cohen-d</th>
      <th>BF10</th>
      <th>power</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>T-test</th>
      <td>-1.95</td>
      <td>15,580.63</td>
      <td>two-sided</td>
      <td>0.05</td>
      <td>[-0.01, 0.0]</td>
      <td>0.03</td>
      <td>0.106</td>
      <td>0.50</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>p-value is higher than or equal to the significance level, therefore there are no grounds to reject the null hypothesis.</p></li>
<li><p>According to Welch’s test, there are no statistically significant differences in smoothed CTR between groups.</p></li>
<li><p>Smoothing increased the t-test power and decreased the p-value.</p></li>
<li><p>Most likely, smoothing reduced variance in each group, consequently increasing power and decreasing p-value.</p></li>
<li><p>The t-test is highly sensitive to variance - the smaller the variance, the more powerful it is.</p></li>
</ul>
</section>
<section id="mann-whitney-test">
<h3>Mann-Whitney Test<a class="headerlink" href="#mann-whitney-test" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The Mann-Whitney test should not be used to compare measures of central tendency.</p></li>
<li><p>Especially with different variances, as it becomes unpredictable.</p>
<ul>
<li><p>This is easily verified by simulating two normal distributions with the same mean but different variances.</p></li>
</ul>
</li>
<li><p>This is logical since it compares distributions, not means or medians. To be more precise, it tests for statistical dominance of one sample over another.</p></li>
<li><p>The exception is when one sample is obtained by shifting the other, they have similar distributions, and variances are equal.</p>
<ul>
<li><p>In this case, it works well and will show if one sample statistically dominates the other.</p></li>
<li><p>But in practice, this is a rare case.</p></li>
</ul>
</li>
</ul>
<p>Formulate null and alternative hypotheses.</p>
<ul class="simple">
<li><p>H0: The probability that a randomly selected user-level CTR value from the test group will exceed a randomly selected user-level CTR value from the control group equals the probability of the opposite outcome.</p></li>
<li><p>H1: The probability that a randomly selected user-level CTR value from the test group will exceed a randomly selected user-level CTR value from the control group is not equal to 0.5.</p></li>
</ul>
<p>Set significance level to 0.05.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pg</span><span class="o">.</span><span class="n">mwu</span><span class="p">(</span><span class="n">ctr_test</span><span class="p">,</span> <span class="n">ctr_control</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>U-val</th>
      <th>alternative</th>
      <th>p-val</th>
      <th>RBC</th>
      <th>CLES</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>MWU</th>
      <td>43,777,627.00</td>
      <td>two-sided</td>
      <td>0.00</td>
      <td>-0.12</td>
      <td>0.44</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>p-value is below the significance level, therefore there are grounds to reject the null hypothesis.</p></li>
<li><p>According to the Mann-Whitney test, one of the CTR distributions statistically significantly dominates the other.</p></li>
<li><p>This is logical since the test group has a bimodal distribution with a trough located at the peak of the control group.</p></li>
<li><p>Mann-Whitney detected substantial differences in the distributions.</p></li>
<li><p>However, this result provides little business value.</p></li>
</ul>
</section>
<section id="bootstrap-on-user-level-ctr">
<h3>Bootstrap on User-Level CTR<a class="headerlink" href="#bootstrap-on-user-level-ctr" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Bimodality is not a problem for bootstrap. In this case, it can be applied.</p></li>
<li><p>However, this doesn’t change the fact that the mean will represent the “hospital temperature average” due to bimodality. But this is not a bootstrap problem.</p></li>
<li><p>Bootstrap on user-level CTR with bimodality is better not to apply.</p></li>
</ul>
<p>Formulate null and alternative hypotheses.</p>
<ul class="simple">
<li><p>H0: Mean user-level CTR in control and test groups are equal</p></li>
<li><p>H1: Mean user-level CTR in control and test groups are not equal</p></li>
</ul>
<p>Set significance level to 0.05 (95% confidence interval).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">statistic</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">boot_res</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">bootstrap</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="n">ctr_test</span><span class="p">,</span> <span class="n">ctr_control</span><span class="p">),</span> 
    <span class="n">statistic</span><span class="o">=</span><span class="n">statistic</span><span class="p">,</span>
    <span class="n">batch</span><span class="o">=</span><span class="mi">1000</span>
<span class="p">)</span>
<span class="n">ci_low</span> <span class="o">=</span> <span class="n">boot_res</span><span class="o">.</span><span class="n">confidence_interval</span><span class="o">.</span><span class="n">low</span>
<span class="n">ci_high</span> <span class="o">=</span> <span class="n">boot_res</span><span class="o">.</span><span class="n">confidence_interval</span><span class="o">.</span><span class="n">high</span>
<span class="n">effect_size</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">compute_effsize</span><span class="p">(</span><span class="n">ctr_test</span><span class="p">,</span> <span class="n">ctr_control</span><span class="p">,</span> <span class="n">eftype</span><span class="o">=</span><span class="s1">&#39;cohen&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Difference in means (test - control): </span><span class="si">{</span><span class="n">statistic</span><span class="p">(</span><span class="n">ctr_test</span><span class="p">,</span><span class="w"> </span><span class="n">ctr_control</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;95% confidence interval: [</span><span class="si">{</span><span class="n">ci_low</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">ci_high</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Effect size: </span><span class="si">{</span><span class="n">effect_size</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Difference in means (test - control): -0.00
95% confidence interval: [-0.00, 0.00]
Effect size: -0.01
</pre></div>
</div>
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Zero falls within the 95% confidence interval, therefore there are no grounds to reject the null hypothesis.</p></li>
<li><p>Bootstrap did not find statistically significant differences in CTR between groups.</p></li>
<li><p>According to bootstrap, the true effect with 95% probability lies in the range from a small decrease to a small increase in CTR.</p></li>
<li><p>There are no complaints about the bootstrap result. It did its job. It doesn’t account for bimodality.</p></li>
</ul>
</section>
<section id="bootstrap-of-global-ctr">
<h3>Bootstrap of Global CTR<a class="headerlink" href="#bootstrap-of-global-ctr" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>This test should not have problems with bimodality.</p></li>
<li><p>Disadvantages: computationally intensive on large data and inability to apply variance reduction methods.</p></li>
</ul>
<p>Formulate null and alternative hypotheses.</p>
<ul class="simple">
<li><p>H0: Mean global CTR in control and test groups are equal</p></li>
<li><p>H1: Mean global CTR in control and test groups are not equal</p></li>
</ul>
<p>Set significance level to 0.05 (95% confidence interval).</p>
<p>Create a function for bootstrap.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">bootstrap_global_ctr_diff</span><span class="p">(</span>
    <span class="n">likes_test</span><span class="p">,</span> <span class="n">views_test</span>
    <span class="p">,</span> <span class="n">likes_control</span>
    <span class="p">,</span> <span class="n">views_control</span>
    <span class="p">,</span> <span class="n">n_bootstraps</span><span class="o">=</span><span class="mi">10_000</span>
    <span class="p">,</span> <span class="n">confidence_level</span><span class="o">=</span><span class="mf">0.95</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bootstrap for difference in global CTR&quot;&quot;&quot;</span>
    <span class="n">n_test</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">likes_test</span><span class="p">)</span>
    <span class="n">n_control</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">likes_control</span><span class="p">)</span>
    
    <span class="c1"># Array to store bootstrap statistics</span>
    <span class="n">bs_diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bootstraps</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bootstraps</span><span class="p">):</span>
        <span class="c1"># Bootstrap for test group</span>
        <span class="n">idx_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_test</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_test</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">likes_bs_test</span> <span class="o">=</span> <span class="n">likes_test</span><span class="p">[</span><span class="n">idx_test</span><span class="p">]</span>
        <span class="n">views_bs_test</span> <span class="o">=</span> <span class="n">views_test</span><span class="p">[</span><span class="n">idx_test</span><span class="p">]</span>
        <span class="n">ctr_bs_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likes_bs_test</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">views_bs_test</span><span class="p">)</span>
        
        <span class="c1"># Bootstrap for control group</span>
        <span class="n">idx_control</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_control</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_control</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">likes_bs_control</span> <span class="o">=</span> <span class="n">likes_control</span><span class="p">[</span><span class="n">idx_control</span><span class="p">]</span>
        <span class="n">views_bs_control</span> <span class="o">=</span> <span class="n">views_control</span><span class="p">[</span><span class="n">idx_control</span><span class="p">]</span>
        <span class="n">ctr_bs_control</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likes_bs_control</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">views_bs_control</span><span class="p">)</span>
        
        <span class="c1"># Save the difference</span>
        <span class="n">bs_diffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctr_bs_test</span> <span class="o">-</span> <span class="n">ctr_bs_control</span>
    
    <span class="c1"># Calculate confidence interval (percentile method)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span> <span class="n">confidence_level</span>
    <span class="n">ci_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">bs_diffs</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ci_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">bs_diffs</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">observed_diff</span><span class="p">,</span> <span class="n">ci_low</span><span class="p">,</span> <span class="n">ci_high</span><span class="p">,</span> <span class="n">bs_diffs</span>
</pre></div>
</div>
</div>
</div>
<p>Run the test.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">observed_diff</span><span class="p">,</span> <span class="n">ci_low</span><span class="p">,</span> <span class="n">ci_high</span><span class="p">,</span> <span class="n">bs_diffs</span> <span class="o">=</span> <span class="n">bootstrap_global_ctr_diff</span><span class="p">(</span>
    <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
    <span class="n">df_control</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">df_control</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Difference in global CTR (test - control): </span><span class="si">{</span><span class="n">observed_diff</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;95% confidence interval: [</span><span class="si">{</span><span class="n">ci_low</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">ci_high</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Difference in global CTR (test - control): -0.009354
95% confidence interval: [-0.012401, -0.006302]
</pre></div>
</div>
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Zero does not fall within the 95% confidence interval, therefore we reject the null hypothesis.</p></li>
<li><p>Bootstrap found statistically significant differences in global CTR between groups.</p></li>
</ul>
</section>
<section id="poisson-bootstrap">
<h3>Poisson Bootstrap<a class="headerlink" href="#poisson-bootstrap" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Key assumption: data follows Poisson distribution.</p></li>
<li><p>Extremely sensitive to violations of Poisson assumption.</p></li>
<li><p>If variance is not equal to the mean, it can produce biased and overly narrow confidence intervals, leading to false significances.</p></li>
<li><p>This is because in Poisson distribution, the parameter <span class="math notranslate nohighlight">\(\lambda\)</span> defines both the mean and variance.</p></li>
<li><p>If Poisson assumption is violated, it’s better to use modified Poisson bootstrap methods.</p></li>
</ul>
<p>Formulate null and alternative hypotheses.</p>
<ul class="simple">
<li><p>H0: Mean CTR in control and test groups are equal</p></li>
<li><p>H1: Mean CTR in control and test groups are not equal</p></li>
</ul>
<p>Set significance level to 0.05 (95% confidence interval).</p>
<p>Compare variance and means.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">likes_mean_control</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">likes_var_control</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
<span class="n">views_mean_control</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">views_var_control</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>

<span class="n">likes_mean_test</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">likes_var_test</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
<span class="n">views_mean_test</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">views_var_test</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>

<span class="n">df_mean_var</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Group&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Control&#39;</span><span class="p">,</span> <span class="s1">&#39;Test&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Mean Likes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">likes_mean_control</span><span class="p">,</span> <span class="n">likes_mean_test</span><span class="p">],</span>
    <span class="s1">&#39;Variance Likes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">likes_var_control</span><span class="p">,</span> <span class="n">likes_var_test</span><span class="p">],</span>
    <span class="s1">&#39;Mean Views&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">views_mean_control</span><span class="p">,</span> <span class="n">views_mean_test</span><span class="p">],</span>
    <span class="s1">&#39;Variance Views&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">views_var_control</span><span class="p">,</span> <span class="n">views_var_test</span><span class="p">]</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_mean_var</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Group</th>
      <th>Mean Likes</th>
      <th>Variance Likes</th>
      <th>Mean Views</th>
      <th>Variance Views</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Control</td>
      <td>14.01</td>
      <td>97.08</td>
      <td>66.82</td>
      <td>2,050.44</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Test</td>
      <td>13.37</td>
      <td>139.77</td>
      <td>66.77</td>
      <td>2,065.80</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Variance and mean values differ significantly in both groups.</p></li>
<li><p>Therefore, it’s better not to apply classical Poisson bootstrap to our data.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">poisson_bootstrap</span><span class="p">(</span><span class="n">likes1</span><span class="p">,</span> <span class="n">views1</span><span class="p">,</span> <span class="n">likes2</span><span class="p">,</span> <span class="n">views2</span><span class="p">,</span> <span class="n">n_bootstrap</span><span class="o">=</span><span class="mi">9999</span><span class="p">):</span>
    <span class="c1"># Generate Poisson weights (λ=1) for both groups</span>
    <span class="n">weights1</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">((</span><span class="n">n_bootstrap</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">likes1</span><span class="p">)))</span>
    <span class="n">weights2</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">((</span><span class="n">n_bootstrap</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">likes2</span><span class="p">)))</span>
    <span class="c1"># Calculate global CTR for each bootstrap iteration</span>
    <span class="n">globalCTR1</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights1</span> <span class="o">*</span> <span class="n">likes1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">weights1</span> <span class="o">*</span> <span class="n">views1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">globalCTR2</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights2</span> <span class="o">*</span> <span class="n">likes2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">weights2</span> <span class="o">*</span> <span class="n">views2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">globalCTR1</span><span class="p">,</span> <span class="n">globalCTR2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">likes_control</span> <span class="o">=</span> <span class="n">df_control</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">views_control</span> <span class="o">=</span> <span class="n">df_control</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">likes_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">likes</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">views_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="n">ctr_control_poisson</span><span class="p">,</span> <span class="n">ctr_test_poisson</span> <span class="o">=</span> <span class="n">poisson_bootstrap</span><span class="p">(</span><span class="n">likes_control</span><span class="p">,</span> <span class="n">views_control</span><span class="p">,</span> <span class="n">likes_test</span><span class="p">,</span> <span class="n">views_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ctr_poisson_diff</span> <span class="o">=</span> <span class="n">ctr_test_poisson</span> <span class="o">-</span> <span class="n">ctr_control_poisson</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;95% percentile CI: [</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">ctr_poisson_diff</span><span class="p">,</span><span class="w"> </span><span class="mf">0.025</span><span class="p">),</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">ctr_poisson_diff</span><span class="p">,</span><span class="w"> </span><span class="mf">0.975</span><span class="p">)</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>95% percentile CI: [(np.float64(-0.012437694691009162), np.float64(-0.006224920648052628))]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ctr_poisson_diff</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Poisson Bootstrap Distribution&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b71b61da7e7170c026747ce26f8e1626b26e17bd3125f0e4f3cf0132c93f6b78.png" src="../../_images/b71b61da7e7170c026747ce26f8e1626b26e17bd3125f0e4f3cf0132c93f6b78.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Zero does not fall within the 95% confidence interval, therefore we reject the null hypothesis.</p></li>
<li><p>Poisson bootstrap found statistically significant differences in CTR between groups.</p></li>
<li><p>The main problem is the violation of Poisson assumption.</p></li>
</ul>
</section>
<section id="delta-method">
<h3>Delta Method<a class="headerlink" href="#delta-method" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The Delta method is similar to a t-test, but the variance estimate is calculated using a special formula for the ratio of two random variables.</p></li>
<li><p>The Delta method is used to address the problem of data dependency.</p></li>
<li><p>It allows comparing non-user-level metrics using aggregated data.</p></li>
<li><p>This method involves finding (approximating) the variance of a ratio metric.</p></li>
<li><p>It significantly outperforms bootstrap in terms of computational complexity and speed.</p></li>
<li><p>Disadvantages of the Delta method:</p>
<ul>
<li><p>Inability to apply variance reduction techniques</p></li>
<li><p>Because we are still working with a ratio metric, not a user-level metric.</p></li>
</ul>
</li>
</ul>
<p>Let’s write a function for the delta method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">check_delta_method</span><span class="p">(</span><span class="n">likes_control</span><span class="p">,</span> <span class="n">views_control</span><span class="p">,</span> <span class="n">likes_test</span><span class="p">,</span> <span class="n">views_test</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hypothesis testing using the delta method.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">control_data</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;control&#39;</span><span class="p">,</span> <span class="n">likes_control</span><span class="p">,</span> <span class="n">views_control</span><span class="p">)</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">likes_test</span><span class="p">,</span> <span class="n">views_test</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">likes</span><span class="p">,</span> <span class="n">views</span> <span class="ow">in</span> <span class="p">[</span><span class="n">control_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">likes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">views</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The lengths of the likes and views arrays do not match for the group </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">n_users</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">views</span><span class="p">)</span>
        <span class="n">mean_x</span><span class="p">,</span> <span class="n">mean_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">likes</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">views</span><span class="p">)</span>
        <span class="n">var_x</span><span class="p">,</span> <span class="n">var_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">likes</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cov_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">likes</span><span class="p">,</span> <span class="n">views</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Point estimate of the metric.</span>
        <span class="n">pe_metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likes</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">views</span><span class="p">)</span>
        <span class="c1"># Variance estimate of the metric.</span>
        <span class="n">var_metric</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">var_x</span> <span class="o">/</span> <span class="n">mean_y</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">mean_x</span> <span class="o">/</span> <span class="n">mean_y</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">cov_xy</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">mean_x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">mean_y</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">var_y</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">n_users</span>
        <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;pe_metric_</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe_metric</span>
        <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;var_metric_</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_metric</span>
    <span class="n">var_total</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;var_metric_control&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;var_metric_test&#39;</span><span class="p">]</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;pe_metric_test&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;pe_metric_control&#39;</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_total</span><span class="p">)</span>
    <span class="n">pvalue</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">pvalue</span>
</pre></div>
</div>
</div>
</div>
<p>Formulate the null and alternative hypotheses.</p>
<ul class="simple">
<li><p>H0: The mean global CTR in the control and test groups are equal.</p></li>
<li><p>H1: The mean global CTR in the control and test groups are not equal.</p></li>
</ul>
<p>Set the significance level to 0.05.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>
</pre></div>
</div>
</div>
</div>
<p>Run the test.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">likes_control</span><span class="p">,</span> <span class="n">views_control</span> <span class="o">=</span> <span class="n">df_control</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">],</span> <span class="n">df_control</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span>
<span class="n">likes_test</span><span class="p">,</span> <span class="n">views_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">],</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span>
<span class="n">pvalue</span> <span class="o">=</span> <span class="n">check_delta_method</span><span class="p">(</span><span class="n">likes_control</span><span class="p">,</span> <span class="n">views_control</span><span class="p">,</span> <span class="n">likes_test</span><span class="p">,</span> <span class="n">views_test</span><span class="p">)</span>
<span class="k">if</span> <span class="n">pvalue</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reject the null hypothesis.</span><span class="se">\n</span><span class="s1">Mean CTR in control and test groups are not equal.</span><span class="se">\n</span><span class="s1">pvalue = </span><span class="si">{</span><span class="n">pvalue</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fail to reject the null hypothesis.</span><span class="se">\n</span><span class="s1">Mean CTR in control and test groups are equal.</span><span class="se">\n</span><span class="s1">pvalue = </span><span class="si">{</span><span class="n">pvalue</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Difference in global CTR (test - control): </span><span class="si">{</span><span class="n">observed_diff</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Reject the null hypothesis.
Mean CTR in control and test groups are not equal.
pvalue = 2.2349817552225204e-09
Difference in global CTR (test - control): -0.009354
</pre></div>
</div>
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>p-value is below the significance level, therefore we reject the null hypothesis.</p></li>
<li><p>According to the delta method, there is a statistically significant difference in CTR between the groups.</p></li>
<li><p>In the test group, CTR is lower than in the control group by 0.009354.</p></li>
</ul>
</section>
<section id="t-test-on-bucket-transformed-data">
<h3>T-test on Bucket-Transformed Data<a class="headerlink" href="#t-test-on-bucket-transformed-data" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>T-test on bucket-transformed data can be robust to bimodality.</p></li>
<li><p>Although theoretically, the bimodality effect might persist.</p></li>
</ul>
<p>Split users in each group into 50 buckets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">hash_split</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="s1">&#39;exp_1&#39;</span><span class="p">,</span> <span class="n">n_buckets</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">test_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">salt</span><span class="p">)</span>
    <span class="n">test_id_digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">test_id</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="n">test_id_final_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">test_id_digest</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">test_id_final_int</span> <span class="o">%</span> <span class="n">n_buckets</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bucket&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">transform</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">hash_split</span><span class="p">,</span> <span class="n">n_buckets</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Examine the distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;bucket&#39;</span>
    <span class="p">,</span> <span class="n">facet_col</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/8a3f4747197adce7c4d7b01d80756b118ee191c2d9d8796da2d959ec6176ea40.png" src="../../_images/8a3f4747197adce7c4d7b01d80756b118ee191c2d9d8796da2d959ec6176ea40.png" />
</div>
</div>
<p>Calculate CTR for buckets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_bucket</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;bucket&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">likes</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;likes&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">views</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">df_bucket</span><span class="p">[</span><span class="s1">&#39;ctr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_bucket</span><span class="o">.</span><span class="n">likes</span> <span class="o">/</span> <span class="n">df_bucket</span><span class="o">.</span><span class="n">views</span>
</pre></div>
</div>
</div>
</div>
<p>Examine the distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df_bucket</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ctr&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b837b610dbf0ae37c5e21dfcb9da5e4986a489bc0ec9e93aa77aa813d314ed79.png" src="../../_images/b837b610dbf0ae37c5e21dfcb9da5e4986a489bc0ec9e93aa77aa813d314ed79.png" />
</div>
</div>
<p>Formulate null and alternative hypotheses.</p>
<ul class="simple">
<li><p>H0: Mean global bucket CTR in control and test groups are equal</p></li>
<li><p>H1: Mean global bucket CTR in control and test groups are not equal</p></li>
</ul>
<p>Test variance equality using Levene’s test.</p>
<ul class="simple">
<li><p>H0: Variances in control and test groups are equal</p></li>
<li><p>H1: Variances in control and test groups are not equal</p></li>
</ul>
<p>Set significance level to 0.05.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pg</span><span class="o">.</span><span class="n">homoscedasticity</span><span class="p">(</span><span class="n">df_bucket</span><span class="p">,</span> <span class="n">dv</span><span class="o">=</span><span class="s1">&#39;ctr&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>W</th>
      <th>pval</th>
      <th>equal_var</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>levene</th>
      <td>29.79</td>
      <td>0.00</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Result:</strong></p>
<ul class="simple">
<li><p>At significance level 0.05, we reject the null hypothesis of equal variances since p-value is less than the significance level.</p></li>
</ul>
<p>Since variances are not equal, we will use Welch’s test.</p>
<p>Set significance level to 0.05.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ctr_bucket_control</span> <span class="o">=</span> <span class="n">df_bucket</span><span class="p">[</span><span class="n">df_bucket</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ctr</span>
<span class="n">ctr_bucket_test</span> <span class="o">=</span> <span class="n">df_bucket</span><span class="p">[</span><span class="n">df_bucket</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ctr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span><span class="n">ctr_bucket_test</span><span class="p">,</span> <span class="n">ctr_bucket_control</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>T</th>
      <th>dof</th>
      <th>alternative</th>
      <th>p-val</th>
      <th>CI95%</th>
      <th>cohen-d</th>
      <th>BF10</th>
      <th>power</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>T-test</th>
      <td>-5.45</td>
      <td>67.15</td>
      <td>two-sided</td>
      <td>0.00</td>
      <td>[-0.01, -0.01]</td>
      <td>1.09</td>
      <td>3.374e+04</td>
      <td>1.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Difference in global bucket CTR (test - control) = </span><span class="si">{</span><span class="n">ctr_bucket_test</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ctr_bucket_control</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Difference in global bucket CTR (test - control) = -0.01
</pre></div>
</div>
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>p-value is below the significance level, therefore we reject the null hypothesis.</p></li>
<li><p>According to Welch’s test, global bucket CTR differs between groups. The test group value is lower.</p></li>
<li><p>Note that 0 does not fall within the confidence interval, which also confirms the result.</p></li>
</ul>
</section>
<section id="mann-whitney-on-bucket-transformed-data">
<h3>Mann-Whitney on Bucket-Transformed Data<a class="headerlink" href="#mann-whitney-on-bucket-transformed-data" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Since group variances are different, the Mann-Whitney test is unpredictable for comparing means. Even if there are no differences in means, it might detect differences in distributions.</p></li>
<li><p>Considering we need to compare mean values, its use in this case would not be a very good choice.</p></li>
</ul>
<p>Formulate null and alternative hypotheses.</p>
<ul class="simple">
<li><p>H0: The probability that a randomly selected global bucket CTR value from the test group will exceed a randomly selected global bucket CTR value from the control group equals the probability of the opposite outcome.</p></li>
<li><p>H1: The probability that a randomly selected global bucket CTR value from the test group will exceed a randomly selected global bucket CTR value from the control group is not equal to 0.5.</p></li>
</ul>
<p>Set significance level to 0.05.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pg</span><span class="o">.</span><span class="n">mwu</span><span class="p">(</span><span class="n">ctr_bucket_test</span><span class="p">,</span> <span class="n">ctr_bucket_control</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>U-val</th>
      <th>alternative</th>
      <th>p-val</th>
      <th>RBC</th>
      <th>CLES</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>MWU</th>
      <td>570.00</td>
      <td>two-sided</td>
      <td>0.00</td>
      <td>-0.54</td>
      <td>0.23</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>p-value is below the significance level, therefore we reject the null hypothesis.</p></li>
<li><p>According to the Mann-Whitney test, one of the global bucket CTR distributions statistically significantly dominates the other.</p></li>
<li><p>However, this result provides little business value since we essentially compared distributions, not means.</p></li>
</ul>
</section>
<section id="t-test-on-linearized-metric">
<h3>T-test on Linearized Metric<a class="headerlink" href="#t-test-on-linearized-metric" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The essence of linearization is to represent each user’s contribution to the difference in global CTR.</p></li>
<li><p>The t-test on the linearized metric essentially tests the same hypothesis as Poisson bootstrap.</p></li>
<li><p>Linearization creates a metric where differences in means strongly correlate with differences in global CTR.</p></li>
</ul>
<p>Use global CTR from the control group as reference.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">global_ctr</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>If the user behaved “like average”, they would have gathered this many likes</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">global_ctr</span>
</pre></div>
</div>
<p>For each user, create a linearized metric by subtracting expected from actual</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;linearized_likes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">global_ctr</span>
</pre></div>
</div>
</div>
</div>
<p>Examine the distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;linearized_likes&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Linearized Likes Distribution by Group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/aa1271ad6d7879424cfcfaa0fb92e4603c33c5911ee30c64c654864f29d62403.png" src="../../_images/aa1271ad6d7879424cfcfaa0fb92e4603c33c5911ee30c64c654864f29d62403.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Visually noticeable variance reduction.</p></li>
<li><p>Bimodality remains but is less pronounced.</p></li>
</ul>
<p>Formulate null and alternative hypotheses.</p>
<ul class="simple">
<li><p>H0: Mean value of the linearized metric in control and test groups are equal</p></li>
<li><p>H1: Mean value of the linearized metric in control and test groups are not equal</p></li>
</ul>
<p>Test variance equality using Levene’s test.</p>
<ul class="simple">
<li><p>H0: Variances in control and test groups are equal</p></li>
<li><p>H1: Variances in control and test groups are not equal</p></li>
</ul>
<p>Set significance level to 0.05.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pg</span><span class="o">.</span><span class="n">homoscedasticity</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dv</span><span class="o">=</span><span class="s1">&#39;linearized_likes&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>W</th>
      <th>pval</th>
      <th>equal_var</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>levene</th>
      <td>3,535.16</td>
      <td>0.00</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Result:</strong></p>
<ul class="simple">
<li><p>At significance level 0.05, we reject the null hypothesis of equal variances since p-value is less than the significance level.</p></li>
</ul>
<p>Since variances are not equal, we will use Welch’s test.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">linearized_likes_control</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">linearized_likes</span>
<span class="n">linearized_likes_test</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">linearized_likes</span>
</pre></div>
</div>
</div>
</div>
<p>Examine the difference in mean values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">linearized_likes_test</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">linearized_likes_control</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(-0.6245118559393538)
</pre></div>
</div>
</div>
</div>
<p>Set significance level to 0.05.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span><span class="n">linearized_likes_test</span><span class="p">,</span> <span class="n">linearized_likes_control</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>T</th>
      <th>dof</th>
      <th>alternative</th>
      <th>p-val</th>
      <th>CI95%</th>
      <th>cohen-d</th>
      <th>BF10</th>
      <th>power</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>T-test</th>
      <td>-5.94</td>
      <td>14,482.89</td>
      <td>two-sided</td>
      <td>0.00</td>
      <td>[-0.83, -0.42]</td>
      <td>0.08</td>
      <td>6.981e+05</td>
      <td>1.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>p-value is below the significance level, therefore we reject the null hypothesis.</p></li>
<li><p>According to Welch’s test, there is a statistically significant difference in the linearized metric between groups.</p></li>
<li><p>Note that pingouin shows power of 1.</p></li>
<li><p>Variance decreased and the t-test became more powerful.</p></li>
</ul>
</section>
<section id="permutation-test">
<h3>Permutation Test<a class="headerlink" href="#permutation-test" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Permutation test helps understand how statistically significant the effect we see in the experiment is.</p></li>
<li><p>Its essence is:</p>
<ul>
<li><p>We observed a difference original_diff</p></li>
<li><p>If the groups were random (no effect), how often would we get the same or greater difference?</p></li>
</ul>
</li>
<li><p>It has the same problems as Mann-Whitney. It can detect differences in distributions even with equal means.</p></li>
</ul>
<p>Formulate null and alternative hypotheses.</p>
<ul class="simple">
<li><p>H0: Mean CTR in control and test groups are equal</p></li>
<li><p>H1: Mean CTR in control and test groups are not equal</p></li>
</ul>
<p>Set significance level to 0.05.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>
</pre></div>
</div>
</div>
</div>
<p>Create a function for permutation test.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">permutation_test</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_permutations</span><span class="o">=</span><span class="mi">10_000</span><span class="p">):</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
    <span class="n">len_x</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">perm_diffs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_permutations</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
        <span class="n">perm_x</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[:</span><span class="n">len_x</span><span class="p">]</span>
        <span class="n">perm_y</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="n">len_x</span><span class="p">:]</span>
        <span class="n">perm_diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">perm_y</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">perm_x</span><span class="p">))</span>
    
    <span class="n">p_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">perm_diffs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">observed_diff</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">perm_diffs</span><span class="p">),</span> <span class="n">p_value</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">observed_diff</span> <span class="o">=</span> <span class="n">ctr_test</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctr_control</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">perm_diffs</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">permutation_test</span><span class="p">(</span><span class="n">ctr_test</span><span class="p">,</span> <span class="n">ctr_control</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Observed difference in means: </span><span class="si">{</span><span class="n">observed_diff</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Permutation p-value: </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reject the null hypothesis&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fail to reject the null hypothesis&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Observed difference in means: -0.0
Permutation p-value: 0.681
Fail to reject the null hypothesis
</pre></div>
</div>
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Since p-value is higher than the significance level, we fail to reject the null hypothesis.</p></li>
<li><p>The permutation test did not find a statistically significant difference between mean CTR in control and test groups.</p></li>
<li><p>The effect is truly absent or too small relative to data variability for the permutation test to detect.</p></li>
</ul>
<p>Examine the distribution of permutation mean differences.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">perm_diffs</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Perutation Mean Difference&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
<span class="p">)</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xaxis_title_text</span><span class="o">=</span><span class="s1">&#39;Mean Difference&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/237611c208895d027e0e90f3fade75f3c14d8bb0dbf0db7150f3cc3d26298deb.png" src="../../_images/237611c208895d027e0e90f3fade75f3c14d8bb0dbf0db7150f3cc3d26298deb.png" />
</div>
</div>
</section>
<section id="post-stratification">
<h3>Post-stratification<a class="headerlink" href="#post-stratification" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Post-stratification is used to reduce variance.</p>
<ul>
<li><p>In post-stratification, sample objects are “reweighted” so that stratum proportions in samples match stratum proportions in the population by calculating stratifiedmeans.</p></li>
</ul>
</li>
<li><p>Post-stratification only makes sense when two conditions are met simultaneously:</p>
<ul>
<li><p>Strata have different mean metric values (e.g., CTR_male ≠ CTR_female).</p></li>
<li><p>Stratum proportions differ between control and test groups (e.g., control has 60% male and 40% female, while test has 50% male and 50% female).</p></li>
</ul>
</li>
</ul>
<p>Based on data analysis, these conditions are not met for all dimensions, but for practice we’ll perform post-stratification by gender.</p>
<p>Examine how users are distributed by gender.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gender&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/49023db957a7134295fa38fb1da48ed1041fa7fa59537b07e6d8833af73c9032.png" src="../../_images/49023db957a7134295fa38fb1da48ed1041fa7fa59537b07e6d8833af73c9032.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>As we’ve already seen, proportions between groups are approximately equal.</p></li>
</ul>
<p>Examine the distribution of mean CTR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;ctr&#39;</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gender&#39;</span>
    <span class="p">,</span> <span class="n">histfunc</span><span class="o">=</span><span class="s1">&#39;avg&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/34da1782cea6fdaa6c93124667a57c58bd6ed014b79491025c888d7140b752d6.png" src="../../_images/34da1782cea6fdaa6c93124667a57c58bd6ed014b79491025c888d7140b752d6.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>As we’ve already seen, CTR differs only slightly between men and women.</p></li>
</ul>
<p>Post-stratification procedure:</p>
<ol class="arabic simple">
<li><p>Split users into groups by stratum membership</p></li>
<li><p>Calculate mean value for each group</p></li>
<li><p>Multiply means by stratum proportions in the population (0.44 and 0.56 respectively)</p></li>
<li><p>Sum everything</p></li>
</ol>
<p>Calculate stratum proportions in the total population (combined data)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> users_by_gender &lt;&lt;
SELECT 
    multiIf(
        gender = 1, &#39;female&#39;
        , gender = 0, &#39;male&#39;
        , &#39;unknown&#39;
    ) as gender
    , uniq(user_id) users
FROM
    feed_actions
GROUP BY
    gender
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Returning data to local variable users_by_gender
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">population_proportions</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">users_by_gender</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;gender&#39;</span><span class="p">)[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
    <span class="o">/</span> <span class="n">users_by_gender</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Proportions in total population:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">population_proportions</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Proportions in total population:
gender
male     0.45
female   0.55
Name: users, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Calculate raw means (unadjusted means)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">raw_control_mean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;ctr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">raw_test_mean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">][</span><span class="s1">&#39;ctr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raw CTR Control: </span><span class="si">{</span><span class="n">raw_control_mean</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">Raw CTR Test: </span><span class="si">{</span><span class="n">raw_test_mean</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Raw CTR Control: 0.217
Raw CTR Test: 0.216
</pre></div>
</div>
</div>
</div>
<p>Create a function to calculate post-stratified means.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">calculate_stratified_mean</span><span class="p">(</span><span class="n">group_df</span><span class="p">,</span> <span class="n">population_weights</span><span class="p">):</span>
    <span class="n">stratified_means</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">stratum</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">population_weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">stratum_mean</span> <span class="o">=</span> <span class="n">group_df</span><span class="p">[</span><span class="n">group_df</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stratum</span><span class="p">][</span><span class="s1">&#39;ctr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">stratified_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stratum_mean</span> <span class="o">*</span> <span class="n">weight</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">stratified_means</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Apply to both groups.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stratified_control</span> <span class="o">=</span> <span class="n">calculate_stratified_mean</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">],</span> <span class="n">population_proportions</span>
<span class="p">)</span>
<span class="n">stratified_test</span> <span class="o">=</span> <span class="n">calculate_stratified_mean</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">population_proportions</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stratified Raw CTR Control: </span><span class="si">{</span><span class="n">stratified_control</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">Stratified Raw CTR Test: </span><span class="si">{</span><span class="n">stratified_test</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Stratified Raw CTR Control: 0.217
Stratified Raw CTR Test: 0.216
</pre></div>
</div>
</div>
</div>
<p>Compare differences</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">raw_diff</span> <span class="o">=</span> <span class="n">raw_test_mean</span> <span class="o">-</span> <span class="n">raw_control_mean</span>
<span class="n">stratified_diff</span> <span class="o">=</span> <span class="n">stratified_test</span> <span class="o">-</span> <span class="n">stratified_control</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Raw difference: </span><span class="si">{</span><span class="n">raw_diff</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stratified difference: </span><span class="si">{</span><span class="n">stratified_diff</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Raw difference: -0.001
Stratified difference: -0.001
</pre></div>
</div>
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>As expected, the differences are minimal.</p></li>
</ul>
</section>
<section id="t-test-with-cuped-transformed-metric">
<h3>T-test with CUPED Transformed Metric<a class="headerlink" href="#t-test-with-cuped-transformed-metric" title="Link to this heading">#</a></h3>
<p>Controlled Experiment Using Pre-Experimental Data</p>
<ul class="simple">
<li><p>Used for variance reduction</p></li>
<li><p>Conceptually, CUPED uses the idea: subtracting predicted value from actual value,</p>
<ul>
<li><p>but the prediction here is built using correlation between historical and current data: the stronger the relationship,</p></li>
<li><p>the more we trust the prediction and adjust the metric. Conversely, if there’s no relationship,</p></li>
<li><p>the metric remains unchanged when using CUPED.</p></li>
</ul>
</li>
</ul>
<p>We need to get historical data from the database for users who participated in the experiment.
We’ll use data from the week before the experiment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> df_hist &lt;&lt;
WITH exp_users as (
SELECT
    user_id
FROM
    feed_actions
WHERE
    toDate(time) BETWEEN &#39;2025-08-02&#39; and &#39;2025-08-08&#39;
    and exp_group in (1, 2)
GROUP BY
    user_id
)
, hist_metrics as (
    SELECT
        user_id
        , countIf(action = &#39;like&#39;) as hist_likes
        , countIf(action = &#39;view&#39;) as hist_views
        , ifNull(hist_likes / nullIf(hist_views, 0), 0) as hist_ctr
    FROM
        feed_actions
    WHERE
        toDate(time) BETWEEN &#39;2025-07-26&#39; and &#39;2025-08-01&#39;
    GROUP BY
        user_id        
)
SELECT
    eu.user_id
    , ifNull(hm.hist_ctr, 0) as hist_ctr
    , if(hm.user_id != 0, 1, 0) as has_history 
FROM
    exp_users eu
    LEFT JOIN hist_metrics hm ON eu.user_id = hm.user_id
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Returning data to local variable df_hist
</pre></div>
</div>
</div>
</div>
<p>Merge with experimental data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_hist</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s see what percentage of users have no history.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">has_history</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(0.381263507061366)
</pre></div>
</div>
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>38% is a lot.</p></li>
<li><p>For these users, we’ll use the average historical CTR across all data, but accounting for dimensions.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> df_hist_all &lt;&lt;
SELECT
    multiIf(
        gender = 1, &#39;female&#39;
        , gender = 0, &#39;male&#39;
        , &#39;unknown&#39;
    ) as gender
    , multiIf(
        age &lt; 25, &#39;&lt;25&#39;
        , age between 25 and 40, &#39;25-40&#39;
        , age between 41 and 55, &#39;41-55&#39; 
        , age &gt;= 56, &#39;56+&#39;
        , &#39;unknown&#39;
    ) as age_group      
    , source
    , os
    , country
    , city
    , countIf(action = &#39;like&#39;) as hist_likes
    , countIf(action = &#39;view&#39;) as hist_views
    , ifNull(hist_likes / nullIf(hist_views, 0), 0) as hist_ctr
FROM
    feed_actions
WHERE
    toDate(time) BETWEEN &#39;2025-07-26&#39; and &#39;2025-08-01&#39;
GROUP BY
    gender
    , age_group
    , source
    , os
    , country
    , city              
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Returning data to local variable df_hist_all
</pre></div>
</div>
</div>
</div>
<p>Merge the data.
Replace missing values with global historical CTR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;gender&#39;</span><span class="p">,</span> <span class="s1">&#39;age_group&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;os&#39;</span><span class="p">,</span> <span class="s1">&#39;country&#39;</span><span class="p">,</span> <span class="s1">&#39;city&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">has_history</span> <span class="o">==</span> <span class="mi">0</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;hist_ctr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_hist_all</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;gender&#39;</span><span class="p">,</span> <span class="s1">&#39;age_group&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;os&#39;</span><span class="p">,</span> <span class="s1">&#39;country&#39;</span><span class="p">,</span> <span class="s1">&#39;city&#39;</span><span class="p">])</span>
    <span class="p">[</span><span class="s1">&#39;hist_ctr&#39;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">global_mean</span> <span class="o">=</span> <span class="n">df_hist_all</span><span class="p">[</span><span class="s1">&#39;hist_ctr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;hist_ctr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;hist_ctr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">global_mean</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Examine the distribution and compare statistics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;hist_ctr&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;has_history&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CTR Distribution&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/663b9fbe588abe57cb0a7ff8da0e4de5c1da2c362471e13e4ebcb782f02ed199.png" src="../../_images/663b9fbe588abe57cb0a7ff8da0e4de5c1da2c362471e13e4ebcb782f02ed199.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">comparison</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;has_history&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
    <span class="s1">&#39;hist_ctr&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span>
<span class="p">})</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Comparison of statistics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">comparison</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Comparison of statistics:
            hist_ctr            
                mean  std  count
has_history                     
0               0.21 0.04   7586
1               0.22 0.08  12311
</pre></div>
</div>
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Mean values are close.</p></li>
<li><p>Standard deviations differ. This is normal since group means are less variable.</p></li>
</ul>
<p>Select CTR during the experiment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">control_mask</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span>
<span class="n">test_mask</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_control</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">control_mask</span><span class="p">][</span><span class="s1">&#39;ctr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">test_mask</span><span class="p">][</span><span class="s1">&#39;ctr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<p>Covariates will be historical CTR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_control</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">control_mask</span><span class="p">][</span><span class="s1">&#39;hist_ctr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> 
<span class="n">x_test</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">test_mask</span><span class="p">][</span><span class="s1">&#39;hist_ctr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<p>Examine correlations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">corr_control</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">x_control</span><span class="p">,</span> <span class="n">y_control</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">corr_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correlation control: </span><span class="si">{</span><span class="n">corr_control</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correlation test: </span><span class="si">{</span><span class="n">corr_test</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Correlation control: 0.026
Correlation test: 0.009
</pre></div>
</div>
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Low correlation indicates that historical CTR practically doesn’t predict current CTR. This is an extremely weak relationship.</p></li>
<li><p>Possibly influenced by the fact that the test has many new users who weren’t present before.</p></li>
<li><p>Possibly users changed their behavior during the experiment.</p></li>
</ul>
<p>Calculate parameter θ for CUPED.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">calculate_theta</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">covariance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">variance_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>     
    <span class="n">theta</span> <span class="o">=</span> <span class="n">covariance</span> <span class="o">/</span> <span class="n">variance_x</span> <span class="k">if</span> <span class="n">variance_x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">theta</span>

<span class="n">theta_control</span> <span class="o">=</span> <span class="n">calculate_theta</span><span class="p">(</span><span class="n">y_control</span><span class="p">,</span> <span class="n">x_control</span><span class="p">)</span>
<span class="n">theta_test</span> <span class="o">=</span> <span class="n">calculate_theta</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">x_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Theta control: </span><span class="si">{</span><span class="n">theta_control</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Theta test: </span><span class="si">{</span><span class="n">theta_test</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Theta control: 0.0315
Theta test: 0.0194
</pre></div>
</div>
</div>
</div>
<p>Apply CUPED to both groups.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_cuped_control</span> <span class="o">=</span> <span class="n">y_control</span> <span class="o">-</span> <span class="n">theta_control</span> <span class="o">*</span> <span class="n">x_control</span>
<span class="n">y_cuped_test</span> <span class="o">=</span> <span class="n">y_test</span> <span class="o">-</span> <span class="n">theta_test</span> <span class="o">*</span> <span class="n">x_test</span>
</pre></div>
</div>
</div>
</div>
<p>Examine the difference in means.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_cuped_test</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">y_cuped_control</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(0.0019241573805137135)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_cuped</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;y_cuped&#39;</span><span class="p">:</span> <span class="n">y_cuped_control</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;control&#39;</span><span class="p">})</span>
        <span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;y_cuped&#39;</span><span class="p">:</span> <span class="n">y_cuped_test</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">})</span>
    <span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Examine the distributions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">df_cuped</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;y_cuped&#39;</span>
    <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;group&#39;</span>
    <span class="p">,</span> <span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;overlay&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Y-cuped Distribution by Group&#39;</span>
    <span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/d827dd325ee5650ecd3cdafa99ef71799bb309205c0e3527ea9d1b67de81494c.png" src="../../_images/d827dd325ee5650ecd3cdafa99ef71799bb309205c0e3527ea9d1b67de81494c.png" />
</div>
</div>
<p>Formulate null and alternative hypotheses.</p>
<ul class="simple">
<li><p>H0: Mean value of the transformed metric in control and test groups are equal</p></li>
<li><p>H1: Mean value of the transformed metric in control and test groups are not equal</p></li>
</ul>
<p>Test variance equality using Levene’s test.</p>
<ul class="simple">
<li><p>H0: Variances in control and test groups are equal</p></li>
<li><p>H1: Variances in control and test groups are not equal</p></li>
</ul>
<p>Set significance level to 0.05.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pg</span><span class="o">.</span><span class="n">homoscedasticity</span><span class="p">(</span><span class="n">df_cuped</span><span class="p">,</span> <span class="n">dv</span><span class="o">=</span><span class="s1">&#39;y_cuped&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>W</th>
      <th>pval</th>
      <th>equal_var</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>levene</th>
      <td>2,766.73</td>
      <td>0.00</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Result:</strong></p>
<ul class="simple">
<li><p>At significance level 0.05, we reject the null hypothesis of equal variances since p-value is less than the significance level.</p></li>
</ul>
<p>Since variances are not equal, we will use Welch’s test.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_cuped_control</span> <span class="o">=</span> <span class="n">df_cuped</span><span class="p">[</span><span class="n">df_cuped</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">y_cuped</span>
<span class="n">y_cuped_test</span> <span class="o">=</span> <span class="n">df_cuped</span><span class="p">[</span><span class="n">df_cuped</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">y_cuped</span>
</pre></div>
</div>
</div>
</div>
<p>Examine the difference in mean values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_cuped_test</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">y_cuped_control</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(0.0019241573805137135)
</pre></div>
</div>
</div>
</div>
<p>Set significance level to 0.05.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pg</span><span class="o">.</span><span class="n">ttest</span><span class="p">(</span><span class="n">y_cuped_test</span><span class="p">,</span> <span class="n">y_cuped_control</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>T</th>
      <th>dof</th>
      <th>alternative</th>
      <th>p-val</th>
      <th>CI95%</th>
      <th>cohen-d</th>
      <th>BF10</th>
      <th>power</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>T-test</th>
      <td>1.16</td>
      <td>15,808.39</td>
      <td>two-sided</td>
      <td>0.25</td>
      <td>[-0.0, 0.01]</td>
      <td>0.02</td>
      <td>0.031</td>
      <td>0.21</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>p-value is higher than the significance level, therefore we fail to reject the null hypothesis.</p></li>
<li><p>According to Welch’s test, there is no statistically significant difference in the transformed metric between groups.</p></li>
<li><p>Note that pingouin shows power of 0.21.</p></li>
</ul>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../3_metric_deep_dive/3_metric_deep_dive.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">3. Product Metric Deep Dive</p>
      </div>
    </a>
    <a class="right-next"
       href="../5_metric_forecasting/5_metric_forecasting.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">5. Metric Forecasting</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-libraries">4.1 Loading Libraries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#experimental-design">4.2 Experimental Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-description">4.3 Data Description</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions">4.4 Helper Functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sample-size-determination">4.5 Sample Size Determination</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#group-size-for-hypothesis-1">4.5.1 Group Size for Hypothesis 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#group-size-for-hypothesis-2">4.5.2 Group Size for Hypothesis 2</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-of-a-a-test-results">4.6 Analysis of A/A Test Results</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hypothesis-1">4.6.1 Hypothesis 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hypothesis-2">4.6.2 Hypothesis 2</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-of-a-b-test-results-for-hypothesis-1">4.7 Analysis of A/B Test Results for Hypothesis 1</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-loading">4.7.1 Data Loading</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-exploration">4.7.2 Data Exploration</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-the-correctness-of-the-splitting">4.7.2.1 Checking the Correctness of the Splitting</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#user-distribution">4.7.2.2 User Distribution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#distribution-of-post-count">4.7.2.3 Distribution of Post Count</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#distribution-of-likes-count">4.7.2.4 Distribution of Likes Count</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#distribution-of-views">4.7.2.5 Distribution of Views</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#distribution-of-ctr">4.7.2.6 Distribution of CTR</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#daily-dynamics">4.7.2.7 Daily Dynamics</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ctr-distribution-by-day">4.7.2.8 CTR Distribution by Day</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#likes-and-views-segmentation">4.7.2.9 Likes and Views Segmentation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#metric-interactions">4.7.2.10 Metric Interactions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#statistical-analysis">4.7.3 Statistical Analysis</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-of-a-b-test-results-for-hypothesis-2">4.8 Analysis of A/B Test Results for Hypothesis 2</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">4.8.1 Data Loading</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">4.8.2 Data Exploration</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">4.8.2.1 Checking the Correctness of the Splitting</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">4.8.2.2 User Distribution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">4.8.2.3 Distribution of Post Count</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">4.8.2.4 Distribution of Likes Count</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">4.8.2.5 Distribution of Views</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">4.8.2.6 Distribution of CTR</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">4.8.2.7 CTR Distribution by Day</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">4.8.2.8 Metric Interactions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">4.8.3 Statistical Analysis</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">4.9 Conclusion</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decision-on-rolling-out-the-new-algorithm-to-all-users">4.9.1 Decision on Rolling Out the New Algorithm to All Users</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hypothesis-1-similar-to-liked-posts-algorithm">Hypothesis 1: “Similar to Liked Posts” Algorithm</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hypothesis-2-posts-liked-by-similar-users-algorithm">Hypothesis 2: “Posts Liked by Similar Users” Algorithm</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#detailed-a-b-test-results">4.9.2 Detailed A/B Test Results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#technical-issues-in-hypothesis-1">Technical Issues in Hypothesis 1</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#valid-results-in-hypothesis-2">Valid Results in Hypothesis 2</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recommendations">4.10 Recommendations</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#for-hypothesis-1">For Hypothesis 1:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#for-hypothesis-2">For Hypothesis 2:</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#supplement-1-additional-tests">4.11 Supplement 1. Additional Tests</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#variance-equality-test">Variance Equality Test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#t-test">T-test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#t-test-on-smoothed-ctr">T-test on Smoothed CTR</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mann-whitney-test">Mann-Whitney Test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrap-on-user-level-ctr">Bootstrap on User-Level CTR</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrap-of-global-ctr">Bootstrap of Global CTR</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#poisson-bootstrap">Poisson Bootstrap</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#delta-method">Delta Method</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#t-test-on-bucket-transformed-data">T-test on Bucket-Transformed Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mann-whitney-on-bucket-transformed-data">Mann-Whitney on Bucket-Transformed Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#t-test-on-linearized-metric">T-test on Linearized Metric</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#permutation-test">Permutation Test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#post-stratification">Post-stratification</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#t-test-with-cuped-transformed-metric">T-test with CUPED Transformed Metric</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Pavel Grigoryev
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025, Pavel Grigoryev.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>