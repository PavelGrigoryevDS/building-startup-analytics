
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>5. Metric Forecasting &#8212; ðŸ§© Building Startup Analytics</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=aa5847ba" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/custom.js?v=f9582d1e"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'building_startup_analytics/5_metric_forecasting/5_metric_forecasting';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="6. Automated Daily Reports" href="../6_automated_reporting/6_automated_reporting.html" />
    <link rel="prev" title="4. A/B Testing" href="../4_ab_testing/4_ab_testing.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo-light.jpg" class="logo__image only-light" alt="ðŸ§© Building Startup Analytics - Home"/>
    <script>document.write(`<img src="../../_static/logo-dark.jpg" class="logo__image only-dark" alt="ðŸ§© Building Startup Analytics - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    ðŸ§© Building Startup Analytics
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../1_data_infrastructure/1_analytical_database.html">1. Building Analytical Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_product_dashboard/2_product_dashboard.html">2. Product Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_metric_deep_dive/3_metric_deep_dive.html">3. Product Metric Deep Dive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_ab_testing/4_ab_testing.html">4. A/B Testing</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">5. Metric Forecasting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6_automated_reporting/6_automated_reporting.html">6. Automated Daily Reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../7_anomaly_detection/7_alert_system.html">7. Alert System</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/PavelGrigoryevDS/building-startup-analytics" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/building_startup_analytics/5_metric_forecasting/5_metric_forecasting.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>5. Metric Forecasting</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> On this page </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-libraries">5.1 Loading Libraries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-description">5.2 Data Description</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#research-design">5.3 Research Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-loading">5.4 Data Loading</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-exploration">5.5 Data Exploration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-definition-and-general-settings">5.6 Model Definition and General Settings</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#general-settings">5.6.1 General Settings</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-types">5.6.2 Model Types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimators">5.6.3 Estimators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-quality-evaluation">5.6.4 Model Quality Evaluation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#regularization">5.6.5 Regularization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-selection-for-backtesting">5.6.6 Parameter Selection for Backtesting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-definition">5.6.7 Model Definition</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-function-for-model-configs">5.6.8 Creating Function for Model Configs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-function-for-model-evaluation">5.6.9 Creating Function for Model Evaluation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-analysis">5.7 Model Analysis</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#total-dau">5.7.1 Total DAU</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#processing-execution">5.7.1.1 Processing Execution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#results-analysis">5.7.1.2 Results Analysis</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#total-number-of-actions">5.7.2 Total Number of Actions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">5.7.2.1 Processing Execution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">5.7.2.2 Results Analysis</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#grid-search">5.7.3 Grid Search</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-forecast">5.8 Test Forecast</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">5.9 Conclusion</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Total DAU</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Total Number of Actions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recommendations">5.10 Recommendations</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="metric-forecasting">
<h1>5. Metric Forecasting<a class="headerlink" href="#metric-forecasting" title="Link to this heading">#</a></h1>
<p><strong>Context:</strong></p>
<ul class="simple">
<li><p>Recently, weâ€™ve been receiving increasing complaints about application lag and performance issues.</p></li>
<li><p>As user activity grows, server load intensifies, requiring proactive capacity planning.</p></li>
<li><p>While this is primarily a DevOps and engineering challenge, accurate forecasting of user activity is crucial for anticipating server demands and preventing future performance degradation.</p></li>
</ul>
<p><strong>Objectives:</strong></p>
<ul class="simple">
<li><p>To build reliable forecasting models that predict user activity patterns for the upcoming month, enabling proactive server capacity planning and preventing application performance issues.</p></li>
</ul>
<p><strong>Data Sources:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">feed_actions</span></code> - News feed activity</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">message_actions</span></code> - Messaging activity</p></li>
</ul>
<p><strong>Key Achievements:</strong></p>
<ul class="simple">
<li><p><strong>Metric Selection &amp; Analysis:</strong></p>
<ul>
<li><p>Selected total actions (feed + messenger) as primary load metric and total DAU as stability metric; conducted comprehensive EDA on 2 months of historical data</p></li>
</ul>
</li>
<li><p><strong>Model Development &amp; Validation:</strong></p>
<ul>
<li><p>Tested ETS, LGT, DLT, and KTR models with multiple estimators; performed rigorous backtesting with expanding and rolling windows</p></li>
</ul>
</li>
<li><p><strong>Parameter Optimization &amp; Quality Assessment:</strong></p>
<ul>
<li><p>Conducted grid search for optimal model parameters; evaluated models using SMAPE, MAE, and information criteria</p></li>
</ul>
</li>
<li><p><strong>Forecasting Strategy:</strong></p>
<ul>
<li><p>Established 7-day forecasting as optimal horizon given data constraints; identified key limitations and model interpretation guidelines</p></li>
</ul>
</li>
</ul>
<p><strong>Key Findings:</strong></p>
<p>Total DAU Forecasting</p>
<ul class="simple">
<li><p><strong>Best Model:</strong></p>
<ul>
<li><p>DLT with MAP estimator, linear trend, no regressors or regularization</p></li>
</ul>
</li>
<li><p><strong>Accuracy:</strong></p>
<ul>
<li><p>3.9% SMAPE error (excellent result given limited data)</p></li>
</ul>
</li>
<li><p><strong>Key Insight:</strong></p>
<ul>
<li><p>Linear trend outperforms log-linear</p></li>
<li><p>MAP estimators work better than MCMC with small datasets</p></li>
</ul>
</li>
</ul>
<p>Total Actions Forecasting</p>
<ul class="simple">
<li><p><strong>Best Model:</strong></p>
<ul>
<li><p>DLT with MAP estimator, linear trend, no regressors</p></li>
</ul>
</li>
<li><p><strong>Accuracy:</strong></p>
<ul>
<li><p>21.4% SMAPE error (reasonable given metric volatility)</p></li>
</ul>
</li>
<li><p><strong>Key Insight:</strong></p>
<ul>
<li><p>Total actions are more volatile but crucial for server load planning</p></li>
</ul>
</li>
</ul>
<p><strong>Key Recommendations:</strong></p>
<p>Immediate Actions</p>
<ul class="simple">
<li><p>Implement weekly forecasting using the selected DLT models for both metrics</p></li>
<li><p>Use total DAU for stable capacity planning and total actions for peak load estimation</p></li>
<li><p>Maintain separate forecasts for feed and messenger components</p></li>
</ul>
<p>Strategic Recommendations</p>
<ul class="simple">
<li><p><strong>Data Collection:</strong></p>
<ul>
<li><p>Continue accumulating historical data for improved model accuracy</p></li>
</ul>
</li>
<li><p><strong>Model Retraining:</strong></p>
<ul>
<li><p>Schedule monthly model re-evaluation as data volume increases</p></li>
</ul>
</li>
<li><p><strong>Gradual Expansion:</strong></p>
<ul>
<li><p>Consider extending forecast horizon to 2 weeks once 3+ months of data are available</p></li>
</ul>
</li>
</ul>
<p><strong>Business Impact:</strong></p>
<ul class="simple">
<li><p>Supported infrastructure planning and resource allocation through reliable activity predictions, contributing to stable application performance.</p></li>
</ul>
<section id="loading-libraries">
<h2>5.1 Loading Libraries<a class="headerlink" href="#loading-libraries" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">orbit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">orbit.eda</span><span class="w"> </span><span class="kn">import</span> <span class="n">eda_plot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">orbit.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">DLT</span><span class="p">,</span> <span class="n">ETS</span><span class="p">,</span> <span class="n">LGT</span><span class="p">,</span> <span class="n">KTR</span> 
<span class="kn">from</span><span class="w"> </span><span class="nn">orbit.diagnostics.plot</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_predicted_data</span><span class="p">,</span> <span class="n">plot_predicted_components</span><span class="p">,</span> <span class="n">plot_bt_predictions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">orbit.diagnostics.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">smape</span><span class="p">,</span> <span class="n">wmape</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">orbit.diagnostics.backtest</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackTester</span> 
<span class="kn">from</span><span class="w"> </span><span class="nn">orbit.utils.params_tuning</span><span class="w"> </span><span class="kn">import</span> <span class="n">grid_search_orbit</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">arviz</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">az</span> 
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.auto</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../assets&#39;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly_config</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">sql_config</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="o">%</span><span class="k">load_ext</span> sql
<span class="o">%</span><span class="k">sql</span> $sql_config.connection_string
<span class="o">%</span><span class="k">config</span> SqlMagic.displaycon = False
<span class="o">%</span><span class="k">config</span> SqlMagic.feedback = False
<span class="o">%</span><span class="k">config</span> SqlMagic.autopandas = True
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>         
    <span class="s1">&#39;axes.titlesize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>    
    <span class="s1">&#39;axes.labelsize&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>     
    <span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>    
    <span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>    
    <span class="s1">&#39;legend.fontsize&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>    
    <span class="s1">&#39;figure.titlesize&#39;</span><span class="p">:</span> <span class="mi">10</span>   
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-description">
<h2>5.2 Data Description<a class="headerlink" href="#data-description" title="Link to this heading">#</a></h2>
<p>The data is located in ClickHouse tables <code class="docutils literal notranslate"><span class="pre">feed_actions</span></code> and <code class="docutils literal notranslate"><span class="pre">message_actions</span></code>.</p>
<p>Table feed_actions</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Field</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>user_id</p></td>
<td><p>User ID</p></td>
</tr>
<tr class="row-odd"><td><p>post_id</p></td>
<td><p>Post ID</p></td>
</tr>
<tr class="row-even"><td><p>action</p></td>
<td><p>Action: view or like</p></td>
</tr>
<tr class="row-odd"><td><p>time</p></td>
<td><p>Timestamp</p></td>
</tr>
<tr class="row-even"><td><p>gender</p></td>
<td><p>Userâ€™s gender</p></td>
</tr>
<tr class="row-odd"><td><p>age</p></td>
<td><p>Userâ€™s age (1 = Female)</p></td>
</tr>
<tr class="row-even"><td><p>country</p></td>
<td><p>Userâ€™s country</p></td>
</tr>
<tr class="row-odd"><td><p>city</p></td>
<td><p>Userâ€™s city</p></td>
</tr>
<tr class="row-even"><td><p>os</p></td>
<td><p>Userâ€™s OS</p></td>
</tr>
<tr class="row-odd"><td><p>source</p></td>
<td><p>Traffic source</p></td>
</tr>
<tr class="row-even"><td><p>exp_group</p></td>
<td><p>A/B test group</p></td>
</tr>
</tbody>
</table>
</div>
<p>Table message_actions</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Field</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>user_id</p></td>
<td><p>Senderâ€™s ID</p></td>
</tr>
<tr class="row-odd"><td><p>receiver_id</p></td>
<td><p>Receiverâ€™s ID</p></td>
</tr>
<tr class="row-even"><td><p>time</p></td>
<td><p>Send timestamp</p></td>
</tr>
<tr class="row-odd"><td><p>source</p></td>
<td><p>Senderâ€™s traffic source</p></td>
</tr>
<tr class="row-even"><td><p>exp_group</p></td>
<td><p>Senderâ€™s A/B test group</p></td>
</tr>
<tr class="row-odd"><td><p>gender</p></td>
<td><p>Senderâ€™s gender</p></td>
</tr>
<tr class="row-even"><td><p>age</p></td>
<td><p>Senderâ€™s age (1 = Male)</p></td>
</tr>
<tr class="row-odd"><td><p>country</p></td>
<td><p>Senderâ€™s country</p></td>
</tr>
<tr class="row-even"><td><p>city</p></td>
<td><p>Senderâ€™s city</p></td>
</tr>
<tr class="row-odd"><td><p>os</p></td>
<td><p>Senderâ€™s OS</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="research-design">
<h2>5.3 Research Design<a class="headerlink" href="#research-design" title="Link to this heading">#</a></h2>
<p><strong>Selection of Primary Metric and Justification</strong></p>
<ul class="simple">
<li><p>As the primary metric, we choose <strong>number of actions in the feed + number of messages in the messenger</strong></p></li>
<li><p>As the auxiliary metric, we choose <strong>total DAU</strong></p></li>
</ul>
<p>Justification:</p>
<ul class="simple">
<li><p>Server load will depend on the total activity in the feed and messenger.</p></li>
<li><p>To determine activity, we could choose the number of unique users, but one user can perform many actions and send many messages that will load the server, which we wouldnâ€™t account for.</p></li>
<li><p>The optimal choice is the daily total value of feed actions and messenger messages.</p></li>
<li><p>We will account for both users and their activity. The more actions they perform and messages they send, the higher this total metric will be.</p></li>
<li><p>However, since total activity can vary significantly, itâ€™s better to also forecast total DAU for feed and messenger.</p></li>
<li><p>After all, forecast quality is important, and I think DAU quality will be better as itâ€™s more stable.</p></li>
<li><p>Considering both forecasts will allow for more accurate prediction of how user activity will change.</p></li>
<li><p>DAU will be calculated separately for feed and messenger, then summed, as itâ€™s desirable to account for load on both services.</p></li>
</ul>
<p><strong>Will There Be Regressors</strong></p>
<ul class="simple">
<li><p>Since we donâ€™t have metrics whose future values we know, using other metrics as regressors is ineffective.</p></li>
<li><p>However, since weâ€™ll be forecasting DAU, weâ€™ll try adding DAU as a regressor in several models and compare with other models.</p></li>
<li><p>As a regressor, we can choose the weekend factor.</p>
<ul>
<li><p>Since user behavior on weekends may differ from weekdays.</p></li>
<li><p>But first we need to confirm this is visible on the charts.</p></li>
</ul>
</li>
<li><p>Weâ€™ll also choose the flash mob day factor as a regressor.</p>
<ul>
<li><p>Set these days to 1, others to 0.</p></li>
<li><p>If we knew a flash mob would occur in the future, we could set 1 for the relevant days.</p></li>
<li><p>Weâ€™ll also consider August 23, 2025 as a flash mob, as charts show increased activity on that day.</p></li>
</ul>
</li>
<li><p>We also know that on August 15, 2025 there was an advertising campaign, and on August 24 there was an activity drop due to technical issues in major cities.</p>
<ul>
<li><p>For these dates, weâ€™ll also set 1 to account for these anomalous dates.</p></li>
<li><p>For future advertising campaigns, we can set 1 for the advertising campaign factor.</p></li>
</ul>
</li>
<li><p>It would also be desirable to use holidays as regressors.</p>
<ul>
<li><p>But adding a regressor without studying how our metric behaved on such days is not ideal.</p></li>
<li><p>And since we havenâ€™t had holidays in our history, we wonâ€™t create such a regressor.</p></li>
</ul>
</li>
</ul>
<p><strong>Temporal Resolution (Granularity)</strong></p>
<ul class="simple">
<li><p>Primary resolution: Day (Daily)</p></li>
<li><p>Balance between noise and detail: Hourly data would be too noisy (spikes at lunch, drops at night).</p></li>
</ul>
<p><strong>Do We Have Enough Data for Backtesting with the Current Task?</strong></p>
<ul class="simple">
<li><p>No, we donâ€™t have enough data for proper backtesting on a monthly horizon.</p></li>
</ul>
<p><strong>Forecasting Horizon Selection</strong></p>
<ul class="simple">
<li><p>We can choose a horizon of 7 or 14 days.</p></li>
<li><p>To conduct good backtesting, a 1-week horizon is better.</p></li>
<li><p>Since we have approximately 2 months of data, I think 7 days is the optimal choice.</p></li>
<li><p>Itâ€™s better to prioritize quality over longer forecast duration.</p></li>
<li><p>For proper backtesting, the training size at each iteration should be at least 3 prediction horizons.</p></li>
<li><p>In this case, for a 2-week forecast weâ€™d only have 2 iterations, which is too few.</p></li>
<li><p>If we choose a 7-day forecast, weâ€™ll have 6-7 backtest iterations, which is acceptable.</p></li>
<li><p>When we accumulate enough data for at least 3 iterations, we can consider a 2-week forecast.</p></li>
</ul>
<p><strong>Research Procedure</strong></p>
<ul class="simple">
<li><p>Load necessary data</p></li>
<li><p>Study it and adjust regressors if needed</p></li>
<li><p>Select models for analysis and their parameters</p></li>
<li><p>Determine how weâ€™ll evaluate model quality</p></li>
<li><p>Conduct analysis of selected models</p></li>
<li><p>Select the best models (one for total DAU and one for total actions)</p></li>
<li><p>For the best models, tune parameters using Grid search</p></li>
<li><p>Make test forecasts</p></li>
<li><p>Write conclusions and recommendations</p></li>
</ul>
</section>
<section id="data-loading">
<h2>5.4 Data Loading<a class="headerlink" href="#data-loading" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Query ClickHouse and get the necessary data.</p></li>
<li><p>We wonâ€™t take the current day as itâ€™s incomplete.</p></li>
<li><p>Save it to pandas DataFrames.</p></li>
<li><p>Look at several rows of each DataFrame.</p></li>
<li><p>Check column types.</p></li>
<li><p>Set data types for columns where possible.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span> df &lt;&lt;
WITH feed_daily as (
    SELECT
        toDate(time) as date
        , count() as total_feed_actions
        , uniq(user_id) as feed_users
    FROM
        feed_actions
    WHERE
        date &lt; toDate(now())
    GROUP BY
        date
)
, mess_daily as (
    SELECT
        toDate(time) as date
        , count() as total_mess_actions
        , uniq(user_id) as mess_users
    FROM
        message_actions
    WHERE
        date &lt; toDate(now())
    GROUP BY
        date
)
SELECT
    if(f.date != toDate(0), f.date, m.date) as date
    , toDayOfWeek(date) as day_of_week
    , if(toDayOfWeek(date) in (6, 7), 1, 0) as is_weekend
    , if(toDayOfWeek(date) = 5, 1, 0) as is_friday
    , date BETWEEN &#39;2025-08-16&#39; AND &#39;2025-08-23&#39; as is_flashmob
    , date = &#39;2025-08-15&#39; as is_ads_company
    , date = &#39;2025-08-24&#39; as is_drop_down
    , f.total_feed_actions + m.total_mess_actions as actions
    , f.feed_users + m.mess_users as users
FROM
    feed_daily f
    FULL JOIN mess_daily m ON f.date = m.date
ORDER BY
    date
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Returning data to local variable df
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>day_of_week</th>
      <th>is_weekend</th>
      <th>is_friday</th>
      <th>is_flashmob</th>
      <th>is_ads_company</th>
      <th>is_drop_down</th>
      <th>actions</th>
      <th>users</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2025-07-06</td>
      <td>7</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>12389</td>
      <td>1112</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2025-07-07</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>88481</td>
      <td>2861</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2025-07-08</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>139381</td>
      <td>3627</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>date              object
day_of_week        int64
is_weekend         int64
is_friday          int64
is_flashmob        int64
is_ads_company     int64
is_drop_down       int64
actions            int64
users              int64
dtype: object
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-exploration">
<h2>5.5 Data Exploration<a class="headerlink" href="#data-exploration" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>We know that from 2025-08-16 to 2025-08-22 there was a flash mob.</p></li>
<li><p>If we chose the metric correctly, it should have shown up during this time.</p></li>
<li><p>Letâ€™s verify this.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;date&#39;</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;users&#39;</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Number of Users by Day&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/4c3472dee9e623c5cb8e5afe8b4d6e4e458982c9054f93fc4d4c649429f4447b.png" src="../../_images/4c3472dee9e623c5cb8e5afe8b4d6e4e458982c9054f93fc4d4c649429f4447b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
    <span class="n">df</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;date&#39;</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;actions&#39;</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Number of Actions by Day&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/555f1f3cfd8e146af1631d72a2870bc7922188ca25fa2264cd39713b3e12c5cd.png" src="../../_images/555f1f3cfd8e146af1631d72a2870bc7922188ca25fa2264cd39713b3e12c5cd.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Our total activity metric clearly showed a spike during the flash mob days.</p></li>
<li><p>This means the choice was correct.</p></li>
<li><p>We can also see that total number of users behaves more stably than total activity.</p></li>
</ul>
<p>Letâ€™s check if thereâ€™s weekly seasonality.</p>
<p><strong>Letâ€™s examine by whether itâ€™s a weekend day</strong></p>
<p>Mean</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;day_of_week&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;day_of_week&#39;</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;users&#39;</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Mean Number of Uers by Day of Week&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/50c72043a9d78e45e5959c2778bf2a3b31a029917e1c280a69784025a3145393.png" src="../../_images/50c72043a9d78e45e5959c2778bf2a3b31a029917e1c280a69784025a3145393.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;day_of_week&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;day_of_week&#39;</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;actions&#39;</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Mean Number of Actions by Day of Week&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/9977fea64affa17f0fac4172b9b083c8cea5ee0df960236e6c79a2e8e3a6d9d5.png" src="../../_images/9977fea64affa17f0fac4172b9b083c8cea5ee0df960236e6c79a2e8e3a6d9d5.png" />
</div>
</div>
<p>Median</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;day_of_week&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;day_of_week&#39;</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;users&#39;</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Median Number of Uers by Day of Week&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/257a24b6911b3c0ce0452103235ada78dac468f0628561f1bd7cc91740a00de9.png" src="../../_images/257a24b6911b3c0ce0452103235ada78dac468f0628561f1bd7cc91740a00de9.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;day_of_week&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;day_of_week&#39;</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;actions&#39;</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Median Number of Actions by Day of Week&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/1df90fe384e33448c483080ac5df9ea3e2b05975897184d71cfdc9d52195c7cd.png" src="../../_images/1df90fe384e33448c483080ac5df9ea3e2b05975897184d71cfdc9d52195c7cd.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Friday and Saturday stand out with higher total activity, while Monday and Sunday have lower activity.</p></li>
</ul>
<p>Letâ€™s examine excluding the flash mob.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="s1">&#39;2025-08-16&#39;</span><span class="p">,</span> <span class="s1">&#39;2025-08-23&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_for_fig</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;day_of_week&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">median</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
    <span class="n">df_for_fig</span>
    <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;day_of_week&#39;</span>
    <span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;actions&#39;</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Median Number of Actions by Day of Week&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/e17c10ea40b79a057756461d4999dbfeb9934937cf1325faca4f75cfc21c2953.png" src="../../_images/e17c10ea40b79a057756461d4999dbfeb9934937cf1325faca4f75cfc21c2953.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Friday clearly stands out.</p></li>
</ul>
<p>Letâ€™s look at the heatmap.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">eda_plot</span><span class="o">.</span><span class="n">ts_heatmap</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">value_col</span><span class="o">=</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="n">seasonal_interval</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">fig</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f965574437c2cbe6493e6746fc86918b35c67448a2a57374be4120686d32dccb.png" src="../../_images/f965574437c2cbe6493e6746fc86918b35c67448a2a57374be4120686d32dccb.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">eda_plot</span><span class="o">.</span><span class="n">ts_heatmap</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">value_col</span><span class="o">=</span><span class="s2">&quot;actions&quot;</span><span class="p">,</span> <span class="n">seasonal_interval</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">fig</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/a5119fd64578387bc321dc6bde9acc3dff4df145b5641212f50234140458bb53.png" src="../../_images/a5119fd64578387bc321dc6bde9acc3dff4df145b5641212f50234140458bb53.png" />
</div>
</div>
<p>Letâ€™s examine the medians.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_for_fig</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="s1">&#39;day_of_week&#39;</span>
        <span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;7d&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;median&#39;</span>
    <span class="p">)[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">df_for_fig</span>
    <span class="p">,</span> <span class="n">color_continuous_scale</span><span class="o">=</span><span class="s1">&#39;Greens&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Median Number of Users by Week and Day of Week&#39;</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.2s&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/7db1a0f7b8387717b92bd558e15682b49b76202347f79bd9c111610f9457243c.png" src="../../_images/7db1a0f7b8387717b92bd558e15682b49b76202347f79bd9c111610f9457243c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_for_fig</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="s1">&#39;day_of_week&#39;</span>
        <span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;7d&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;median&#39;</span>
    <span class="p">)[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">df_for_fig</span>
    <span class="p">,</span> <span class="n">color_continuous_scale</span><span class="o">=</span><span class="s1">&#39;Greens&#39;</span>
    <span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Median Number of Actions by Week and Day of Week&#39;</span>
    <span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span>
    <span class="p">,</span> <span class="n">text_auto</span><span class="o">=</span><span class="s1">&#39;.2s&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/6a46d2e7152d1fea785e0e26c6a247084dc4d5325df695d1ad2f25505f23ed03.png" src="../../_images/6a46d2e7152d1fea785e0e26c6a247084dc4d5325df695d1ad2f25505f23ed03.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Although Friday stands out in overall mean and median, no seasonality is observed when broken down by day of week and week.</p></li>
<li><p>Therefore, we wonâ€™t add seasonality as it would complicate the model when thereâ€™s no explicit seasonality.</p></li>
<li><p>Regarding Friday, the choice is difficult - on one hand, it stands out only by day of week, but when broken down by both day of week and week, thereâ€™s no clear difference.</p></li>
<li><p>We wonâ€™t add the weekend day factor as this hypothesis wasnâ€™t confirmed.</p></li>
</ul>
<p><strong>Letâ€™s examine correlation</strong></p>
<p>Pearson</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;actions&#39;</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;is_weekend&#39;</span><span class="p">,</span> <span class="s1">&#39;is_friday&#39;</span><span class="p">,</span> <span class="s1">&#39;is_flashmob&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>actions</th>
      <th>users</th>
      <th>is_weekend</th>
      <th>is_friday</th>
      <th>is_flashmob</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>actions</th>
      <td>1.000</td>
      <td>0.769</td>
      <td>-0.001</td>
      <td>0.074</td>
      <td>0.679</td>
    </tr>
    <tr>
      <th>users</th>
      <td>0.769</td>
      <td>1.000</td>
      <td>-0.075</td>
      <td>0.048</td>
      <td>0.142</td>
    </tr>
    <tr>
      <th>is_weekend</th>
      <td>-0.001</td>
      <td>-0.075</td>
      <td>1.000</td>
      <td>-0.258</td>
      <td>0.067</td>
    </tr>
    <tr>
      <th>is_friday</th>
      <td>0.074</td>
      <td>0.048</td>
      <td>-0.258</td>
      <td>1.000</td>
      <td>-0.017</td>
    </tr>
    <tr>
      <th>is_flashmob</th>
      <td>0.679</td>
      <td>0.142</td>
      <td>0.067</td>
      <td>-0.017</td>
      <td>1.000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Spearman</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;actions&#39;</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;is_weekend&#39;</span><span class="p">,</span> <span class="s1">&#39;is_friday&#39;</span><span class="p">,</span> <span class="s1">&#39;is_flashmob&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;spearman&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>actions</th>
      <th>users</th>
      <th>is_weekend</th>
      <th>is_friday</th>
      <th>is_flashmob</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>actions</th>
      <td>1.000</td>
      <td>0.839</td>
      <td>0.036</td>
      <td>0.082</td>
      <td>0.511</td>
    </tr>
    <tr>
      <th>users</th>
      <td>0.839</td>
      <td>1.000</td>
      <td>-0.078</td>
      <td>0.045</td>
      <td>0.092</td>
    </tr>
    <tr>
      <th>is_weekend</th>
      <td>0.036</td>
      <td>-0.078</td>
      <td>1.000</td>
      <td>-0.258</td>
      <td>0.067</td>
    </tr>
    <tr>
      <th>is_friday</th>
      <td>0.082</td>
      <td>0.045</td>
      <td>-0.258</td>
      <td>1.000</td>
      <td>-0.017</td>
    </tr>
    <tr>
      <th>is_flashmob</th>
      <td>0.511</td>
      <td>0.092</td>
      <td>0.067</td>
      <td>-0.017</td>
      <td>1.000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Kendall</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;actions&#39;</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;is_weekend&#39;</span><span class="p">,</span> <span class="s1">&#39;is_friday&#39;</span><span class="p">,</span> <span class="s1">&#39;is_flashmob&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;kendall&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>actions</th>
      <th>users</th>
      <th>is_weekend</th>
      <th>is_friday</th>
      <th>is_flashmob</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>actions</th>
      <td>1.000</td>
      <td>0.667</td>
      <td>0.030</td>
      <td>0.067</td>
      <td>0.420</td>
    </tr>
    <tr>
      <th>users</th>
      <td>0.667</td>
      <td>1.000</td>
      <td>-0.064</td>
      <td>0.037</td>
      <td>0.076</td>
    </tr>
    <tr>
      <th>is_weekend</th>
      <td>0.030</td>
      <td>-0.064</td>
      <td>1.000</td>
      <td>-0.258</td>
      <td>0.067</td>
    </tr>
    <tr>
      <th>is_friday</th>
      <td>0.067</td>
      <td>0.037</td>
      <td>-0.258</td>
      <td>1.000</td>
      <td>-0.017</td>
    </tr>
    <tr>
      <th>is_flashmob</th>
      <td>0.420</td>
      <td>0.076</td>
      <td>0.067</td>
      <td>-0.017</td>
      <td>1.000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Total number of actions and total number of users correlate well.</p></li>
<li><p>Flash mob factor correlates reasonably well with our metric.</p></li>
<li><p>Friday factor hardly correlates at all. Therefore, we wonâ€™t use Friday factor as a regressor.</p></li>
<li><p>Similarly, we wonâ€™t use weekend day factor as a regressor.</p></li>
</ul>
</section>
<section id="model-definition-and-general-settings">
<h2>5.6 Model Definition and General Settings<a class="headerlink" href="#model-definition-and-general-settings" title="Link to this heading">#</a></h2>
<section id="general-settings">
<h3>5.6.1 General Settings<a class="headerlink" href="#general-settings" title="Link to this heading">#</a></h3>
<p>Ultimately, we will use:</p>
<ul class="simple">
<li><p>Primary metric: <strong>total number of actions in feed and messenger</strong></p></li>
<li><p>Additional metric: <strong>total DAU</strong></p></li>
<li><p>Granularity: <strong>1 day</strong></p></li>
<li><p>Seasonality: <strong>will not be considered</strong></p></li>
<li><p>Regressors will be:</p>
<ul>
<li><p>flash mob factor</p></li>
<li><p>advertising campaign factor</p></li>
<li><p>activity drop factor in major cities</p></li>
<li><p>for the primary metric, weâ€™ll try adding total DAU as a regressor</p></li>
</ul>
</li>
<li><p>Forecast horizon: <strong>7 days</strong></p></li>
</ul>
<p>Save the required column names in variables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">date_col</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>               
<span class="n">n_bootstrap_draws</span><span class="o">=</span><span class="mi">1000</span>          
<span class="n">regressor_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;is_flashmob&#39;</span><span class="p">,</span> <span class="s1">&#39;is_ads_company&#39;</span><span class="p">,</span> <span class="s1">&#39;is_drop_down&#39;</span><span class="p">]</span>   
</pre></div>
</div>
</div>
</div>
</section>
<section id="model-types">
<h3>5.6.2 Model Types<a class="headerlink" href="#model-types" title="Link to this heading">#</a></h3>
<p>ETS - Exponential Smoothing</p>
<ul class="simple">
<li><p>Model with exponential smoothing</p></li>
<li><p>Simplest forecasting model giving more weight to recent values and less to older ones.</p></li>
<li><p>Can only estimate overall level and seasonality</p></li>
<li><p>Does not support trend and additional regressors.</p></li>
<li><p>In Orbit, it serves more as a training function since other models are more advanced.</p></li>
</ul>
<p>LGT - Local Global Trend</p>
<ul class="simple">
<li><p>Model with local and global trends</p></li>
<li><p>Models both local trends (short-term changes) and global trends (characteristic of the entire dataset).</p></li>
<li><p>Only works with positive data.</p></li>
</ul>
<p>DLT - Damped Local Trend</p>
<ul class="simple">
<li><p>Model with damped local trend</p></li>
<li><p>Allows additional regressors and trend.</p></li>
<li><p>Similar to LGT but structured slightly differently and allows negative values.</p></li>
<li><p>Also has a damping parameter that reduces local trend values, thus giving more weight to global changes.</p></li>
</ul>
<p>KTR - Kernel-based Time-varying Regression</p>
<ul class="simple">
<li><p>More complex and experimental model.</p></li>
<li><p>Allows specifying multiple seasonality (e.g., daily and weekly)</p></li>
<li><p>Works more flexibly with regressors, has lower computational costs.</p></li>
<li><p>Thereâ€™s a simpler version KTRLite with fewer tunable parameters and a simpler estimation algorithm.</p></li>
</ul>
<p><strong>Which Models Weâ€™ll Choose</strong></p>
<ul class="simple">
<li><p>Weâ€™ll choose all models to test different options.</p></li>
</ul>
</section>
<section id="estimators">
<h3>5.6.3 Estimators<a class="headerlink" href="#estimators" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Estimator</strong> in the context of Orbit and statistical modeling is an algorithm or method used to train a model and estimate its parameters.</p></li>
<li><p>Simply put: itâ€™s the â€œengineâ€ that finds the best values for all coefficients in our model (trend, seasonality, regressors) so the model describes our data as accurately as possible.</p></li>
</ul>
<p>In Orbit, the following estimators exist:</p>
<ul class="simple">
<li><p><strong>â€˜stan-mapâ€™</strong> (Maximum a Posteriori)</p>
<ul>
<li><p>Fastest, point estimation of parameters. Good for rapid prototyping.</p></li>
<li><p>What it does: Finds the single best set of parameters.</p></li>
<li><p>Analogy: Looks for the highest mountain peak (maximum of distribution).</p></li>
<li><p>Disadvantages: Provides only point estimates, without full uncertainty distribution.</p></li>
</ul>
</li>
<li><p><strong>â€˜stan-mcmcâ€™</strong> (Markov Chain Monte Carlo)</p>
<ul>
<li><p>Full Bayesian inference, slowest but most accurate for uncertainty estimation.</p></li>
<li><p>What it does: Generates multiple possible parameter sets according to their distribution.</p></li>
<li><p>Analogy: Explores the entire mountain range, not just the peak.</p></li>
<li><p>Disadvantages: Very slow, requires lots of data, may have convergence issues.</p></li>
</ul>
</li>
<li><p><strong>â€˜stan-viâ€™</strong> (Variational Inference)</p>
<ul>
<li><p>Faster than MCMC, but still provides distribution.</p></li>
<li><p>What it does: Approximates posterior distribution with a simpler distribution.</p></li>
<li><p>Analogy: Looks for a â€œsimilarâ€ mountain thatâ€™s easier to describe mathematically.</p></li>
<li><p>Advantages: Faster than MCMC but provides distribution (not just point).</p></li>
<li><p>Disadvantages: Approximation may be less accurate than MCMC.</p></li>
</ul>
</li>
</ul>
<p><strong>Which estimators weâ€™ll choose</strong></p>
<ul class="simple">
<li><p>Weâ€™ll choose all estimators to test different options.</p></li>
</ul>
</section>
<section id="model-quality-evaluation">
<h3>5.6.4 Model Quality Evaluation<a class="headerlink" href="#model-quality-evaluation" title="Link to this heading">#</a></h3>
<p>As we know, in machine learning, model quality is evaluated in three main ways:</p>
<ul class="simple">
<li><p><strong>Train-test split</strong></p>
<ul>
<li><p>train the model on the first set</p></li>
<li><p>test how well it predicts on the second set</p></li>
</ul>
</li>
<li><p><strong>Cross-validation</strong></p>
<ul>
<li><p>like the previous method, but the dataset is split into train and test in multiple ways</p></li>
</ul>
</li>
<li><p><strong>Combination of the two above</strong></p>
<ul>
<li><p>separate test set, perform cross-validation on train, then additionally test the model on test set</p></li>
</ul>
</li>
</ul>
<p>However, in the classical version, these approaches donâ€™t work for time series</p>
<ul class="simple">
<li><p>because our observations are not independent but connected through time.</p></li>
<li><p>This must be accounted for - and in Orbit this is implemented through the concept of <strong>backtesting</strong>.</p></li>
</ul>
<p>Backtesting in Orbit is implemented in two different variants:</p>
<ul class="simple">
<li><p><strong>Expanding window</strong></p>
<ul>
<li><p>Starts with a small training data size and gradually increases it until data runs out.</p></li>
<li><p>This allows evaluating how prediction accuracy changes with increasing information.</p></li>
<li><p>This window type works best if data isnâ€™t too volatile and thereâ€™s important information in the distant past useful for future prediction.</p></li>
</ul>
</li>
<li><p><strong>Rolling window</strong></p>
<ul>
<li><p>In rolling, the training data size doesnâ€™t change - it shifts over time.</p></li>
<li><p>This variant is useful if our data is volatile and the main prediction information is in the recent past.</p></li>
</ul>
</li>
</ul>
<p><strong>Information Criteria</strong></p>
<ul class="simple">
<li><p>Information criteria - a measure of relative model quality.</p></li>
<li><p>Their task is to select the model with maximum predictive capability and minimum predictors.</p></li>
<li><p>We can use them to choose the best model.</p></li>
</ul>
<p>Main information criteria:</p>
<ul class="simple">
<li><p><strong>AIC</strong> (Akaike Information Criterion)</p>
<ul>
<li><p>Penalizes for model complexity</p></li>
</ul>
</li>
<li><p><strong>BIC</strong> (Bayesian Information Criterion)</p>
<ul>
<li><p>Penalizes for complexity more strongly than AIC, especially with large n</p></li>
</ul>
</li>
</ul>
<p>How to interpret:</p>
<ul class="simple">
<li><p>The <strong>LOWER</strong> the criterion value - the <strong>BETTER</strong> the model</p></li>
</ul>
<p><strong>Model Quality Metrics</strong></p>
<ul class="simple">
<li><p><strong>Mean Squared Error (mse)</strong></p>
<ul>
<li><p>average squared errors</p></li>
<li><p>sum of squared deviations of predicted values from actual divided by number of observations</p></li>
</ul>
</li>
<li><p><strong>Mean Absolute Error (mae)</strong></p>
<ul>
<li><p>mean absolute error</p></li>
<li><p>like previous but uses absolute value instead of square</p></li>
<li><p>compared to previous metric, this gives less weight to anomalously incorrect predictions (e.g., data outliers)</p></li>
</ul>
</li>
<li><p><strong>Root Mean Squared Scaled Error (rmsse)</strong></p>
<ul>
<li><p>similar to MSE but with additional feature</p></li>
<li><p>shows how much worse our model is than if we simply guessed based on previous values</p></li>
</ul>
</li>
<li><p><strong>Mean Absolute Percentage Error (mape)</strong></p>
<ul>
<li><p>similar to MAE but expressed as fractions of the true value</p></li>
<li><p>easily interpreted but has major drawback - metric is biased toward models that â€œunderpredictâ€ and penalizes models with â€œoverpredictionâ€</p></li>
</ul>
</li>
<li><p><strong>Symmetric Mean Absolute Percentage Error (smape)</strong></p>
<ul>
<li><p>corrected version of previous metric so underpredictions have same weight as overpredictions</p></li>
<li><p>symmetric version of MAPE. Error relative to average of actual and forecast values.</p></li>
</ul>
</li>
<li><p><strong>Weighted Mean Absolute Percentage Error (wmape)</strong></p>
<ul>
<li><p>weighted version of MAPE</p></li>
<li><p>each observation is given additional specific weight by which the â€œcontributionâ€ of particular observation is evaluated - in Orbit, greater weight is given to largest absolute observations relative to time series</p></li>
<li><p>weighted average error. Shows proportion of total error relative to total data volume.</p></li>
</ul>
</li>
<li><p><strong>Weighted Symmetric Mean Absolute Percentage Error (wsmape)</strong></p>
<ul>
<li><p>combination of the two previous points</p></li>
</ul>
</li>
</ul>
<p><strong>How weâ€™ll check model quality</strong></p>
<ul class="simple">
<li><p>Weâ€™ll train models in a loop</p></li>
<li><p>Save their bic (for map) and wbic (for others)</p></li>
<li><p>Save plots for mcmc models for obs_sigma parameter</p>
<ul>
<li><p>this is important because if mcmc model doesnâ€™t converge, its estimates are incorrect</p></li>
<li><p>Visually, the plot should look like 4 time series jumping around approximately the same value</p></li>
<li><p>This means different algorithm instances arrived at the same conclusion regarding parameters!</p></li>
</ul>
</li>
<li><p>For each model, conduct backtesting and save metrics</p>
<ul>
<li><p>weâ€™ll conduct backtesting for both expanding and rolling windows</p></li>
</ul>
</li>
<li><p>Finally, build plots for mcmc and examine backtesting metrics</p></li>
<li><p>Weâ€™ll use smape rolling backtest as the main quality metric</p>
<ul>
<li><p>Rolling backtest more accurately evaluates the model as it considers a specific window</p></li>
<li><p>Expanding may average errors over the entire period</p></li>
</ul>
</li>
</ul>
</section>
<section id="regularization">
<h3>5.6.5 Regularization<a class="headerlink" href="#regularization" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Very often, to solve overfitting problems, ML specialists resort to <strong>regularization</strong> technique</p></li>
<li><p>This is applying additional penalties to model coefficients so they donâ€™t become too large, especially if the regressor is poor.</p></li>
</ul>
<p>Main types of regularization:</p>
<ul class="simple">
<li><p><strong>L1-regularization (Lasso):</strong></p>
<ul>
<li><p>Adds sum of absolute weights to loss function</p></li>
<li><p>Promotes zeroing of unnecessary weights, allowing selection of only important features</p></li>
<li><p>Simplifies model, which may save resources</p></li>
</ul>
</li>
<li><p><strong>L2-regularization (Ridge):</strong></p>
<ul>
<li><p>Adds sum of squared weights to loss function</p></li>
<li><p>Reduces influence of large weights, smoothing peaks in activation function</p></li>
<li><p>Helps avoid overfitting while maintaining all features</p></li>
</ul>
</li>
</ul>
<p>In Orbit, <code class="docutils literal notranslate"><span class="pre">fixed_ridge</span></code> is used by default.</p>
<p><strong>How weâ€™ll do regularization</strong></p>
<ul class="simple">
<li><p>For some models, weâ€™ll add variants with auto_ridge and lasso regularization</p></li>
<li><p>This will help understand if regularization helps</p></li>
</ul>
</section>
<section id="parameter-selection-for-backtesting">
<h3>5.6.6 Parameter Selection for Backtesting<a class="headerlink" href="#parameter-selection-for-backtesting" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Since weâ€™re forecasting for a week (7 days), weâ€™ll choose the smallest data chunk to start training as 28 (4 Ã— 7)</p></li>
<li><p>I think this will be the optimal balance between number of iterations and minimum data chunk.</p></li>
</ul>
<p>Set backtest parameters</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backtest_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;min_train_len&#39;</span><span class="p">:</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s1">&#39;incremental_len&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s1">&#39;forecast_len&#39;</span><span class="p">:</span> <span class="mi">7</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="model-definition">
<h3>5.6.7 Model Definition<a class="headerlink" href="#model-definition" title="Link to this heading">#</a></h3>
<p>Weâ€™ll test the following models:</p>
<ul class="simple">
<li><p><strong>ETS</strong></p>
<ul>
<li><p>with estimator stan-map without regressors and trend</p></li>
<li><p>with estimator stan-mcmc without regressors and trend</p></li>
</ul>
</li>
<li><p><strong>LGT</strong></p>
<ul>
<li><p>with estimator stan-map without regressors</p></li>
<li><p>with estimator stan-mcmc without regressors</p></li>
<li><p>with estimator stan-map with regressors</p></li>
<li><p>with estimator stan-mcmc with regressors</p></li>
</ul>
</li>
<li><p><strong>DLT</strong></p>
<ul>
<li><p>with estimator stan-map without regressors and with linear trend</p></li>
<li><p>with estimator stan-map without regressors and with loglinear trend</p></li>
<li><p>with estimator stan-mcmc without regressors and with linear trend</p></li>
<li><p>with estimator stan-mcmc without regressors and with linear trend and with auto_ridge regularization</p></li>
<li><p>with estimator stan-mcmc without regressors and with linear trend and with lasso regularization</p></li>
<li><p>with estimator stan-mcmc without regressors and with loglinear trend</p></li>
<li><p>with estimator stan-map with regressors and with linear trend</p></li>
<li><p>with estimator stan-map with regressors and with linear trend and with auto_ridge regularization</p></li>
<li><p>with estimator stan-map with regressors and with linear trend and with lasso regularization</p></li>
<li><p>with estimator stan-map with regressors and with loglinear trend</p></li>
<li><p>with estimator stan-mcmc with regressors and with linear trend</p></li>
<li><p>with estimator stan-mcmc with regressors and with linear trend and with auto_ridge regularization</p></li>
<li><p>with estimator stan-mcmc with regressors and with linear trend and with lasso regularization</p></li>
<li><p>with estimator stan-mcmc with regressors and with loglinear trend</p></li>
</ul>
</li>
<li><p><strong>KTR</strong></p>
<ul>
<li><p>with estimator pyro-svi without regressors</p></li>
<li><p>with estimator pyro-svi with regressors</p></li>
</ul>
</li>
</ul>
<p>For total number of actions, weâ€™ll additionally add models with DAU regressor:</p>
<ul class="simple">
<li><p><strong>DLT</strong></p>
<ul>
<li><p>with estimator stan-map with regressors (+ DAU as regressor) and with linear trend</p></li>
<li><p>with estimator stan-map with regressors (+ DAU as regressor) and with linear trend and with auto_ridge regularization</p></li>
<li><p>with estimator stan-mcmc with regressors (+ DAU as regressor) and with linear trend</p></li>
</ul>
</li>
</ul>
<p><strong>How weâ€™ll define models</strong></p>
<ul class="simple">
<li><p>Each model takes up space and backtesters also take up space</p></li>
<li><p>Simply creating models would be inefficient</p></li>
<li><p>Better to create a config with all models</p></li>
<li><p>If needed, we can run the required model separately</p></li>
<li><p>Create a function to set configs for different metrics</p></li>
</ul>
</section>
<section id="creating-function-for-model-configs">
<h3>5.6.8 Creating Function for Model Configs<a class="headerlink" href="#creating-function-for-model-configs" title="Link to this heading">#</a></h3>
<p>Create a function that will return model configs for different metrics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_models_config</span><span class="p">(</span><span class="n">response_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return model config for chosen metric&quot;&quot;&quot;</span>
    <span class="n">base_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;response_col&#39;</span><span class="p">:</span> <span class="n">response_col</span><span class="p">,</span>
        <span class="s1">&#39;date_col&#39;</span><span class="p">:</span> <span class="n">date_col</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">models_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># ETS models</span>
        <span class="s1">&#39;ets_map&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">ETS</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-map&#39;</span><span class="p">,</span>
                <span class="s1">&#39;n_bootstrap_draws&#39;</span><span class="p">:</span> <span class="n">n_bootstrap_draws</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;ets_mcmc&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">ETS</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-mcmc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;num_warmup&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;num_sample&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;stan_mcmc_args&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;show_progress&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="c1"># LGT models</span>
        <span class="s1">&#39;lgt_map&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">LGT</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-map&#39;</span><span class="p">,</span>
                <span class="s1">&#39;n_bootstrap_draws&#39;</span><span class="p">:</span> <span class="n">n_bootstrap_draws</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;lgt_mcmc&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">LGT</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-mcmc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;num_warmup&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;num_sample&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;stan_mcmc_args&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;show_progress&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;lgt_map_reg&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">LGT</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;regressor_col&#39;</span><span class="p">:</span> <span class="n">regressor_cols</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-map&#39;</span><span class="p">,</span>
                <span class="s1">&#39;n_bootstrap_draws&#39;</span><span class="p">:</span> <span class="n">n_bootstrap_draws</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;lgt_mcmc_reg&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">LGT</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;regressor_col&#39;</span><span class="p">:</span> <span class="n">regressor_cols</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-mcmc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;num_warmup&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;num_sample&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;stan_mcmc_args&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;show_progress&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="c1"># DLT models</span>
        <span class="s1">&#39;dlt_map_linear&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">DLT</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;global_trend_option&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-map&#39;</span><span class="p">,</span>
                <span class="s1">&#39;n_bootstrap_draws&#39;</span><span class="p">:</span> <span class="n">n_bootstrap_draws</span>
            <span class="p">}</span>
        <span class="p">},</span>      
        <span class="s1">&#39;dlt_map_loglinear&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">DLT</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;global_trend_option&#39;</span><span class="p">:</span> <span class="s1">&#39;loglinear&#39;</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-map&#39;</span><span class="p">,</span>
                <span class="s1">&#39;n_bootstrap_draws&#39;</span><span class="p">:</span> <span class="n">n_bootstrap_draws</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;dlt_mcmc_linear&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">DLT</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;global_trend_option&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-mcmc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;num_warmup&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;num_sample&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;stan_mcmc_args&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;show_progress&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;dlt_mcmc_loglinear&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">DLT</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;global_trend_option&#39;</span><span class="p">:</span> <span class="s1">&#39;loglinear&#39;</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-mcmc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;num_warmup&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;num_sample&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;stan_mcmc_args&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;show_progress&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;dlt_map_reg_linear&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">DLT</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;regressor_col&#39;</span><span class="p">:</span> <span class="n">regressor_cols</span><span class="p">,</span>
                <span class="s1">&#39;global_trend_option&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-map&#39;</span><span class="p">,</span>
                <span class="s1">&#39;n_bootstrap_draws&#39;</span><span class="p">:</span> <span class="n">n_bootstrap_draws</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;dlt_map_reg_linear_ridge&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">DLT</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;regressor_col&#39;</span><span class="p">:</span> <span class="n">regressor_cols</span><span class="p">,</span>
                <span class="s1">&#39;global_trend_option&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-map&#39;</span><span class="p">,</span>
                <span class="s1">&#39;n_bootstrap_draws&#39;</span><span class="p">:</span> <span class="n">n_bootstrap_draws</span><span class="p">,</span>
                <span class="s1">&#39;regression_penalty&#39;</span><span class="p">:</span> <span class="s2">&quot;auto_ridge&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;dlt_map_reg_linear_lasso&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">DLT</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;regressor_col&#39;</span><span class="p">:</span> <span class="n">regressor_cols</span><span class="p">,</span>
                <span class="s1">&#39;global_trend_option&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-map&#39;</span><span class="p">,</span>
                <span class="s1">&#39;n_bootstrap_draws&#39;</span><span class="p">:</span> <span class="n">n_bootstrap_draws</span><span class="p">,</span>
                <span class="s1">&#39;regression_penalty&#39;</span><span class="p">:</span> <span class="s2">&quot;lasso&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>        
        <span class="s1">&#39;dlt_map_reg_loglinear&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">DLT</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;regressor_col&#39;</span><span class="p">:</span> <span class="n">regressor_cols</span><span class="p">,</span>
                <span class="s1">&#39;global_trend_option&#39;</span><span class="p">:</span> <span class="s1">&#39;loglinear&#39;</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-map&#39;</span><span class="p">,</span>
                <span class="s1">&#39;n_bootstrap_draws&#39;</span><span class="p">:</span> <span class="n">n_bootstrap_draws</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;dlt_mcmc_reg_linear&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">DLT</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;regressor_col&#39;</span><span class="p">:</span> <span class="n">regressor_cols</span><span class="p">,</span>
                <span class="s1">&#39;global_trend_option&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-mcmc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;num_warmup&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;num_sample&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;stan_mcmc_args&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;show_progress&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;dlt_mcmc_reg_linear_ridge&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">DLT</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;regressor_col&#39;</span><span class="p">:</span> <span class="n">regressor_cols</span><span class="p">,</span>
                <span class="s1">&#39;global_trend_option&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-mcmc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;num_warmup&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;num_sample&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;stan_mcmc_args&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;show_progress&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
                <span class="s1">&#39;regression_penalty&#39;</span><span class="p">:</span> <span class="s2">&quot;auto_ridge&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;dlt_mcmc_reg_linear_lasso&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">DLT</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;regressor_col&#39;</span><span class="p">:</span> <span class="n">regressor_cols</span><span class="p">,</span>
                <span class="s1">&#39;global_trend_option&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-mcmc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;num_warmup&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;num_sample&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;stan_mcmc_args&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;show_progress&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
                <span class="s1">&#39;regression_penalty&#39;</span><span class="p">:</span> <span class="s2">&quot;lasso&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;dlt_mcmc_reg_loglinear&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">DLT</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;regressor_col&#39;</span><span class="p">:</span> <span class="n">regressor_cols</span><span class="p">,</span>
                <span class="s1">&#39;global_trend_option&#39;</span><span class="p">:</span> <span class="s1">&#39;loglinear&#39;</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-mcmc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;num_warmup&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;num_sample&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;stan_mcmc_args&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;show_progress&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="c1"># KTR models</span>
        <span class="s1">&#39;ktr&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">KTR</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;pyro-svi&#39;</span><span class="p">,</span>
                <span class="s1">&#39;n_bootstrap_draws&#39;</span><span class="p">:</span> <span class="n">n_bootstrap_draws</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;ktr_reg&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">KTR</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;pyro-svi&#39;</span><span class="p">,</span>
                <span class="s1">&#39;n_bootstrap_draws&#39;</span><span class="p">:</span> <span class="n">n_bootstrap_draws</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1"># Add models with DAU regressor</span>
    <span class="k">if</span> <span class="n">response_col</span> <span class="o">==</span> <span class="s1">&#39;actions&#39;</span><span class="p">:</span>
        <span class="n">models_config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;dlt_map_reg_users_linear&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">DLT</span><span class="p">,</span>
                <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                    <span class="s1">&#39;regressor_col&#39;</span><span class="p">:</span> <span class="n">regressor_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;global_trend_option&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-map&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;n_bootstrap_draws&#39;</span><span class="p">:</span> <span class="n">n_bootstrap_draws</span>
                <span class="p">}</span>
            <span class="p">},</span>     
            <span class="s1">&#39;dlt_map_reg_users_linear_ridge&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">DLT</span><span class="p">,</span>
                <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                    <span class="s1">&#39;regressor_col&#39;</span><span class="p">:</span> <span class="n">regressor_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;global_trend_option&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-map&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;n_bootstrap_draws&#39;</span><span class="p">:</span> <span class="n">n_bootstrap_draws</span><span class="p">,</span>
                    <span class="s1">&#39;regression_penalty&#39;</span><span class="p">:</span> <span class="s2">&quot;auto_ridge&quot;</span>
                <span class="p">}</span>
            <span class="p">},</span>            
            <span class="s1">&#39;dlt_mcmc_reg_users_linear&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">DLT</span><span class="p">,</span>
                <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="o">**</span><span class="n">base_params</span><span class="p">,</span>
                    <span class="s1">&#39;regressor_col&#39;</span><span class="p">:</span> <span class="n">regressor_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;global_trend_option&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="s1">&#39;stan-mcmc&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;num_warmup&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                    <span class="s1">&#39;num_sample&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                    <span class="s1">&#39;stan_mcmc_args&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;show_progress&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
                <span class="p">}</span>
            <span class="p">},</span>                      
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">models_config</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="creating-function-for-model-evaluation">
<h3>5.6.9 Creating Function for Model Evaluation<a class="headerlink" href="#creating-function-for-model-evaluation" title="Link to this heading">#</a></h3>
<p>Create a function to evaluate a single model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_single_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">backtest_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluates one model and returns all metrics.&quot;&quot;&quot;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model processing: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">}</span>
    <span class="n">mcmc_plot</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bt_plot</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># Create and train model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_class&#39;</span><span class="p">](</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    
    <span class="c1"># Add information criteria and plots for mcmc</span>
    <span class="n">estimator</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;estimator&#39;</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">estimator</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;stan-mcmc&#39;</span><span class="p">,</span> <span class="s1">&#39;pyro-svi&#39;</span><span class="p">]:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit_wbic</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;wbic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_wbic</span><span class="p">()</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;bic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">estimator</span> <span class="o">==</span> <span class="s1">&#39;stan-mcmc&#39;</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_posterior_samples</span><span class="p">(</span><span class="n">permute</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Extract parameter information</span>
            <span class="n">mcmc_plot</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">chain_prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]},</span> <span class="n">var_names</span> <span class="o">=</span> <span class="s2">&quot;obs_sigma&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;wbic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;bic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_bic</span><span class="p">()</span>
    
    <span class="c1"># Backtesting for expanding and rolling windows</span>
    <span class="k">for</span> <span class="n">window_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;expanding&#39;</span><span class="p">,</span> <span class="s1">&#39;rolling&#39;</span><span class="p">]:</span>
        <span class="n">backtester</span> <span class="o">=</span> <span class="n">BackTester</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_class&#39;</span><span class="p">](</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]),</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
            <span class="n">window_type</span><span class="o">=</span><span class="n">window_type</span><span class="p">,</span>
            <span class="o">**</span><span class="n">backtest_params</span>
        <span class="p">)</span>
        <span class="n">backtester</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">()</span>
        <span class="n">predicted_df</span> <span class="o">=</span> <span class="n">backtester</span><span class="o">.</span><span class="n">get_predicted_df</span><span class="p">()</span>
        <span class="c1"># Save plot with backtesting stages.</span>
        <span class="n">bt_plot</span> <span class="o">=</span> <span class="n">plot_bt_predictions</span><span class="p">(</span><span class="n">predicted_df</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">smape</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">include_vline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># Extract all metrics from backtester.score()</span>
        <span class="n">score_df</span> <span class="o">=</span> <span class="n">backtester</span><span class="o">.</span><span class="n">score</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">score_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">col_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">window_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;metric_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">results</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;metric_values&#39;</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">mcmc_plot</span><span class="p">,</span> <span class="n">bt_plot</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="model-analysis">
<h2>5.7 Model Analysis<a class="headerlink" href="#model-analysis" title="Link to this heading">#</a></h2>
<section id="total-dau">
<h3>5.7.1 Total DAU<a class="headerlink" href="#total-dau" title="Link to this heading">#</a></h3>
<p>Create a dataframe for convenience.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models_config_dau</span> <span class="o">=</span> <span class="n">get_models_config</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models_meta</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">models_config_dau</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">models_meta</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_class&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;has_regressors&#39;</span><span class="p">:</span> <span class="s1">&#39;regressor_col&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">],</span>
        <span class="s1">&#39;trend_type&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;global_trend_option&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> 
        <span class="s1">&#39;regression_penalty&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;regression_penalty&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="p">})</span>

<span class="n">df_results_dau</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">models_meta</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
<span class="n">df_results_dau</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>model_class</th>
      <th>estimator</th>
      <th>has_regressors</th>
      <th>trend_type</th>
      <th>regression_penalty</th>
    </tr>
    <tr>
      <th>name</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>ets_map</th>
      <td>ETS</td>
      <td>stan-map</td>
      <td>False</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>ets_mcmc</th>
      <td>ETS</td>
      <td>stan-mcmc</td>
      <td>False</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>lgt_map</th>
      <td>LGT</td>
      <td>stan-map</td>
      <td>False</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>lgt_mcmc</th>
      <td>LGT</td>
      <td>stan-mcmc</td>
      <td>False</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>lgt_map_reg</th>
      <td>LGT</td>
      <td>stan-map</td>
      <td>True</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>lgt_mcmc_reg</th>
      <td>LGT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_map_linear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>False</td>
      <td>linear</td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_map_loglinear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>False</td>
      <td>loglinear</td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_mcmc_linear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>False</td>
      <td>linear</td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_mcmc_loglinear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>False</td>
      <td>loglinear</td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_map_reg_linear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>linear</td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_map_reg_linear_ridge</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>linear</td>
      <td>auto_ridge</td>
    </tr>
    <tr>
      <th>dlt_map_reg_linear_lasso</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>linear</td>
      <td>lasso</td>
    </tr>
    <tr>
      <th>dlt_map_reg_loglinear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>loglinear</td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_linear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>linear</td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_linear_ridge</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>linear</td>
      <td>auto_ridge</td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_linear_lasso</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>linear</td>
      <td>lasso</td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_loglinear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>loglinear</td>
      <td></td>
    </tr>
    <tr>
      <th>ktr</th>
      <td>KTR</td>
      <td>pyro-svi</td>
      <td>False</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>ktr_reg</th>
      <td>KTR</td>
      <td>pyro-svi</td>
      <td>False</td>
      <td></td>
      <td></td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="processing-execution">
<h4>5.7.1.1 Processing Execution<a class="headerlink" href="#processing-execution" title="Link to this heading">#</a></h4>
<p>Start processing</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Let&#39;s start the assessment </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">models_config_dau</span><span class="p">)</span><span class="si">}</span><span class="s2"> models&quot;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">mcmc_plots</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">bt_plots</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">models_config_dau</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">mcmc_plot</span><span class="p">,</span> <span class="n">bt_plot</span> <span class="o">=</span> <span class="n">evaluate_single_model</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">backtest_params</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">mcmc_plots</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcmc_plot</span>
    <span class="n">bt_plots</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">bt_plot</span>
</pre></div>
</div>
</div>
</div>
<p>Create final DataFrame</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="n">df_results</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Merge with meta-information.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_results_dau</span> <span class="o">=</span> <span class="n">df_results_dau</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_results</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="results-analysis">
<h4>5.7.1.2 Results Analysis<a class="headerlink" href="#results-analysis" title="Link to this heading">#</a></h4>
<p>Letâ€™s examine the results.</p>
<p>First, letâ€™s check if mcmc models converged.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">plot</span> <span class="ow">in</span> <span class="n">mcmc_plots</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>        
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>
        <span class="n">display</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span> 
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: ets_mcmc
</pre></div>
</div>
<img alt="../../_images/f6f63e64cbd69d05b8a46b8b1f3d00ef253449dacba82ad3eb395fe85cf8b21c.png" src="../../_images/f6f63e64cbd69d05b8a46b8b1f3d00ef253449dacba82ad3eb395fe85cf8b21c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: lgt_mcmc
</pre></div>
</div>
<img alt="../../_images/d091dd3134eb5baa6f36439b483f2eb946014f9b6af26e90eb18a25aed8cbb1e.png" src="../../_images/d091dd3134eb5baa6f36439b483f2eb946014f9b6af26e90eb18a25aed8cbb1e.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: lgt_mcmc_reg
</pre></div>
</div>
<img alt="../../_images/9dcc396b5ea7081b874e8ec91234cb68b6cb87c56b60734e245666f3365fe488.png" src="../../_images/9dcc396b5ea7081b874e8ec91234cb68b6cb87c56b60734e245666f3365fe488.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: dlt_mcmc_linear
</pre></div>
</div>
<img alt="../../_images/e8135e345097dacdf1e0508c2b12d17e5652e28ac1644b8899fb1cbf49c8d1f1.png" src="../../_images/e8135e345097dacdf1e0508c2b12d17e5652e28ac1644b8899fb1cbf49c8d1f1.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: dlt_mcmc_loglinear
</pre></div>
</div>
<img alt="../../_images/5e442815810e9999189b1a9b7a649e9f538d2ce04db7d38d7cc4c9f87d01607b.png" src="../../_images/5e442815810e9999189b1a9b7a649e9f538d2ce04db7d38d7cc4c9f87d01607b.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: dlt_mcmc_reg_linear
</pre></div>
</div>
<img alt="../../_images/a6892ee9590ae313cba242a44097544be6c19b6dfc1ba95d30f50d9cfba46cb3.png" src="../../_images/a6892ee9590ae313cba242a44097544be6c19b6dfc1ba95d30f50d9cfba46cb3.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: dlt_mcmc_reg_linear_ridge
</pre></div>
</div>
<img alt="../../_images/02706a5d52c12f58bbcc1d03b6064ab89fc552c203899071d860e512f8806799.png" src="../../_images/02706a5d52c12f58bbcc1d03b6064ab89fc552c203899071d860e512f8806799.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: dlt_mcmc_reg_linear_lasso
</pre></div>
</div>
<img alt="../../_images/dc45e2c6308438bdc48638c73b6055a4551cac9b5de3ea119d54d67d2e85416f.png" src="../../_images/dc45e2c6308438bdc48638c73b6055a4551cac9b5de3ea119d54d67d2e85416f.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: dlt_mcmc_reg_loglinear
</pre></div>
</div>
<img alt="../../_images/66074791ade5a72ba98728ec7ed6a3bf756deb6f2fbfa989988dbd54ab162d99.png" src="../../_images/66074791ade5a72ba98728ec7ed6a3bf756deb6f2fbfa989988dbd54ab162d99.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Model dlt_mcmc_reg_linear_ridge (DLT with mcmc, linear trend and regressors) has a not very good plot.</p></li>
<li><p>Itâ€™s better not to trust its metrics.</p></li>
</ul>
<p>Letâ€™s examine the metrics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_results_dau</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;rolling_smape&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>model_class</th>
      <th>estimator</th>
      <th>has_regressors</th>
      <th>trend_type</th>
      <th>regression_penalty</th>
      <th>wbic</th>
      <th>bic</th>
      <th>expanding_smape</th>
      <th>expanding_wmape</th>
      <th>expanding_mape</th>
      <th>expanding_mse</th>
      <th>expanding_mae</th>
      <th>expanding_rmsse</th>
      <th>rolling_smape</th>
      <th>rolling_wmape</th>
      <th>rolling_mape</th>
      <th>rolling_mse</th>
      <th>rolling_mae</th>
      <th>rolling_rmsse</th>
    </tr>
    <tr>
      <th>name</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>dlt_map_linear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>False</td>
      <td>linear</td>
      <td></td>
      <td>NaN</td>
      <td>1,291.923</td>
      <td>0.045</td>
      <td>0.047</td>
      <td>0.047</td>
      <td>1,714,451.427</td>
      <td>898.276</td>
      <td>1.158</td>
      <td>0.039</td>
      <td>0.039</td>
      <td>0.040</td>
      <td>1,156,992.788</td>
      <td>751.716</td>
      <td>0.951</td>
    </tr>
    <tr>
      <th>dlt_map_reg_linear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>linear</td>
      <td></td>
      <td>NaN</td>
      <td>1,296.253</td>
      <td>0.044</td>
      <td>0.046</td>
      <td>0.046</td>
      <td>1,679,536.284</td>
      <td>885.120</td>
      <td>1.146</td>
      <td>0.039</td>
      <td>0.040</td>
      <td>0.040</td>
      <td>1,169,642.211</td>
      <td>760.170</td>
      <td>0.956</td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_linear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>linear</td>
      <td></td>
      <td>1,281.638</td>
      <td>NaN</td>
      <td>0.045</td>
      <td>0.046</td>
      <td>0.047</td>
      <td>1,551,645.937</td>
      <td>886.006</td>
      <td>1.101</td>
      <td>0.041</td>
      <td>0.041</td>
      <td>0.042</td>
      <td>1,203,225.215</td>
      <td>790.595</td>
      <td>0.970</td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_linear_ridge</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>linear</td>
      <td>auto_ridge</td>
      <td>1,280.667</td>
      <td>NaN</td>
      <td>0.046</td>
      <td>0.047</td>
      <td>0.047</td>
      <td>1,582,144.484</td>
      <td>897.954</td>
      <td>1.112</td>
      <td>0.041</td>
      <td>0.042</td>
      <td>0.042</td>
      <td>1,206,715.936</td>
      <td>791.483</td>
      <td>0.971</td>
    </tr>
    <tr>
      <th>dlt_mcmc_linear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>False</td>
      <td>linear</td>
      <td></td>
      <td>1,281.915</td>
      <td>NaN</td>
      <td>0.045</td>
      <td>0.046</td>
      <td>0.047</td>
      <td>1,549,721.971</td>
      <td>886.623</td>
      <td>1.101</td>
      <td>0.041</td>
      <td>0.042</td>
      <td>0.042</td>
      <td>1,208,392.630</td>
      <td>791.902</td>
      <td>0.972</td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_linear_lasso</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>linear</td>
      <td>lasso</td>
      <td>1,281.635</td>
      <td>NaN</td>
      <td>0.045</td>
      <td>0.046</td>
      <td>0.047</td>
      <td>1,540,556.175</td>
      <td>883.680</td>
      <td>1.097</td>
      <td>0.041</td>
      <td>0.042</td>
      <td>0.042</td>
      <td>1,210,013.541</td>
      <td>792.952</td>
      <td>0.973</td>
    </tr>
    <tr>
      <th>lgt_map</th>
      <td>LGT</td>
      <td>stan-map</td>
      <td>False</td>
      <td></td>
      <td></td>
      <td>NaN</td>
      <td>1,295.670</td>
      <td>0.054</td>
      <td>0.051</td>
      <td>0.053</td>
      <td>1,513,426.190</td>
      <td>977.693</td>
      <td>1.088</td>
      <td>0.050</td>
      <td>0.048</td>
      <td>0.049</td>
      <td>1,307,783.548</td>
      <td>911.900</td>
      <td>1.011</td>
    </tr>
    <tr>
      <th>lgt_map_reg</th>
      <td>LGT</td>
      <td>stan-map</td>
      <td>True</td>
      <td></td>
      <td></td>
      <td>NaN</td>
      <td>1,299.570</td>
      <td>0.042</td>
      <td>0.042</td>
      <td>0.042</td>
      <td>1,260,426.071</td>
      <td>795.188</td>
      <td>0.993</td>
      <td>0.051</td>
      <td>0.053</td>
      <td>0.053</td>
      <td>1,927,233.359</td>
      <td>1,018.170</td>
      <td>1.227</td>
    </tr>
    <tr>
      <th>lgt_mcmc_reg</th>
      <td>LGT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td></td>
      <td></td>
      <td>1,284.129</td>
      <td>NaN</td>
      <td>0.057</td>
      <td>0.054</td>
      <td>0.056</td>
      <td>1,670,009.572</td>
      <td>1,030.569</td>
      <td>1.143</td>
      <td>0.052</td>
      <td>0.050</td>
      <td>0.051</td>
      <td>1,497,809.091</td>
      <td>945.191</td>
      <td>1.082</td>
    </tr>
    <tr>
      <th>lgt_mcmc</th>
      <td>LGT</td>
      <td>stan-mcmc</td>
      <td>False</td>
      <td></td>
      <td></td>
      <td>1,283.830</td>
      <td>NaN</td>
      <td>0.057</td>
      <td>0.054</td>
      <td>0.056</td>
      <td>1,674,658.308</td>
      <td>1,031.382</td>
      <td>1.144</td>
      <td>0.052</td>
      <td>0.050</td>
      <td>0.052</td>
      <td>1,502,034.354</td>
      <td>945.604</td>
      <td>1.084</td>
    </tr>
    <tr>
      <th>dlt_mcmc_loglinear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>False</td>
      <td>loglinear</td>
      <td></td>
      <td>1,273.896</td>
      <td>NaN</td>
      <td>0.053</td>
      <td>0.051</td>
      <td>0.052</td>
      <td>1,513,655.817</td>
      <td>963.724</td>
      <td>1.088</td>
      <td>0.054</td>
      <td>0.051</td>
      <td>0.053</td>
      <td>1,556,411.339</td>
      <td>978.085</td>
      <td>1.103</td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_loglinear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>loglinear</td>
      <td></td>
      <td>1,273.970</td>
      <td>NaN</td>
      <td>0.053</td>
      <td>0.050</td>
      <td>0.052</td>
      <td>1,506,668.437</td>
      <td>961.678</td>
      <td>1.085</td>
      <td>0.054</td>
      <td>0.052</td>
      <td>0.053</td>
      <td>1,570,156.064</td>
      <td>982.657</td>
      <td>1.108</td>
    </tr>
    <tr>
      <th>dlt_map_loglinear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>False</td>
      <td>loglinear</td>
      <td></td>
      <td>NaN</td>
      <td>1,284.297</td>
      <td>0.062</td>
      <td>0.059</td>
      <td>0.060</td>
      <td>1,852,437.265</td>
      <td>1,129.847</td>
      <td>1.203</td>
      <td>0.055</td>
      <td>0.053</td>
      <td>0.054</td>
      <td>1,620,584.781</td>
      <td>1,002.142</td>
      <td>1.125</td>
    </tr>
    <tr>
      <th>dlt_map_reg_loglinear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>loglinear</td>
      <td></td>
      <td>NaN</td>
      <td>1,288.764</td>
      <td>0.066</td>
      <td>0.063</td>
      <td>0.064</td>
      <td>2,034,041.386</td>
      <td>1,193.641</td>
      <td>1.261</td>
      <td>0.055</td>
      <td>0.053</td>
      <td>0.054</td>
      <td>1,621,648.342</td>
      <td>1,002.495</td>
      <td>1.126</td>
    </tr>
    <tr>
      <th>dlt_map_reg_linear_lasso</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>linear</td>
      <td>lasso</td>
      <td>NaN</td>
      <td>1,304.658</td>
      <td>0.073</td>
      <td>0.067</td>
      <td>0.070</td>
      <td>2,452,961.562</td>
      <td>1,269.926</td>
      <td>1.385</td>
      <td>0.064</td>
      <td>0.059</td>
      <td>0.062</td>
      <td>2,011,862.834</td>
      <td>1,117.972</td>
      <td>1.254</td>
    </tr>
    <tr>
      <th>ets_map</th>
      <td>ETS</td>
      <td>stan-map</td>
      <td>False</td>
      <td></td>
      <td></td>
      <td>NaN</td>
      <td>1,277.349</td>
      <td>0.076</td>
      <td>0.070</td>
      <td>0.072</td>
      <td>2,559,177.456</td>
      <td>1,338.118</td>
      <td>1.414</td>
      <td>0.071</td>
      <td>0.066</td>
      <td>0.068</td>
      <td>2,298,261.735</td>
      <td>1,265.359</td>
      <td>1.340</td>
    </tr>
    <tr>
      <th>ets_mcmc</th>
      <td>ETS</td>
      <td>stan-mcmc</td>
      <td>False</td>
      <td></td>
      <td></td>
      <td>1,271.572</td>
      <td>NaN</td>
      <td>0.075</td>
      <td>0.069</td>
      <td>0.071</td>
      <td>2,505,255.655</td>
      <td>1,322.227</td>
      <td>1.399</td>
      <td>0.072</td>
      <td>0.067</td>
      <td>0.069</td>
      <td>2,333,523.700</td>
      <td>1,277.272</td>
      <td>1.351</td>
    </tr>
    <tr>
      <th>ktr</th>
      <td>KTR</td>
      <td>pyro-svi</td>
      <td>False</td>
      <td></td>
      <td></td>
      <td>1,551.532</td>
      <td>NaN</td>
      <td>0.439</td>
      <td>0.359</td>
      <td>0.359</td>
      <td>48,583,595.017</td>
      <td>6,840.676</td>
      <td>6.162</td>
      <td>0.239</td>
      <td>0.197</td>
      <td>0.206</td>
      <td>17,223,647.072</td>
      <td>3,759.405</td>
      <td>3.669</td>
    </tr>
    <tr>
      <th>ktr_reg</th>
      <td>KTR</td>
      <td>pyro-svi</td>
      <td>False</td>
      <td></td>
      <td></td>
      <td>1,551.532</td>
      <td>NaN</td>
      <td>0.439</td>
      <td>0.359</td>
      <td>0.359</td>
      <td>48,583,595.017</td>
      <td>6,840.676</td>
      <td>6.162</td>
      <td>0.239</td>
      <td>0.197</td>
      <td>0.206</td>
      <td>17,223,647.072</td>
      <td>3,759.405</td>
      <td>3.669</td>
    </tr>
    <tr>
      <th>dlt_map_reg_linear_ridge</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>linear</td>
      <td>auto_ridge</td>
      <td>NaN</td>
      <td>1,323.753</td>
      <td>0.170</td>
      <td>0.140</td>
      <td>0.144</td>
      <td>14,097,677.288</td>
      <td>2,671.053</td>
      <td>3.319</td>
      <td>0.284</td>
      <td>0.240</td>
      <td>0.235</td>
      <td>29,319,185.042</td>
      <td>4,571.340</td>
      <td>4.787</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Linear trend shows better results than log-linear.</p></li>
<li><p>MAP performs better than MCMC</p>
<ul>
<li><p>most likely due to small data volume</p></li>
<li><p>Markov chains may not have time to converge on small data volume</p></li>
</ul>
</li>
<li><p>Regressors donâ€™t seem to significantly improve quality.</p></li>
<li><p>Regularization doesnâ€™t lead to metric improvement.</p></li>
<li><p>ETS and KTR showed worse results than LGT and DLT</p></li>
<li><p>DLT clearly leads in quality.</p></li>
<li><p>Ultimately, the leader is DLT model with map, without regressors, with linear trend and without regularization.</p></li>
<li><p>DLT model with map, regressors, linear trend, and without regularization shows almost the same results as the leader.</p></li>
<li><p>Since regressors donâ€™t improve quality, and their presence may lead to overfitting in the future, weâ€™ll choose the model without regressors.</p></li>
</ul>
<p><strong>Which model do we choose?</strong></p>
<ul class="simple">
<li><p>DLT model with map, without regressors, with linear trend and without regularization.</p></li>
</ul>
<p><strong>What are the metrics of the best model?</strong></p>
<ul class="simple">
<li><p>SMAPE metric in rolling backtesting has value 0.039.</p>
<ul>
<li><p>This means the model was wrong by 3.9% on average from actual data.</p></li>
<li><p>Considering the small amount of data, this is a very good result.</p></li>
</ul>
</li>
<li><p>MAE metric in rolling backtesting has value 752.</p>
<ul>
<li><p>This means the model was wrong by 752 users on average from actual data.</p></li>
</ul>
</li>
</ul>
<p>Letâ€™s examine the forecast for the last week in history.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_model_name_dau</span> <span class="o">=</span> <span class="s1">&#39;dlt_map_linear&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">now_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">now_date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)]</span>
<span class="n">test_data</span> <span class="o">=</span>  <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">now_date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">models_config_dau</span><span class="p">[</span><span class="n">best_model_name_dau</span><span class="p">]</span>
<span class="n">best_model_dau</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_class&#39;</span><span class="p">](</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>
<span class="n">best_model_dau</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
<span class="n">predicted_df</span> <span class="o">=</span> <span class="n">best_model_dau</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">test_data</span><span class="p">)</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">plot_predicted_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">predicted_df</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Prediction </span><span class="si">{</span><span class="n">best_model_name_dau</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/fb6382ebac2cfcb8c52ea5a8903f0610c1e64f5e469cc3dfefcc97bad426d55e.png" src="../../_images/fb6382ebac2cfcb8c52ea5a8903f0610c1e64f5e469cc3dfefcc97bad426d55e.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Some actual values didnâ€™t fall within the confidence interval. This is not good.</p></li>
<li><p>However, itâ€™s worth noting that a trend break occurred this week that wasnâ€™t present in the history.</p></li>
<li><p>The model isnâ€™t trained for such behavior.</p></li>
<li><p>We can conclude that the model identifies trends well, backtesting evaluations are good.</p></li>
<li><p>But to capture trend changes, they need to be present in the history.</p></li>
</ul>
<p>Letâ€™s examine how the model predicts on past data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predicted_df</span> <span class="o">=</span> <span class="n">best_model_dau</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">plot_predicted_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">predicted_df</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Prediction </span><span class="si">{</span><span class="n">best_model_name_dau</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/a3f6daff5e2920141a4efef9a6b3460ce1ba770fc6ab65b426f02dd768327850.png" src="../../_images/a3f6daff5e2920141a4efef9a6b3460ce1ba770fc6ab65b426f02dd768327850.png" />
</div>
</div>
<p>Letâ€™s examine how the model made forecasts during backtesting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">bt_plots</span><span class="p">[</span><span class="n">best_model_name_dau</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>
<span class="n">display</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span> 
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/a60454bdd821e5bbf24e49b574730391e218b98afa79184e993253e58c25c8d5.png" src="../../_images/a60454bdd821e5bbf24e49b574730391e218b98afa79184e993253e58c25c8d5.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Very good, which confirms the backtesting evaluations.</p></li>
</ul>
</section>
</section>
<section id="total-number-of-actions">
<h3>5.7.2 Total Number of Actions<a class="headerlink" href="#total-number-of-actions" title="Link to this heading">#</a></h3>
<p>Create a dataframe for convenience.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models_config_actions</span> <span class="o">=</span> <span class="n">get_models_config</span><span class="p">(</span><span class="s1">&#39;actions&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models_meta</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">models_config_actions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">models_meta</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;model_class&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_class&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;has_regressors&#39;</span><span class="p">:</span> <span class="s1">&#39;regressor_col&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">],</span>
        <span class="s1">&#39;trend_type&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;global_trend_option&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> 
        <span class="s1">&#39;regression_penalty&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;regression_penalty&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="p">})</span>

<span class="n">df_results_actions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">models_meta</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
<span class="n">df_results_actions</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>model_class</th>
      <th>estimator</th>
      <th>has_regressors</th>
      <th>trend_type</th>
      <th>regression_penalty</th>
    </tr>
    <tr>
      <th>name</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>ets_map</th>
      <td>ETS</td>
      <td>stan-map</td>
      <td>False</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>ets_mcmc</th>
      <td>ETS</td>
      <td>stan-mcmc</td>
      <td>False</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>lgt_map</th>
      <td>LGT</td>
      <td>stan-map</td>
      <td>False</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>lgt_mcmc</th>
      <td>LGT</td>
      <td>stan-mcmc</td>
      <td>False</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>lgt_map_reg</th>
      <td>LGT</td>
      <td>stan-map</td>
      <td>True</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>lgt_mcmc_reg</th>
      <td>LGT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_map_linear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>False</td>
      <td>linear</td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_map_loglinear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>False</td>
      <td>loglinear</td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_mcmc_linear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>False</td>
      <td>linear</td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_mcmc_loglinear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>False</td>
      <td>loglinear</td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_map_reg_linear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>linear</td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_map_reg_linear_ridge</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>linear</td>
      <td>auto_ridge</td>
    </tr>
    <tr>
      <th>dlt_map_reg_linear_lasso</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>linear</td>
      <td>lasso</td>
    </tr>
    <tr>
      <th>dlt_map_reg_loglinear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>loglinear</td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_linear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>linear</td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_linear_ridge</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>linear</td>
      <td>auto_ridge</td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_linear_lasso</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>linear</td>
      <td>lasso</td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_loglinear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>loglinear</td>
      <td></td>
    </tr>
    <tr>
      <th>ktr</th>
      <td>KTR</td>
      <td>pyro-svi</td>
      <td>False</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>ktr_reg</th>
      <td>KTR</td>
      <td>pyro-svi</td>
      <td>False</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_map_reg_users_linear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>linear</td>
      <td></td>
    </tr>
    <tr>
      <th>dlt_map_reg_users_linear_ridge</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>linear</td>
      <td>auto_ridge</td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_users_linear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>linear</td>
      <td></td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="id1">
<h4>5.7.2.1 Processing Execution<a class="headerlink" href="#id1" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Let&#39;s start the assessment </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">models_config_actions</span><span class="p">)</span><span class="si">}</span><span class="s2"> models&quot;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">mcmc_plots</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">bt_plots</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">models_config_actions</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">mcmc_plot</span><span class="p">,</span> <span class="n">bt_plot</span> <span class="o">=</span> <span class="n">evaluate_single_model</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">backtest_params</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">mcmc_plots</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcmc_plot</span>
    <span class="n">bt_plots</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">bt_plot</span>
</pre></div>
</div>
</div>
</div>
<p>Create final DataFrame</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="n">df_results</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Merge with meta-information.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_results_actions</span> <span class="o">=</span> <span class="n">df_results_actions</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_results</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h4>5.7.2.2 Results Analysis<a class="headerlink" href="#id2" title="Link to this heading">#</a></h4>
<p>Letâ€™s examine the results.</p>
<p>First, letâ€™s check if mcmc models converged.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">plot</span> <span class="ow">in</span> <span class="n">mcmc_plots</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>        
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>
        <span class="n">display</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span> 
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: ets_mcmc
</pre></div>
</div>
<img alt="../../_images/1b058bc441e1f96d125ce1b410ecabe13260e9da7c33cb1774481d6b9632f747.png" src="../../_images/1b058bc441e1f96d125ce1b410ecabe13260e9da7c33cb1774481d6b9632f747.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: lgt_mcmc
</pre></div>
</div>
<img alt="../../_images/565072bcff69cc0ecb15637887ab8c584ff127eca4a18e5146fe45edef100e67.png" src="../../_images/565072bcff69cc0ecb15637887ab8c584ff127eca4a18e5146fe45edef100e67.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: lgt_mcmc_reg
</pre></div>
</div>
<img alt="../../_images/65a4757cbc2ffdf47c6ebd12e17799c3f75541648eed545af852aa30b66fbbe3.png" src="../../_images/65a4757cbc2ffdf47c6ebd12e17799c3f75541648eed545af852aa30b66fbbe3.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: dlt_mcmc_linear
</pre></div>
</div>
<img alt="../../_images/f0320e122c06491d2c7f072ba41f226f26f9078555898ad63278e54347abfda3.png" src="../../_images/f0320e122c06491d2c7f072ba41f226f26f9078555898ad63278e54347abfda3.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: dlt_mcmc_loglinear
</pre></div>
</div>
<img alt="../../_images/a7555a66c8feb5a562fbdfc8b22e0e5976cbdd46c5400cc4794ccf50c8e52fd8.png" src="../../_images/a7555a66c8feb5a562fbdfc8b22e0e5976cbdd46c5400cc4794ccf50c8e52fd8.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: dlt_mcmc_reg_linear
</pre></div>
</div>
<img alt="../../_images/9323e643987454ea5de12edad52dbf740da921a35fb91df84c29a61f40445354.png" src="../../_images/9323e643987454ea5de12edad52dbf740da921a35fb91df84c29a61f40445354.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: dlt_mcmc_reg_linear_ridge
</pre></div>
</div>
<img alt="../../_images/72be499e17a0bde8ab926aaa95c3b763584a8f58e77ba5412c37339e58fdd48c.png" src="../../_images/72be499e17a0bde8ab926aaa95c3b763584a8f58e77ba5412c37339e58fdd48c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: dlt_mcmc_reg_linear_lasso
</pre></div>
</div>
<img alt="../../_images/bb9461ad693ee8b8e991ad407286cc6e6ee22f90e59aad7b29d1af95c3d0e123.png" src="../../_images/bb9461ad693ee8b8e991ad407286cc6e6ee22f90e59aad7b29d1af95c3d0e123.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: dlt_mcmc_reg_loglinear
</pre></div>
</div>
<img alt="../../_images/6e276d6253ed6dc35f08bf5d436f0e0badb8f80e1ec9d54a075d6e93f89b7e26.png" src="../../_images/6e276d6253ed6dc35f08bf5d436f0e0badb8f80e1ec9d54a075d6e93f89b7e26.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ÐœÐ¾Ð´ÐµÐ»ÑŒ: dlt_mcmc_reg_users_linear
</pre></div>
</div>
<img alt="../../_images/f78933aa43a8207a2299781f5df41794dc96f247393fce9af2da13d6f902be93.png" src="../../_images/f78933aa43a8207a2299781f5df41794dc96f247393fce9af2da13d6f902be93.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Model dlt_mcmc_reg_linear_ridge (DLT with mcmc, linear trend and regressors) again has a not very good plot.</p></li>
<li><p>Itâ€™s better not to trust its metrics.</p></li>
</ul>
<p>Letâ€™s examine the metrics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_results_actions</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;rolling_smape&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>model_class</th>
      <th>estimator</th>
      <th>has_regressors</th>
      <th>trend_type</th>
      <th>regression_penalty</th>
      <th>wbic</th>
      <th>bic</th>
      <th>expanding_smape</th>
      <th>expanding_wmape</th>
      <th>expanding_mape</th>
      <th>expanding_mse</th>
      <th>expanding_mae</th>
      <th>expanding_rmsse</th>
      <th>rolling_smape</th>
      <th>rolling_wmape</th>
      <th>rolling_mape</th>
      <th>rolling_mse</th>
      <th>rolling_mae</th>
      <th>rolling_rmsse</th>
    </tr>
    <tr>
      <th>name</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>dlt_map_reg_linear_ridge</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>linear</td>
      <td>auto_ridge</td>
      <td>NaN</td>
      <td>2,038.014</td>
      <td>0.252</td>
      <td>0.295</td>
      <td>0.291</td>
      <td>127,290,852,458.638</td>
      <td>242,354.656</td>
      <td>2.376</td>
      <td>0.201</td>
      <td>0.215</td>
      <td>0.204</td>
      <td>63,715,246,069.913</td>
      <td>176,486.122</td>
      <td>1.681</td>
    </tr>
    <tr>
      <th>dlt_map_linear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>False</td>
      <td>linear</td>
      <td></td>
      <td>NaN</td>
      <td>2,001.504</td>
      <td>0.226</td>
      <td>0.262</td>
      <td>0.264</td>
      <td>93,249,842,876.148</td>
      <td>215,072.747</td>
      <td>2.033</td>
      <td>0.214</td>
      <td>0.249</td>
      <td>0.247</td>
      <td>89,109,018,357.225</td>
      <td>204,433.197</td>
      <td>1.988</td>
    </tr>
    <tr>
      <th>lgt_map</th>
      <td>LGT</td>
      <td>stan-map</td>
      <td>False</td>
      <td></td>
      <td></td>
      <td>NaN</td>
      <td>2,003.410</td>
      <td>0.225</td>
      <td>0.257</td>
      <td>0.254</td>
      <td>88,978,365,759.254</td>
      <td>211,188.854</td>
      <td>1.986</td>
      <td>0.225</td>
      <td>0.257</td>
      <td>0.251</td>
      <td>92,532,367,207.564</td>
      <td>210,911.659</td>
      <td>2.026</td>
    </tr>
    <tr>
      <th>dlt_map_reg_users_linear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>linear</td>
      <td></td>
      <td>NaN</td>
      <td>2,008.499</td>
      <td>0.237</td>
      <td>0.274</td>
      <td>0.271</td>
      <td>103,060,834,086.444</td>
      <td>225,181.601</td>
      <td>2.138</td>
      <td>0.227</td>
      <td>0.262</td>
      <td>0.255</td>
      <td>99,962,337,641.471</td>
      <td>215,553.599</td>
      <td>2.105</td>
    </tr>
    <tr>
      <th>dlt_map_reg_linear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>linear</td>
      <td></td>
      <td>NaN</td>
      <td>2,008.594</td>
      <td>0.215</td>
      <td>0.249</td>
      <td>0.249</td>
      <td>89,050,458,037.604</td>
      <td>204,722.154</td>
      <td>1.987</td>
      <td>0.229</td>
      <td>0.265</td>
      <td>0.265</td>
      <td>92,006,895,617.693</td>
      <td>217,922.695</td>
      <td>2.020</td>
    </tr>
    <tr>
      <th>dlt_mcmc_loglinear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>False</td>
      <td>loglinear</td>
      <td></td>
      <td>2,010.483</td>
      <td>NaN</td>
      <td>0.230</td>
      <td>0.264</td>
      <td>0.261</td>
      <td>98,141,139,754.107</td>
      <td>217,364.785</td>
      <td>2.086</td>
      <td>0.232</td>
      <td>0.264</td>
      <td>0.260</td>
      <td>94,289,401,514.194</td>
      <td>217,089.350</td>
      <td>2.045</td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_loglinear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>loglinear</td>
      <td></td>
      <td>2,010.354</td>
      <td>NaN</td>
      <td>0.230</td>
      <td>0.264</td>
      <td>0.260</td>
      <td>97,703,964,746.100</td>
      <td>216,852.672</td>
      <td>2.081</td>
      <td>0.232</td>
      <td>0.265</td>
      <td>0.261</td>
      <td>94,953,178,001.871</td>
      <td>217,917.049</td>
      <td>2.052</td>
    </tr>
    <tr>
      <th>lgt_mcmc</th>
      <td>LGT</td>
      <td>stan-mcmc</td>
      <td>False</td>
      <td></td>
      <td></td>
      <td>2,003.999</td>
      <td>NaN</td>
      <td>0.236</td>
      <td>0.270</td>
      <td>0.267</td>
      <td>101,484,503,120.653</td>
      <td>222,219.332</td>
      <td>2.121</td>
      <td>0.234</td>
      <td>0.268</td>
      <td>0.264</td>
      <td>101,813,015,004.603</td>
      <td>220,611.211</td>
      <td>2.125</td>
    </tr>
    <tr>
      <th>lgt_mcmc_reg</th>
      <td>LGT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td></td>
      <td></td>
      <td>2,003.946</td>
      <td>NaN</td>
      <td>0.236</td>
      <td>0.271</td>
      <td>0.267</td>
      <td>101,822,678,264.013</td>
      <td>222,504.864</td>
      <td>2.125</td>
      <td>0.235</td>
      <td>0.269</td>
      <td>0.264</td>
      <td>102,068,105,839.183</td>
      <td>221,264.786</td>
      <td>2.127</td>
    </tr>
    <tr>
      <th>dlt_map_reg_loglinear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>loglinear</td>
      <td></td>
      <td>NaN</td>
      <td>2,008.595</td>
      <td>0.238</td>
      <td>0.270</td>
      <td>0.265</td>
      <td>101,288,677,627.201</td>
      <td>222,091.660</td>
      <td>2.119</td>
      <td>0.236</td>
      <td>0.268</td>
      <td>0.263</td>
      <td>100,154,511,653.124</td>
      <td>220,618.416</td>
      <td>2.107</td>
    </tr>
    <tr>
      <th>dlt_map_loglinear</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>False</td>
      <td>loglinear</td>
      <td></td>
      <td>NaN</td>
      <td>2,004.234</td>
      <td>0.239</td>
      <td>0.271</td>
      <td>0.265</td>
      <td>102,404,096,948.088</td>
      <td>223,090.419</td>
      <td>2.131</td>
      <td>0.236</td>
      <td>0.268</td>
      <td>0.263</td>
      <td>100,155,419,696.033</td>
      <td>220,620.629</td>
      <td>2.107</td>
    </tr>
    <tr>
      <th>ets_map</th>
      <td>ETS</td>
      <td>stan-map</td>
      <td>False</td>
      <td></td>
      <td></td>
      <td>NaN</td>
      <td>2,011.416</td>
      <td>0.239</td>
      <td>0.270</td>
      <td>0.265</td>
      <td>101,027,818,224.306</td>
      <td>222,318.959</td>
      <td>2.116</td>
      <td>0.238</td>
      <td>0.269</td>
      <td>0.263</td>
      <td>100,608,987,859.449</td>
      <td>221,080.673</td>
      <td>2.112</td>
    </tr>
    <tr>
      <th>ets_mcmc</th>
      <td>ETS</td>
      <td>stan-mcmc</td>
      <td>False</td>
      <td></td>
      <td></td>
      <td>2,006.654</td>
      <td>NaN</td>
      <td>0.241</td>
      <td>0.274</td>
      <td>0.267</td>
      <td>103,329,008,800.447</td>
      <td>225,017.923</td>
      <td>2.140</td>
      <td>0.240</td>
      <td>0.273</td>
      <td>0.266</td>
      <td>104,421,749,617.635</td>
      <td>224,534.585</td>
      <td>2.152</td>
    </tr>
    <tr>
      <th>dlt_map_reg_linear_lasso</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>linear</td>
      <td>lasso</td>
      <td>NaN</td>
      <td>2,010.881</td>
      <td>0.237</td>
      <td>0.267</td>
      <td>0.262</td>
      <td>98,342,140,446.533</td>
      <td>219,851.982</td>
      <td>2.088</td>
      <td>0.246</td>
      <td>0.278</td>
      <td>0.268</td>
      <td>107,874,104,654.271</td>
      <td>228,397.400</td>
      <td>2.187</td>
    </tr>
    <tr>
      <th>dlt_map_reg_users_linear_ridge</th>
      <td>DLT</td>
      <td>stan-map</td>
      <td>True</td>
      <td>linear</td>
      <td>auto_ridge</td>
      <td>NaN</td>
      <td>2,100.640</td>
      <td>0.257</td>
      <td>0.282</td>
      <td>0.278</td>
      <td>104,298,097,975.516</td>
      <td>232,023.123</td>
      <td>2.150</td>
      <td>0.250</td>
      <td>0.277</td>
      <td>0.272</td>
      <td>103,256,952,503.871</td>
      <td>227,807.018</td>
      <td>2.140</td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_linear_lasso</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>linear</td>
      <td>lasso</td>
      <td>2,013.235</td>
      <td>NaN</td>
      <td>0.249</td>
      <td>0.292</td>
      <td>0.298</td>
      <td>107,624,448,911.562</td>
      <td>240,347.501</td>
      <td>2.184</td>
      <td>0.254</td>
      <td>0.294</td>
      <td>0.298</td>
      <td>98,824,124,407.798</td>
      <td>242,013.220</td>
      <td>2.093</td>
    </tr>
    <tr>
      <th>lgt_map_reg</th>
      <td>LGT</td>
      <td>stan-map</td>
      <td>True</td>
      <td></td>
      <td></td>
      <td>NaN</td>
      <td>2,007.704</td>
      <td>0.256</td>
      <td>0.306</td>
      <td>0.310</td>
      <td>122,523,488,382.970</td>
      <td>251,319.783</td>
      <td>2.331</td>
      <td>0.255</td>
      <td>0.302</td>
      <td>0.304</td>
      <td>117,210,664,725.040</td>
      <td>248,650.917</td>
      <td>2.280</td>
    </tr>
    <tr>
      <th>dlt_mcmc_linear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>False</td>
      <td>linear</td>
      <td></td>
      <td>2,013.488</td>
      <td>NaN</td>
      <td>0.250</td>
      <td>0.293</td>
      <td>0.299</td>
      <td>107,931,239,511.421</td>
      <td>241,217.649</td>
      <td>2.188</td>
      <td>0.255</td>
      <td>0.296</td>
      <td>0.300</td>
      <td>100,616,193,804.783</td>
      <td>243,671.740</td>
      <td>2.112</td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_linear_ridge</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>linear</td>
      <td>auto_ridge</td>
      <td>2,013.829</td>
      <td>NaN</td>
      <td>0.251</td>
      <td>0.295</td>
      <td>0.301</td>
      <td>109,121,771,490.016</td>
      <td>242,734.604</td>
      <td>2.200</td>
      <td>0.256</td>
      <td>0.299</td>
      <td>0.304</td>
      <td>105,035,226,589.486</td>
      <td>246,098.043</td>
      <td>2.158</td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_linear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>linear</td>
      <td></td>
      <td>2,013.173</td>
      <td>NaN</td>
      <td>0.249</td>
      <td>0.293</td>
      <td>0.298</td>
      <td>107,236,392,806.766</td>
      <td>240,476.333</td>
      <td>2.181</td>
      <td>0.256</td>
      <td>0.297</td>
      <td>0.301</td>
      <td>100,327,960,523.460</td>
      <td>244,122.980</td>
      <td>2.109</td>
    </tr>
    <tr>
      <th>dlt_mcmc_reg_users_linear</th>
      <td>DLT</td>
      <td>stan-mcmc</td>
      <td>True</td>
      <td>linear</td>
      <td></td>
      <td>2,013.461</td>
      <td>NaN</td>
      <td>0.249</td>
      <td>0.293</td>
      <td>0.298</td>
      <td>107,653,093,743.077</td>
      <td>240,817.996</td>
      <td>2.185</td>
      <td>0.256</td>
      <td>0.298</td>
      <td>0.302</td>
      <td>100,824,844,458.940</td>
      <td>244,668.864</td>
      <td>2.114</td>
    </tr>
    <tr>
      <th>ktr</th>
      <td>KTR</td>
      <td>pyro-svi</td>
      <td>False</td>
      <td></td>
      <td></td>
      <td>2,164.663</td>
      <td>NaN</td>
      <td>0.419</td>
      <td>0.364</td>
      <td>0.327</td>
      <td>153,860,008,244.853</td>
      <td>299,591.535</td>
      <td>2.612</td>
      <td>0.305</td>
      <td>0.281</td>
      <td>0.259</td>
      <td>113,607,667,407.653</td>
      <td>231,273.703</td>
      <td>2.244</td>
    </tr>
    <tr>
      <th>ktr_reg</th>
      <td>KTR</td>
      <td>pyro-svi</td>
      <td>False</td>
      <td></td>
      <td></td>
      <td>2,164.663</td>
      <td>NaN</td>
      <td>0.419</td>
      <td>0.364</td>
      <td>0.327</td>
      <td>153,860,008,244.853</td>
      <td>299,591.535</td>
      <td>2.612</td>
      <td>0.305</td>
      <td>0.281</td>
      <td>0.259</td>
      <td>113,607,667,407.653</td>
      <td>231,273.703</td>
      <td>2.244</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Linear trend shows better results than log-linear.</p></li>
<li><p>MAP performs better than MCMC</p></li>
<li><p>DLT clearly leads in quality.</p></li>
<li><p>KTR showed the worst results</p></li>
<li><p>Regressors and regularization slightly improve model quality</p></li>
<li><p>Adding total DAU as a regressor doesnâ€™t improve the model.</p></li>
<li><p>The situation is ambiguous</p>
<ul>
<li><p>Models with higher BIC have better quality</p></li>
<li><p>High BIC is logical in this case since models with regressors and regularization are more complex.</p></li>
</ul>
</li>
<li><p>Ultimately, the leader is DLT model with map, regressors (without DAU regressor), linear trend and ridge regularization.</p></li>
<li><p>In second place is DLT model with map, without regressors, with linear trend and without regularization.</p></li>
<li><p>The choice is difficult, but weâ€™ll choose the simpler model since quality is similar and bic is lower for the simple one.</p></li>
</ul>
<p><strong>Which model do we choose?</strong></p>
<ul class="simple">
<li><p>DLT model with map, without regressors, with linear trend and without regularization.</p></li>
</ul>
<p><strong>What are the metrics of the best model?</strong></p>
<ul class="simple">
<li><p>SMAPE metric in rolling backtesting has value 0.214.</p>
<ul>
<li><p>This means the model was wrong by 21.4% on average from actual data.</p></li>
<li><p>Considering the small amount of data and metric variability, this is a decent result.</p></li>
</ul>
</li>
<li><p>MAE metric in rolling backtesting has value 204,433.</p>
<ul>
<li><p>This means the model was wrong by 204,433 total actions on average from actual data.</p></li>
</ul>
</li>
</ul>
<p>Letâ€™s examine the forecast for the last week in history.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_model_name_actions</span> <span class="o">=</span> <span class="s1">&#39;dlt_map_linear&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">now_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">now_date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)]</span>
<span class="n">test_data</span> <span class="o">=</span>  <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">now_date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">models_config_actions</span><span class="p">[</span><span class="n">best_model_name_actions</span><span class="p">]</span>
<span class="n">best_model_actions</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_class&#39;</span><span class="p">](</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>
<span class="n">best_model_actions</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
<span class="n">predicted_df</span> <span class="o">=</span> <span class="n">best_model_actions</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">test_data</span><span class="p">)</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">plot_predicted_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">predicted_df</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s1">&#39;actions&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Prediction </span><span class="si">{</span><span class="n">best_model_name_actions</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/7c8349337762277b0a2ea4ddc502e8db5343563173a0ecfc2a3314ac60cd981e.png" src="../../_images/7c8349337762277b0a2ea4ddc502e8db5343563173a0ecfc2a3314ac60cd981e.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Some actual values didnâ€™t fall within the confidence interval. This is not good.</p></li>
<li><p>However, itâ€™s worth noting that a trend break occurred this week (if we exclude the flash mob) that wasnâ€™t present in the history.</p></li>
<li><p>The model isnâ€™t trained for such behavior.</p></li>
</ul>
<p>Letâ€™s examine how the model predicts on past data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predicted_df</span> <span class="o">=</span> <span class="n">best_model_actions</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">plot_predicted_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">predicted_df</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s1">&#39;actions&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Prediction </span><span class="si">{</span><span class="n">best_model_name_actions</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/504058d2775586782c0a63dfb72a42a07493625a4fd9a4bf5ae98d01f2bd65ef.png" src="../../_images/504058d2775586782c0a63dfb72a42a07493625a4fd9a4bf5ae98d01f2bd65ef.png" />
</div>
</div>
<p>Letâ€™s examine how the model made forecasts during backtesting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">bt_plots</span><span class="p">[</span><span class="n">best_model_name_actions</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>
<span class="n">display</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span> 
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/985512c0da678c05132875271e9b8b322d0a936c6817feb8ad6b473a79b125d5.png" src="../../_images/985512c0da678c05132875271e9b8b322d0a936c6817feb8ad6b473a79b125d5.png" />
</div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>Average result. Metrics confirm this.</p></li>
<li><p>SMAPE metric dropped most significantly before and after the flash mob.</p></li>
<li><p>The model doesnâ€™t capture sharp changes. This is logical since such movements werenâ€™t present in the history.</p></li>
</ul>
</section>
</section>
<section id="grid-search">
<h3>5.7.3 Grid Search<a class="headerlink" href="#grid-search" title="Link to this heading">#</a></h3>
<p>Grid search - iterating through possible model parameters and checking which one gives the minimum error function value.</p>
<p>Letâ€™s do this for the trend damping parameter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">best_model_dau</span><span class="p">,</span> <span class="n">best_model_name_dau</span><span class="p">),</span> <span class="p">(</span><span class="n">best_model_actions</span><span class="p">,</span> <span class="n">best_model_name_actions</span><span class="p">)]:</span>
    <span class="n">model_res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">grid_dict</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_res</span>
    <span class="n">model_res</span><span class="p">[</span><span class="s1">&#39;best_params&#39;</span><span class="p">],</span> <span class="n">model_res</span><span class="p">[</span><span class="s1">&#39;tuned_df&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_search_orbit</span><span class="p">(</span>
        <span class="n">param_grid</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;damped_factor&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)}</span> <span class="c1"># our parameter</span>
        <span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span>
        <span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span>
        <span class="p">,</span> <span class="n">min_train_len</span><span class="o">=</span><span class="n">backtest_params</span><span class="p">[</span><span class="s1">&#39;min_train_len&#39;</span><span class="p">]</span>
        <span class="p">,</span> <span class="n">incremental_len</span><span class="o">=</span><span class="n">backtest_params</span><span class="p">[</span><span class="s1">&#39;incremental_len&#39;</span><span class="p">]</span>
        <span class="p">,</span> <span class="n">forecast_len</span><span class="o">=</span><span class="n">backtest_params</span><span class="p">[</span><span class="s1">&#39;forecast_len&#39;</span><span class="p">]</span>
        <span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span> <span class="c1"># look at default smape</span>
        <span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="s2">&quot;min&quot;</span> <span class="c1"># we say that we need minimization</span>
        <span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="c1"># don&#39;t let it print the execution process</span>
    <span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<p>Letâ€™s see the results.</p>
<p>For total DAU.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_dict</span><span class="p">[</span><span class="n">best_model_name_dau</span><span class="p">][</span><span class="s1">&#39;best_params&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;damped_factor&#39;: 0.30000000000000004}]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_dict</span><span class="p">[</span><span class="n">best_model_name_dau</span><span class="p">][</span><span class="s1">&#39;tuned_df&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>damped_factor</th>
      <th>metrics</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.100</td>
      <td>0.249</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.200</td>
      <td>0.238</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.300</td>
      <td>0.210</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.400</td>
      <td>0.221</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.500</td>
      <td>0.211</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.600</td>
      <td>0.223</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.700</td>
      <td>0.231</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.800</td>
      <td>0.226</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.900</td>
      <td>0.226</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>damped_factor slightly affects model quality.</p></li>
<li><p>but the default value gives quality close to the best, so weâ€™ll keep the default value.</p></li>
</ul>
<p>For total number of actions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_dict</span><span class="p">[</span><span class="n">best_model_name_actions</span><span class="p">][</span><span class="s1">&#39;best_params&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;damped_factor&#39;: 0.30000000000000004}]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_dict</span><span class="p">[</span><span class="n">best_model_name_actions</span><span class="p">][</span><span class="s1">&#39;tuned_df&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>damped_factor</th>
      <th>metrics</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.100</td>
      <td>0.249</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.200</td>
      <td>0.238</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.300</td>
      <td>0.210</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.400</td>
      <td>0.221</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.500</td>
      <td>0.211</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.600</td>
      <td>0.223</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.700</td>
      <td>0.231</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.800</td>
      <td>0.226</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.900</td>
      <td>0.226</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Observations:</strong></p>
<ul class="simple">
<li><p>For total number of actions, thereâ€™s a small effect.</p></li>
<li><p>But the default value is almost the best choice, so weâ€™ll keep the default value.</p></li>
</ul>
</section>
</section>
<section id="test-forecast">
<h2>5.8 Test Forecast<a class="headerlink" href="#test-forecast" title="Link to this heading">#</a></h2>
<p>Make a test forecast.</p>
<p>Create a dataframe with future dates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">last_date</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">future_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">last_date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">periods</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">future_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">future_dates</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>Calculate regressors for the future</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">future_df</span><span class="p">[</span><span class="s1">&#39;is_flashmob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">future_df</span><span class="p">[</span><span class="s1">&#39;is_ads_company&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">future_df</span><span class="p">[</span><span class="s1">&#39;is_drop_down&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<p>Make forecast for total DAU.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predicted_df</span> <span class="o">=</span> <span class="n">best_model_dau</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">future_df</span><span class="p">)</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">plot_predicted_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">predicted_df</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Prediction </span><span class="si">{</span><span class="n">best_model_name_dau</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/975474c6b906b7c992c143f7bec30b5e17b4e0a8f0fc4df7bf24433cf6a3801a.png" src="../../_images/975474c6b906b7c992c143f7bec30b5e17b4e0a8f0fc4df7bf24433cf6a3801a.png" />
</div>
</div>
<p>Make forecast for total number of actions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predicted_df</span> <span class="o">=</span> <span class="n">best_model_actions</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">future_df</span><span class="p">)</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">plot_predicted_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">predicted_df</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s1">&#39;actions&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Prediction </span><span class="si">{</span><span class="n">best_model_name_actions</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/c10333b80e76d4de39c83a06ba6663748ac4a697eb68fb492fbed2df868194dd.png" src="../../_images/c10333b80e76d4de39c83a06ba6663748ac4a697eb68fb492fbed2df868194dd.png" />
</div>
</div>
</section>
<section id="conclusion">
<h2>5.9 Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h2>
<section id="id3">
<h3>Total DAU<a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<p><strong>Model Analysis Results</strong></p>
<ul class="simple">
<li><p>Linear trend shows better results than log-linear.</p></li>
<li><p>MAP performs better than MCMC</p>
<ul>
<li><p>most likely due to small data volume</p></li>
<li><p>Markov chains may not have time to converge on small data volume</p></li>
</ul>
</li>
<li><p>Models with mcmc converged, meaning their backtesting metrics are correct.</p></li>
<li><p>Regressors donâ€™t seem to significantly improve quality.</p></li>
<li><p>Regularization doesnâ€™t lead to metric improvement.</p></li>
<li><p>ETS and KTR showed worse results than LGT and DLT</p></li>
<li><p>DLT clearly leads in quality.</p></li>
<li><p>Ultimately, the leader is DLT model without regressors with linear trend and without regularization.</p></li>
<li><p>DLT model with regressors with linear trend and without regularization shows almost the same results as the leader.</p></li>
<li><p>Since regressors donâ€™t improve quality, and their presence may lead to overfitting in the future, weâ€™ll choose the model without regressors.</p></li>
</ul>
<p><strong>Best Model</strong></p>
<ul class="simple">
<li><p>DLT model with map, without regressors, with linear trend and without regularization.</p></li>
</ul>
<p><strong>Best Model Metrics</strong></p>
<ul class="simple">
<li><p>SMAPE metric in rolling backtesting has value 0.039.</p>
<ul>
<li><p>This means the model was wrong by 3.9% on average from actual data.</p></li>
<li><p>Considering the small amount of data, this is a very good result.</p></li>
</ul>
</li>
<li><p>MAE metric in rolling backtesting has value 752.</p>
<ul>
<li><p>This means the model was wrong by 752 users on average from actual data.</p></li>
</ul>
</li>
</ul>
</section>
<section id="id4">
<h3>Total Number of Actions<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<p><strong>Model Analysis Results</strong></p>
<ul class="simple">
<li><p>Linear trend shows better results than log-linear.</p></li>
<li><p>MAP performs better than MCMC</p></li>
<li><p>DLT clearly leads in quality.</p></li>
<li><p>KTR showed the worst results</p></li>
<li><p>Regressors and regularization slightly improve model quality</p></li>
<li><p>Adding total DAU as a regressor doesnâ€™t improve the model.</p></li>
<li><p>The situation is ambiguous</p>
<ul>
<li><p>Models with higher BIC have better quality</p></li>
<li><p>High BIC is logical in this case since models with regressors and regularization are more complex.</p></li>
</ul>
</li>
<li><p>Ultimately, the leader is DLT model with map, regressors (without DAU regressor), linear trend and ridge regularization.</p></li>
<li><p>In second place is DLT model with map, without regressors, with linear trend and without regularization.</p></li>
</ul>
<p><strong>Best Model</strong></p>
<ul class="simple">
<li><p>DLT model with map, without regressors, with linear trend and without regularizatio</p></li>
</ul>
<p><strong>Best Model Metrics</strong></p>
<ul class="simple">
<li><p>SMAPE metric in rolling backtesting has value 0.214.</p>
<ul>
<li><p>This means the model was wrong by 21.4% on average from actual data.</p></li>
<li><p>Considering the small amount of data and metric variability, this is a decent result.</p></li>
</ul>
</li>
<li><p>MAE metric in rolling backtesting has value 204,433.</p>
<ul>
<li><p>This means the model was wrong by 204,433 total actions on average from actual data.</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="recommendations">
<h2>5.10 Recommendations<a class="headerlink" href="#recommendations" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>We donâ€™t have enough data for a full monthly forecast, so currently itâ€™s recommended to make weekly forecasts.</p></li>
<li><p>As data accumulates, model testing should be repeated with longer forecast horizons.</p></li>
<li><p>Since the app has only existed for a few months, making future predictions is difficult as user activity history hasnâ€™t accumulated.</p></li>
<li><p>Moreover, a new product may behave less predictably than a long-existing product.</p></li>
<li><p>Currently, itâ€™s recommended to use 2 metrics (total DAU and total number of actions) for future user activity.</p></li>
<li><p>Although total number of actions is better suited for determining server load, itâ€™s also subject to strong variations that complicate forecasting.</p></li>
<li><p>Total DAU behaves more predictably, leading to better forecasts.</p></li>
</ul>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../4_ab_testing/4_ab_testing.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">4. A/B Testing</p>
      </div>
    </a>
    <a class="right-next"
       href="../6_automated_reporting/6_automated_reporting.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">6. Automated Daily Reports</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-libraries">5.1 Loading Libraries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-description">5.2 Data Description</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#research-design">5.3 Research Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-loading">5.4 Data Loading</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-exploration">5.5 Data Exploration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-definition-and-general-settings">5.6 Model Definition and General Settings</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#general-settings">5.6.1 General Settings</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-types">5.6.2 Model Types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimators">5.6.3 Estimators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-quality-evaluation">5.6.4 Model Quality Evaluation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#regularization">5.6.5 Regularization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-selection-for-backtesting">5.6.6 Parameter Selection for Backtesting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-definition">5.6.7 Model Definition</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-function-for-model-configs">5.6.8 Creating Function for Model Configs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-function-for-model-evaluation">5.6.9 Creating Function for Model Evaluation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-analysis">5.7 Model Analysis</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#total-dau">5.7.1 Total DAU</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#processing-execution">5.7.1.1 Processing Execution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#results-analysis">5.7.1.2 Results Analysis</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#total-number-of-actions">5.7.2 Total Number of Actions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">5.7.2.1 Processing Execution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">5.7.2.2 Results Analysis</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#grid-search">5.7.3 Grid Search</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-forecast">5.8 Test Forecast</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">5.9 Conclusion</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Total DAU</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Total Number of Actions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recommendations">5.10 Recommendations</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Pavel Grigoryev
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2025, Pavel Grigoryev.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>